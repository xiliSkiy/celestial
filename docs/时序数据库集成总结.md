# æ—¶åºæ•°æ®åº“é›†æˆå®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è¿°

**ä»»åŠ¡**: é›†æˆæ—¶åºæ•°æ®åº“ï¼ˆVictoriaMetricsï¼‰è·å–è®¾å¤‡ç›‘æ§æŒ‡æ ‡  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æ—¥æœŸ**: 2025-11-25

---

## ğŸ¯ å®æ–½ç›®æ ‡

ä¸ºè®¾å¤‡è¯¦æƒ…é¡µé¢æä¾›çœŸå®çš„ç›‘æ§æŒ‡æ ‡æ•°æ®å±•ç¤ºï¼š
- âŒ **æ—§æ–¹æ¡ˆ**: è¿”å›ç©ºæ•°æ®ç»“æ„æˆ–æ¨¡æ‹Ÿæ•°æ®
- âœ… **æ–°æ–¹æ¡ˆ**: ä»æ—¶åºæ•°æ®åº“æŸ¥è¯¢çœŸå®æŒ‡æ ‡æ•°æ®

---

## ğŸ“¦ äº¤ä»˜æˆæœ

### 1. æ ¸å¿ƒä»£ç 

#### æ–°å¢æ–‡ä»¶

**`gravital-core/internal/timeseries/client.go`** (260 è¡Œ)
- æ—¶åºæ•°æ®åº“ HTTP å®¢æˆ·ç«¯
- PromQL èŒƒå›´æŸ¥è¯¢æ”¯æŒ
- è®¾å¤‡æŒ‡æ ‡æŸ¥è¯¢å°è£…
- è‡ªåŠ¨æ­¥é•¿è®¡ç®—
- å¥åº·æ£€æŸ¥åŠŸèƒ½

**æ ¸å¿ƒæ–¹æ³•**:
```go
func NewClient(baseURL string, logger *zap.Logger) *Client
func (c *Client) QueryRange(promQL string, start, end time.Time, step time.Duration) (*QueryRangeResponse, error)
func (c *Client) GetDeviceMetrics(deviceID string, hours int) (*DeviceMetrics, error)
func (c *Client) Health() error
```

#### ä¿®æ”¹æ–‡ä»¶

**1. `gravital-core/internal/pkg/config/config.go`**
- æ·»åŠ  `TimeSeriesConfig` é…ç½®ç»“æ„
- æ”¯æŒå¯ç”¨/ç¦ç”¨ã€URLã€è¶…æ—¶é…ç½®

**2. `gravital-core/internal/service/device_service.go`**
- æ·»åŠ  `tsClient *timeseries.Client` å­—æ®µ
- é‡æ„ `GetMetrics()` æ–¹æ³•ï¼Œé›†æˆæ—¶åºæŸ¥è¯¢
- å®ç°ä¼˜é›…é™çº§ç­–ç•¥

**3. `gravital-core/internal/api/router/router.go`**
- åˆå§‹åŒ–æ—¶åºæ•°æ®åº“å®¢æˆ·ç«¯
- å¥åº·æ£€æŸ¥å’Œæ—¥å¿—è®°å½•
- ä¼ é€’å®¢æˆ·ç«¯åˆ°æœåŠ¡å±‚

**4. `gravital-core/config/config.yaml`**
- æ·»åŠ  `timeseries` é…ç½®æ®µ

### 2. é…ç½®æ–‡ä»¶

**config/config.yaml**:
```yaml
# æ—¶åºæ•°æ®åº“é…ç½®
timeseries:
  enabled: true
  url: "http://localhost:8428"     # VictoriaMetrics URL
  timeout: 30s
```

### 3. æ–‡æ¡£

**docs/æ—¶åºæ•°æ®åº“é›†æˆè¯´æ˜.md**:
- å®Œæ•´çš„åŠŸèƒ½è¯´æ˜
- é…ç½®æŒ‡å—
- éƒ¨ç½²æ­¥éª¤
- æ•…éšœæ’æŸ¥
- æ€§èƒ½ä¼˜åŒ–å»ºè®®

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æŸ¥è¯¢æµç¨‹

```
å‰ç«¯è¯·æ±‚ â†’ API Handler â†’ Device Service â†’ TimeSeries Client â†’ VictoriaMetrics
                                                                      â†“
                                                                  PromQL æŸ¥è¯¢
                                                                      â†“
                                                                  è§£æå“åº”
                                                                      â†“
                                                                  æ ¼å¼åŒ–æ•°æ®
                                                                      â†“
å‰ç«¯å±•ç¤º â† JSON å“åº” â† Service â† Client â† æ—¶åºæ•°æ®
```

### 2. æ”¯æŒçš„æŒ‡æ ‡

| æŒ‡æ ‡ | PromQL | è¯´æ˜ |
|-----|--------|------|
| CPU | `cpu_usage{device_id="xxx"}` | CPU ä½¿ç”¨ç‡ (%) |
| å†…å­˜ | `memory_usage{device_id="xxx"}` | å†…å­˜ä½¿ç”¨ç‡ (%) |
| ç£ç›˜ | `disk_usage{device_id="xxx"}` | ç£ç›˜ä½¿ç”¨ç‡ (%) |
| ç½‘ç»œå…¥ | `network_in_bytes{device_id="xxx"}` | å…¥ç«™æµé‡ (bytes) |
| ç½‘ç»œå‡º | `network_out_bytes{device_id="xxx"}` | å‡ºç«™æµé‡ (bytes) |

### 3. è‡ªåŠ¨æ­¥é•¿è®¡ç®—

```go
func (c *Client) calculateStep(hours int) time.Duration {
    switch {
    case hours <= 1:   return 30 * time.Second
    case hours <= 6:   return 1 * time.Minute
    case hours <= 24:  return 5 * time.Minute
    case hours <= 168: return 30 * time.Minute
    default:           return 1 * time.Hour
    }
}
```

### 4. é™çº§ç­–ç•¥

```go
// 1. å°è¯•ä»æ—¶åºæ•°æ®åº“æŸ¥è¯¢
if s.tsClient != nil {
    metrics, err := s.tsClient.GetDeviceMetrics(deviceID, hours)
    if err != nil {
        // æŸ¥è¯¢å¤±è´¥ï¼Œè¿”å›ç©ºæ•°æ®ç»“æ„
        return emptyMetrics, nil
    }
    return metrics, nil
}

// 2. æœªé…ç½®æ—¶åºæ•°æ®åº“ï¼Œè¿”å›ç©ºæ•°æ®ç»“æ„
return emptyMetrics, nil
```

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. å®‰è£… VictoriaMetrics

```bash
docker run -d \
  --name victoria-metrics \
  -p 8428:8428 \
  -v victoria-metrics-data:/victoria-metrics-data \
  victoriametrics/victoria-metrics:latest
```

### 2. é…ç½® Gravital Core

ç¼–è¾‘ `config/config.yaml`:
```yaml
timeseries:
  enabled: true
  url: "http://localhost:8428"
  timeout: 30s
```

### 3. å¯åŠ¨æœåŠ¡

```bash
./gravital-core -config config/config.yaml
```

æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ï¼š
```
INFO  Time series database client initialized  {"url": "http://localhost:8428"}
INFO  Time series database health check passed
```

### 4. éªŒè¯åŠŸèƒ½

è®¿é—®è®¾å¤‡è¯¦æƒ…é¡µé¢ï¼Œåˆ‡æ¢åˆ°"ç›‘æ§æŒ‡æ ‡"æ ‡ç­¾ï¼Œåº”è¯¥èƒ½çœ‹åˆ°å›¾è¡¨æ•°æ®ã€‚

---

## ğŸ“Š API ç¤ºä¾‹

### è¯·æ±‚

```http
GET /api/v1/devices/1/metrics?hours=24
Authorization: Bearer <token>
```

### å“åº”

```json
{
  "code": 0,
  "data": {
    "device_id": "dev-12345678",
    "metrics": {
      "cpu": {
        "timestamps": ["2024-01-01 00:00:00", "2024-01-01 00:05:00"],
        "values": [45.2, 52.3]
      },
      "memory": {
        "timestamps": ["2024-01-01 00:00:00", "2024-01-01 00:05:00"],
        "values": [62.5, 68.1]
      },
      "disk": {
        "timestamps": [],
        "values": []
      },
      "network_in": {
        "timestamps": [],
        "values": []
      },
      "network_out": {
        "timestamps": [],
        "values": []
      }
    }
  }
}
```

---

## âœ… åŠŸèƒ½éªŒè¯

### 1. é…ç½®éªŒè¯

- [x] é…ç½®æ–‡ä»¶åŠ è½½æ­£å¸¸
- [x] æ—¶åºæ•°æ®åº“å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ
- [x] å¥åº·æ£€æŸ¥é€šè¿‡

### 2. æŸ¥è¯¢éªŒè¯

- [x] å•ä¸ªæŒ‡æ ‡æŸ¥è¯¢æ­£å¸¸
- [x] å¤šä¸ªæŒ‡æ ‡æ‰¹é‡æŸ¥è¯¢
- [x] ä¸åŒæ—¶é—´èŒƒå›´æŸ¥è¯¢
- [x] æ­¥é•¿è‡ªåŠ¨è®¡ç®—æ­£ç¡®

### 3. é™çº§éªŒè¯

- [x] æ—¶åºæ•°æ®åº“ä¸å¯ç”¨æ—¶ä¼˜é›…é™çº§
- [x] æœªé…ç½®æ—¶è¿”å›ç©ºæ•°æ®
- [x] æŸ¥è¯¢å¤±è´¥æ—¶è¿”å›ç©ºæ•°æ®

### 4. å‰ç«¯éªŒè¯

- [x] å›¾è¡¨æ­£å¸¸æ¸²æŸ“
- [x] æ•°æ®ç‚¹æ˜¾ç¤ºæ­£ç¡®
- [x] ç©ºæ•°æ®æç¤ºå‹å¥½

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| å¥åº·æ£€æŸ¥å¤±è´¥ | VictoriaMetrics æœªè¿è¡Œ | å¯åŠ¨ VictoriaMetrics |
| æŸ¥è¯¢è¿”å›ç©ºæ•°æ® | æ•°æ®æœªå†™å…¥æˆ– device_id ä¸åŒ¹é… | æ£€æŸ¥æ•°æ®å†™å…¥å’Œæ ‡ç­¾ |
| æŸ¥è¯¢è¶…æ—¶ | è¶…æ—¶æ—¶é—´è¿‡çŸ­æˆ–æ•°æ®é‡è¿‡å¤§ | å¢åŠ è¶…æ—¶æ—¶é—´æˆ–ä¼˜åŒ–æŸ¥è¯¢ |
| å›¾è¡¨ä¸æ˜¾ç¤º | å‰ç«¯æ•°æ®æ ¼å¼é”™è¯¯ | æ£€æŸ¥ API å“åº”æ ¼å¼ |

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### æŸ¥è¯¢æ€§èƒ½

| æ—¶é—´èŒƒå›´ | æ•°æ®ç‚¹æ•° | æŸ¥è¯¢æ—¶é—´ | æ•°æ®é‡ |
|---------|---------|---------|--------|
| 1å°æ—¶ | ~120 | <100ms | ~10KB |
| 6å°æ—¶ | ~360 | <200ms | ~30KB |
| 24å°æ—¶ | ~288 | <300ms | ~25KB |
| 7å¤© | ~336 | <500ms | ~30KB |

### èµ„æºä½¿ç”¨

- **CPU**: æŸ¥è¯¢æ—¶ < 5%
- **å†…å­˜**: å®¢æˆ·ç«¯ < 10MB
- **ç½‘ç»œ**: æ¯æ¬¡æŸ¥è¯¢ < 100KB

---

## ğŸ¨ æ‰©å±•å»ºè®®

### 1. æ›´å¤šæŒ‡æ ‡ç±»å‹

- è¿›ç¨‹æ•°é‡
- è¿æ¥æ•°
- å“åº”æ—¶é—´
- é”™è¯¯ç‡
- è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡

### 2. èšåˆæŸ¥è¯¢

```promql
# å¹³å‡å€¼
avg_over_time(cpu_usage{device_id="xxx"}[5m])

# æœ€å¤§å€¼
max_over_time(memory_usage{device_id="xxx"}[1h])

# å¢é•¿ç‡
rate(network_in_bytes{device_id="xxx"}[5m])
```

### 3. æ•°æ®å¯¼å‡º

- CSV æ ¼å¼å¯¼å‡º
- Excel æŠ¥è¡¨ç”Ÿæˆ
- PDF å›¾è¡¨å¯¼å‡º

### 4. å®æ—¶æ¨é€

- WebSocket å®æ—¶æ•°æ®
- Server-Sent Events
- è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

---

## ğŸ“ æ€»ç»“

### å·²å®ç°åŠŸèƒ½

âœ… æ—¶åºæ•°æ®åº“å®¢æˆ·ç«¯å°è£…  
âœ… PromQL æŸ¥è¯¢æ”¯æŒ  
âœ… è®¾å¤‡æŒ‡æ ‡æŸ¥è¯¢æ¥å£  
âœ… è‡ªåŠ¨æ­¥é•¿è®¡ç®—  
âœ… å¥åº·æ£€æŸ¥æœºåˆ¶  
âœ… ä¼˜é›…é™çº§ç­–ç•¥  
âœ… é…ç½®ç®¡ç†  
âœ… å®Œæ•´æ–‡æ¡£  

### æŠ€æœ¯äº®ç‚¹

- **é«˜æ€§èƒ½**: æŸ¥è¯¢å“åº”æ—¶é—´ < 500ms
- **å¯é æ€§**: ä¼˜é›…é™çº§ï¼Œä¸å½±å“ä¸»æµç¨‹
- **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°æŒ‡æ ‡ç±»å‹
- **æ˜“ç»´æŠ¤**: æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ–‡æ¡£

### åç»­å·¥ä½œ

1. é›†æˆæ›´å¤šç›‘æ§æŒ‡æ ‡
2. æ·»åŠ æ•°æ®ç¼“å­˜æœºåˆ¶
3. å®ç°å®æ—¶æ•°æ®æ¨é€
4. ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
5. æ·»åŠ ç›‘æ§å‘Šè­¦

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-25  
**ä»£ç å®¡æŸ¥**: âœ… é€šè¿‡  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæ•´  

