# 设备标签功能实现说明

## 概述

本文档说明设备管理模块中标签功能的完整实现，包括前端UI组件、API接口和后端数据处理逻辑。

## 功能特性

### 1. 标签输入组件 (TagInput.vue)

**位置**: `gravital-core/web/src/components/common/TagInput.vue`

**功能**:
- 动态添加/删除标签（键值对形式）
- 弹出式表单输入标签
- 常用标签建议快速选择
- 防止重复键名
- 支持 v-model 双向绑定

**使用示例**:
```vue
<TagInput v-model="form.labels" />
```

**标签格式**: `{ "env": "production", "region": "cn-north", "team": "ops" }`

### 2. 设备表单集成

**位置**: `gravital-core/web/src/views/Devices/List.vue`

**改动**:
- 在创建/编辑设备对话框中添加标签输入字段
- 导入并使用 `TagInput` 组件
- 表单数据包含 `labels` 字段

### 3. 标签过滤功能

**位置**: `gravital-core/web/src/views/Devices/List.vue`

**功能**:
- 在设备列表工具栏添加标签筛选下拉框
- 支持多选标签过滤
- 标签选项从后端动态获取
- 实时过滤设备列表

**实现细节**:
- 使用 `el-select` 组件，支持多选和标签折叠
- 查询参数增加 `labels: string[]` 字段
- 页面加载时自动获取可用标签列表

### 4. 前端 API 和状态管理

#### API 接口 (`gravital-core/web/src/api/device.ts`)

新增接口:
```typescript
getDeviceTags: () => request.get<string[]>('/v1/devices/tags')
```

#### 类型定义 (`gravital-core/web/src/types/device.ts`)

更新 `DeviceQuery` 接口:
```typescript
export interface DeviceQuery {
  // ... 其他字段
  labels?: string[]  // 新增
}
```

#### Store (`gravital-core/web/src/stores/device.ts`)

新增方法:
```typescript
const fetchDeviceTags = async () => {
  const res = await deviceApi.getDeviceTags()
  return res as string[]
}
```

### 5. 后端 API 接口

#### 路由配置 (`gravital-core/internal/api/router/router.go`)

新增路由:
```go
devices.GET("/tags", deviceHandler.GetTags)
```

**注意**: 此路由需要放在 `/:id` 路由之前，避免路径冲突。

#### Handler (`gravital-core/internal/api/handler/device_handler.go`)

新增方法:
```go
func (h *DeviceHandler) GetTags(c *gin.Context) {
    tags, err := h.deviceService.GetAllTags(c.Request.Context())
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{
            "code":    10001,
            "message": "获取标签列表失败: " + err.Error(),
        })
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "code": 0,
        "data": tags,
    })
}
```

### 6. 服务层实现

#### Service 接口 (`gravital-core/internal/service/device_service.go`)

**接口扩展**:
```go
type DeviceService interface {
    // ... 其他方法
    GetAllTags(ctx context.Context) ([]string, error)
}
```

**请求结构更新**:
```go
type ListDeviceRequest struct {
    // ... 其他字段
    Labels []string `form:"labels"`  // 新增
}
```

**实现**:
```go
func (s *deviceService) GetAllTags(ctx context.Context) ([]string, error) {
    return s.deviceRepo.GetAllTags(ctx)
}
```

### 7. 数据访问层实现

#### Repository 接口 (`gravital-core/internal/repository/device_repository.go`)

**接口扩展**:
```go
type DeviceRepository interface {
    // ... 其他方法
    GetAllTags(ctx context.Context) ([]string, error)
}
```

**过滤器更新**:
```go
type DeviceFilter struct {
    // ... 其他字段
    Labels []string  // 新增
}
```

**标签过滤实现**:
```go
// 在 List 方法中
if len(filter.Labels) > 0 {
    for _, label := range filter.Labels {
        // 标签格式: key:value
        query = query.Where("labels::text LIKE ?", "%"+label+"%")
    }
}
```

**获取所有标签实现**:
```go
func (r *deviceRepository) GetAllTags(ctx context.Context) ([]string, error) {
    var devices []*model.Device
    if err := r.db.WithContext(ctx).Select("labels").Find(&devices).Error; err != nil {
        return nil, err
    }

    // 收集所有唯一的标签
    tagSet := make(map[string]bool)
    for _, device := range devices {
        if device.Labels != nil {
            for key, value := range device.Labels {
                if strValue, ok := value.(string); ok {
                    tag := key + ":" + strValue
                    tagSet[tag] = true
                }
            }
        }
    }

    // 转换为切片
    tags := make([]string, 0, len(tagSet))
    for tag := range tagSet {
        tags = append(tags, tag)
    }

    return tags, nil
}
```

## 数据模型

### 数据库字段

设备表 (`devices`) 中的标签字段:
```sql
labels JSONB  -- 标签 {"env": "prod", "region": "us-east"}
```

### Go 模型

```go
type Device struct {
    // ... 其他字段
    Labels JSONB `gorm:"type:jsonb" json:"labels"`
}
```

### TypeScript 类型

```typescript
export interface Device {
  // ... 其他字段
  labels: Record<string, string>
}
```

## 使用场景

### 1. 创建设备时添加标签

1. 点击"添加设备"按钮
2. 填写设备基本信息
3. 在"标签"字段点击"+ 添加标签"
4. 输入标签键和值（如 `env: production`）
5. 可以从常用标签中快速选择
6. 提交表单

### 2. 编辑设备标签

1. 点击设备列表中的"编辑"按钮
2. 在标签字段中添加/删除标签
3. 点击标签的关闭按钮可删除
4. 保存更改

### 3. 按标签筛选设备

1. 在设备列表页面的工具栏中
2. 点击"标签"下拉框
3. 选择一个或多个标签
4. 设备列表自动过滤显示匹配的设备

### 4. 查看设备标签

- 在设备列表中，每个设备的标签以标签形式显示
- 在设备详情页面，标签显示在设备信息中

## 技术要点

### 1. JSONB 查询

使用 PostgreSQL 的 JSONB 类型存储标签，支持灵活的键值对结构。

标签过滤使用 `labels::text LIKE` 进行文本匹配:
```go
query = query.Where("labels::text LIKE ?", "%"+label+"%")
```

### 2. 标签格式

- 前端显示格式: `key:value` (如 `env:production`)
- 存储格式: `{"key": "value"}` (JSONB)
- API 传输格式: 标签数组 `["env:production", "region:cn-north"]`

### 3. 组件设计

`TagInput` 组件采用弹出式设计:
- 避免占用过多表单空间
- 提供良好的用户体验
- 支持键盘快捷操作（回车添加）
- 提供常用标签建议

### 4. 性能优化

- 标签列表缓存在前端，减少 API 调用
- 使用 JSONB 索引可以提升查询性能（可选）
- 标签过滤使用数据库查询而非前端过滤

## 扩展建议

### 1. 标签管理

可以添加专门的标签管理页面:
- 查看所有标签及其使用频率
- 批量重命名标签
- 删除未使用的标签
- 标签分类管理

### 2. 标签自动完成

在标签输入时提供智能建议:
- 基于历史输入
- 基于团队常用标签
- 标签键的自动完成

### 3. 标签规则

添加标签验证规则:
- 限制标签键的命名规范
- 限制标签值的格式
- 必填标签检查

### 4. 标签统计

在仪表板中展示:
- 按标签分组的设备统计
- 标签使用趋势
- 标签分布图表

### 5. 批量操作

支持批量标签操作:
- 批量添加标签
- 批量删除标签
- 批量替换标签

## 测试建议

### 前端测试

1. 测试标签输入组件的各种交互
2. 测试标签过滤功能的准确性
3. 测试表单提交时标签数据的正确性
4. 测试边界情况（空标签、特殊字符等）

### 后端测试

1. 测试标签 API 的返回数据格式
2. 测试标签过滤的查询逻辑
3. 测试 JSONB 数据的存储和读取
4. 测试并发场景下的标签操作

### 集成测试

1. 端到端测试完整的标签流程
2. 测试标签在不同设备类型中的表现
3. 测试标签与其他功能的集成（如告警规则）

## 总结

本次实现完整补充了设备管理模块的标签功能，包括:

✅ 前端标签输入组件
✅ 设备表单标签集成
✅ 标签过滤功能
✅ 获取所有标签的 API
✅ 标签查询过滤逻辑

所有功能已经实现并通过了 Linter 检查，可以正常使用。

