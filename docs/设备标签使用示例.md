# 设备标签使用示例

## 前端使用示例

### 1. 在自定义组件中使用 TagInput

```vue
<template>
  <div>
    <h3>设备标签</h3>
    <TagInput 
      v-model="deviceLabels" 
      :suggestions="customSuggestions"
    />
    
    <el-button @click="saveLabels">保存</el-button>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import TagInput from '@/components/common/TagInput.vue'

const deviceLabels = ref<Record<string, string>>({
  env: 'production',
  region: 'cn-north'
})

const customSuggestions = [
  { key: 'env', value: 'production' },
  { key: 'env', value: 'staging' },
  { key: 'team', value: 'ops' },
  { key: 'priority', value: 'high' }
]

const saveLabels = () => {
  console.log('保存的标签:', deviceLabels.value)
  // 调用 API 保存标签
}
</script>
```

### 2. 创建设备并添加标签

```typescript
import { deviceApi } from '@/api/device'

// 创建设备
const createDevice = async () => {
  const deviceData = {
    name: 'Web Server 01',
    device_type: 'server',
    connection_config: {
      host: '192.168.1.100',
      port: 22,
      protocol: 'ssh',
      username: 'admin',
      password: 'password123'
    },
    labels: {
      env: 'production',
      region: 'cn-north',
      team: 'ops',
      app: 'web'
    }
  }
  
  try {
    const result = await deviceApi.createDevice(deviceData)
    console.log('设备创建成功:', result)
  } catch (error) {
    console.error('创建失败:', error)
  }
}
```

### 3. 按标签查询设备

```typescript
import { deviceApi } from '@/api/device'

// 查询生产环境的所有设备
const fetchProductionDevices = async () => {
  const query = {
    page: 1,
    size: 20,
    labels: ['env:production']
  }
  
  const result = await deviceApi.getDevices(query)
  console.log('生产环境设备:', result.items)
}

// 查询特定区域和团队的设备
const fetchFilteredDevices = async () => {
  const query = {
    page: 1,
    size: 20,
    labels: ['region:cn-north', 'team:ops']
  }
  
  const result = await deviceApi.getDevices(query)
  console.log('筛选后的设备:', result.items)
}
```

### 4. 获取所有可用标签

```typescript
import { useDeviceStore } from '@/stores/device'

const deviceStore = useDeviceStore()

// 获取所有标签
const loadTags = async () => {
  try {
    const tags = await deviceStore.fetchDeviceTags()
    console.log('所有标签:', tags)
    // 输出示例: ['env:production', 'env:staging', 'region:cn-north', 'team:ops']
  } catch (error) {
    console.error('获取标签失败:', error)
  }
}
```

### 5. 更新设备标签

```typescript
import { deviceApi } from '@/api/device'

// 更新设备标签
const updateDeviceLabels = async (deviceId: string) => {
  const updateData = {
    labels: {
      env: 'production',
      region: 'cn-south',  // 修改区域
      team: 'dev',         // 修改团队
      priority: 'high'     // 新增优先级标签
    }
  }
  
  try {
    await deviceApi.updateDevice(deviceId, updateData)
    console.log('标签更新成功')
  } catch (error) {
    console.error('更新失败:', error)
  }
}
```

## 后端使用示例

### 1. 创建带标签的设备

```go
package main

import (
    "context"
    "github.com/celestial/gravital-core/internal/service"
)

func createDeviceWithLabels(deviceService service.DeviceService) error {
    req := &service.CreateDeviceRequest{
        Name:       "Database Server 01",
        DeviceType: "database",
        Labels: map[string]interface{}{
            "env":      "production",
            "region":   "cn-east",
            "team":     "data",
            "database": "postgresql",
        },
        ConnectionConfig: map[string]interface{}{
            "host":     "192.168.1.200",
            "port":     5432,
            "protocol": "tcp",
        },
    }
    
    device, err := deviceService.Create(context.Background(), req)
    if err != nil {
        return err
    }
    
    log.Printf("设备创建成功: %s, 标签: %v", device.DeviceID, device.Labels)
    return nil
}
```

### 2. 按标签查询设备

```go
package main

import (
    "context"
    "github.com/celestial/gravital-core/internal/service"
)

func queryDevicesByLabels(deviceService service.DeviceService) error {
    req := &service.ListDeviceRequest{
        Page:     1,
        PageSize: 20,
        Labels:   []string{"env:production", "team:ops"},
    }
    
    devices, total, err := deviceService.List(context.Background(), req)
    if err != nil {
        return err
    }
    
    log.Printf("找到 %d 个设备", total)
    for _, device := range devices {
        log.Printf("设备: %s, 标签: %v", device.Name, device.Labels)
    }
    
    return nil
}
```

### 3. 获取所有标签

```go
package main

import (
    "context"
    "github.com/celestial/gravital-core/internal/service"
)

func getAllTags(deviceService service.DeviceService) error {
    tags, err := deviceService.GetAllTags(context.Background())
    if err != nil {
        return err
    }
    
    log.Printf("所有标签: %v", tags)
    // 输出示例: [env:production env:staging region:cn-north team:ops]
    
    return nil
}
```

### 4. 在 Repository 层直接操作

```go
package main

import (
    "context"
    "github.com/celestial/gravital-core/internal/repository"
)

func filterDevicesByLabels(deviceRepo repository.DeviceRepository) error {
    filter := &repository.DeviceFilter{
        Page:     1,
        PageSize: 50,
        Labels:   []string{"env:production", "region:cn-north"},
    }
    
    devices, total, err := deviceRepo.List(context.Background(), filter)
    if err != nil {
        return err
    }
    
    log.Printf("查询到 %d 个设备", total)
    return nil
}
```

## API 调用示例

### 1. 创建设备（带标签）

```bash
curl -X POST http://localhost:8080/api/v1/devices \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Web Server 01",
    "device_type": "server",
    "connection_config": {
      "host": "192.168.1.100",
      "port": 22,
      "protocol": "ssh",
      "username": "admin",
      "password": "password123"
    },
    "labels": {
      "env": "production",
      "region": "cn-north",
      "team": "ops"
    }
  }'
```

### 2. 查询设备（按标签过滤）

```bash
# 查询生产环境的设备
curl -X GET "http://localhost:8080/api/v1/devices?labels=env:production" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 查询多个标签
curl -X GET "http://localhost:8080/api/v1/devices?labels=env:production&labels=team:ops" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 获取所有标签

```bash
curl -X GET http://localhost:8080/api/v1/devices/tags \
  -H "Authorization: Bearer YOUR_TOKEN"
```

响应示例:
```json
{
  "code": 0,
  "data": [
    "env:production",
    "env:staging",
    "region:cn-north",
    "region:cn-south",
    "team:ops",
    "team:dev"
  ]
}
```

### 4. 更新设备标签

```bash
curl -X PUT http://localhost:8080/api/v1/devices/1 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "labels": {
      "env": "production",
      "region": "cn-south",
      "team": "dev",
      "priority": "high"
    }
  }'
```

## 常见使用场景

### 场景 1: 环境隔离

```typescript
// 查询所有生产环境设备
const productionDevices = await deviceApi.getDevices({
  labels: ['env:production']
})

// 查询所有测试环境设备
const stagingDevices = await deviceApi.getDevices({
  labels: ['env:staging']
})
```

### 场景 2: 区域管理

```typescript
// 查询北方区域的所有设备
const northDevices = await deviceApi.getDevices({
  labels: ['region:cn-north']
})

// 查询南方区域的生产环境设备
const southProdDevices = await deviceApi.getDevices({
  labels: ['region:cn-south', 'env:production']
})
```

### 场景 3: 团队协作

```typescript
// 查询运维团队负责的设备
const opsDevices = await deviceApi.getDevices({
  labels: ['team:ops']
})

// 查询开发团队的测试设备
const devTestDevices = await deviceApi.getDevices({
  labels: ['team:dev', 'env:staging']
})
```

### 场景 4: 优先级管理

```typescript
// 创建高优先级设备
await deviceApi.createDevice({
  name: 'Critical Server',
  device_type: 'server',
  labels: {
    priority: 'high',
    critical: 'true',
    env: 'production'
  },
  // ... 其他配置
})

// 查询所有高优先级设备
const highPriorityDevices = await deviceApi.getDevices({
  labels: ['priority:high']
})
```

### 场景 5: 应用分类

```typescript
// 按应用类型标记设备
const webServerLabels = {
  app: 'web',
  role: 'frontend',
  framework: 'nginx'
}

const dbServerLabels = {
  app: 'database',
  role: 'backend',
  engine: 'postgresql'
}

// 查询所有 Web 服务器
const webServers = await deviceApi.getDevices({
  labels: ['app:web']
})
```

## 最佳实践

### 1. 标签命名规范

```typescript
// ✅ 推荐：使用小写字母和连字符
const goodLabels = {
  'env': 'production',
  'region': 'cn-north',
  'team': 'ops',
  'app-name': 'web-server'
}

// ❌ 不推荐：使用大写字母和特殊字符
const badLabels = {
  'ENV': 'Production',
  'Region_Name': 'CN-NORTH',
  'Team@Name': 'Ops'
}
```

### 2. 标签层次结构

```typescript
// 使用分层标签组织设备
const hierarchicalLabels = {
  'env': 'production',           // 环境层
  'region': 'cn-north',          // 区域层
  'zone': 'zone-a',              // 可用区层
  'team': 'ops',                 // 团队层
  'project': 'ecommerce',        // 项目层
  'app': 'web',                  // 应用层
  'role': 'frontend'             // 角色层
}
```

### 3. 标签数量控制

```typescript
// ✅ 推荐：使用 3-7 个核心标签
const optimalLabels = {
  'env': 'production',
  'region': 'cn-north',
  'team': 'ops',
  'app': 'web'
}

// ❌ 避免：过多的标签会增加管理复杂度
const tooManyLabels = {
  'label1': 'value1',
  'label2': 'value2',
  // ... 20+ 个标签
}
```

### 4. 标签值标准化

```typescript
// 定义标准标签值
const STANDARD_LABELS = {
  env: ['production', 'staging', 'development', 'test'],
  region: ['cn-north', 'cn-south', 'cn-east', 'cn-west'],
  team: ['ops', 'dev', 'data', 'security'],
  priority: ['high', 'medium', 'low']
}

// 验证标签值
const validateLabel = (key: string, value: string): boolean => {
  const validValues = STANDARD_LABELS[key as keyof typeof STANDARD_LABELS]
  return validValues ? validValues.includes(value) : true
}
```

## 故障排查

### 问题 1: 标签过滤不生效

**原因**: 标签格式不正确

**解决方案**:
```typescript
// ❌ 错误：只传递键名
labels: ['env', 'region']

// ✅ 正确：传递完整的键值对
labels: ['env:production', 'region:cn-north']
```

### 问题 2: 标签未保存

**原因**: 表单提交时标签字段为空对象

**解决方案**:
```typescript
// 确保标签对象不为空
const form = {
  name: 'Device Name',
  device_type: 'server',
  labels: Object.keys(deviceLabels).length > 0 ? deviceLabels : undefined
}
```

### 问题 3: 标签查询性能问题

**原因**: JSONB 字段没有索引

**解决方案**:
```sql
-- 为 labels 字段创建 GIN 索引
CREATE INDEX idx_devices_labels ON devices USING GIN (labels);
```

## 总结

设备标签功能提供了灵活的设备分类和管理能力，通过合理使用标签可以：

- 🏷️ 按环境、区域、团队等维度组织设备
- 🔍 快速筛选和查找目标设备
- 📊 生成基于标签的统计报表
- 🔧 实现基于标签的批量操作
- 🎯 支持更精细的权限控制

建议根据实际业务需求制定标签规范，并在团队内统一执行。

