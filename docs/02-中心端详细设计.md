# Gravital Core - 中心端详细设计

## 1. 模块架构

### 1.1 整体分层
```
┌─────────────────────────────────────────────┐
│           Presentation Layer                │
│  (Web UI + RESTful API + WebSocket)         │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│            Application Layer                │
│  ┌──────────┐ ┌──────────┐ ┌─────────────┐ │
│  │ 设备管理  │ │ 告警管理  │ │ 任务调度    │ │
│  └──────────┘ └──────────┘ └─────────────┘ │
│  ┌──────────┐ ┌──────────┐ ┌─────────────┐ │
│  │ 数据转发  │ │ 采集端管理│ │ 用户认证    │ │
│  └──────────┘ └──────────┘ └─────────────┘ │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│            Domain Layer                     │
│  (业务逻辑、规则引擎、数据处理)              │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│        Infrastructure Layer                 │
│  ┌──────────┐ ┌──────────┐ ┌─────────────┐ │
│  │PostgreSQL│ │  Redis   │ │ 时序数据库   │ │
│  └──────────┘ └──────────┘ └─────────────┘ │
└─────────────────────────────────────────────┘
```

## 2. 核心模块详细设计

### 2.1 设备管理模块

#### 2.1.1 功能描述
- 设备的 CRUD 操作
- 设备分组管理（按地理位置、类型、业务等）
- 设备标签管理
- 设备状态监控（在线/离线）
- 设备配置模板
- 批量导入导出

#### 2.1.2 数据模型
```sql
-- 设备表
CREATE TABLE devices (
    id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(64) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    device_type VARCHAR(64) NOT NULL,        -- 设备类型: switch, router, server, etc.
    group_id BIGINT REFERENCES device_groups(id),
    sentinel_id VARCHAR(64),                  -- 负责采集的 Sentinel
    connection_config JSONB,                  -- 连接配置（加密存储）
    labels JSONB,                             -- 标签 {"env": "prod", "region": "us-east"}
    status VARCHAR(32) DEFAULT 'unknown',     -- online, offline, error, unknown
    last_seen TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 设备分组表
CREATE TABLE device_groups (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    parent_id BIGINT REFERENCES device_groups(id),
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 设备模板表
CREATE TABLE device_templates (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    device_type VARCHAR(64) NOT NULL,
    connection_schema JSONB,                  -- 连接字段定义
    default_config JSONB,                     -- 默认配置
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_devices_sentinel ON devices(sentinel_id);
CREATE INDEX idx_devices_type ON devices(device_type);
CREATE INDEX idx_devices_status ON devices(status);
```

#### 2.1.3 API 设计
```yaml
# 设备列表
GET /api/v1/devices
  Query: page, size, group_id, device_type, status, keyword
  Response: {total, items: [Device]}

# 创建设备
POST /api/v1/devices
  Body: {name, device_type, group_id, connection_config, labels}
  Response: {device_id}

# 更新设备
PUT /api/v1/devices/{device_id}
  Body: {name, group_id, connection_config, labels}

# 删除设备
DELETE /api/v1/devices/{device_id}

# 获取设备详情
GET /api/v1/devices/{device_id}
  Response: Device 详细信息 + 最近采集状态

# 批量导入
POST /api/v1/devices/batch-import
  Body: CSV/JSON 文件

# 获取设备分组树
GET /api/v1/device-groups/tree
  Response: 树形结构
```

### 2.2 告警管理模块

#### 2.2.1 功能描述
- 告警规则配置（支持多种条件）
- 告警级别定义（Critical, Warning, Info）
- 告警通知渠道（邮件、Webhook、钉钉、企业微信）
- 告警静默和抑制
- 告警历史记录
- 告警统计和分析

#### 2.2.2 规则引擎设计
支持两种告警模式：

**模式1: 实时告警（中转模式）**
- 数据流经中心端时实时判断
- 低延迟，适合紧急告警

**模式2: 查询告警（直连模式）**
- 定期查询时序数据库
- 支持复杂聚合查询

#### 2.2.3 规则表达式
```yaml
# 示例规则配置
rule:
  name: "CPU 使用率过高"
  enabled: true
  severity: warning
  
  # 条件表达式（支持 PromQL 风格）
  condition: |
    cpu_usage > 80
  
  # 或者使用结构化配置
  condition_struct:
    metric: cpu_usage
    operator: ">"
    threshold: 80
    duration: 5m              # 持续时间
  
  # 告警对象筛选
  filters:
    device_type: server
    labels:
      env: production
  
  # 通知配置
  notifications:
    - channel: email
      to: ["ops@company.com"]
    - channel: webhook
      url: "https://hooks.slack.com/xxx"
  
  # 抑制配置
  inhibit_rules:
    - if_alert: "设备离线"
      suppress: true          # 如果设备离线，不发送 CPU 告警
  
  # 静默时间
  mute_periods:
    - weekday: [6, 7]         # 周末
      time: "00:00-23:59"
```

#### 2.2.4 数据模型
```sql
-- 告警规则表
CREATE TABLE alert_rules (
    id BIGSERIAL PRIMARY KEY,
    rule_name VARCHAR(255) NOT NULL,
    enabled BOOLEAN DEFAULT true,
    severity VARCHAR(32),              -- critical, warning, info
    condition TEXT NOT NULL,           -- 告警条件
    filters JSONB,                     -- 筛选条件
    duration INTEGER,                  -- 持续时间（秒）
    notification_config JSONB,         -- 通知配置
    inhibit_rules JSONB,               -- 抑制规则
    mute_periods JSONB,                -- 静默时间
    description TEXT,
    created_by BIGINT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 告警记录表
CREATE TABLE alert_events (
    id BIGSERIAL PRIMARY KEY,
    alert_id VARCHAR(64) UNIQUE NOT NULL,
    rule_id BIGINT REFERENCES alert_rules(id),
    device_id VARCHAR(64),
    metric_name VARCHAR(255),
    severity VARCHAR(32),
    message TEXT,
    labels JSONB,
    triggered_at TIMESTAMP NOT NULL,
    resolved_at TIMESTAMP,
    status VARCHAR(32),                -- firing, resolved, silenced
    notification_sent BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 告警通知记录
CREATE TABLE alert_notifications (
    id BIGSERIAL PRIMARY KEY,
    alert_event_id BIGINT REFERENCES alert_events(id),
    channel VARCHAR(64),               -- email, webhook, dingtalk, etc.
    recipient VARCHAR(255),
    status VARCHAR(32),                -- pending, sent, failed
    sent_at TIMESTAMP,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_alert_events_status ON alert_events(status);
CREATE INDEX idx_alert_events_device ON alert_events(device_id);
CREATE INDEX idx_alert_events_time ON alert_events(triggered_at DESC);
```

#### 2.2.5 API 设计
```yaml
# 告警规则 CRUD
GET /api/v1/alert-rules
POST /api/v1/alert-rules
PUT /api/v1/alert-rules/{rule_id}
DELETE /api/v1/alert-rules/{rule_id}

# 告警事件查询
GET /api/v1/alert-events
  Query: status, severity, device_id, time_range
  Response: {total, items: [AlertEvent]}

# 手动确认/解决告警
POST /api/v1/alert-events/{alert_id}/resolve

# 告警静默
POST /api/v1/alert-events/{alert_id}/silence
  Body: {duration: "1h"}

# 告警统计
GET /api/v1/alert-stats
  Query: time_range, group_by
  Response: {by_severity, by_device, trend}
```

### 2.3 任务调度模块

#### 2.3.1 功能描述
- 为采集端分配采集任务
- 动态调整采集频率
- 任务优先级管理
- 负载均衡（多个 Sentinel 分配）
- 任务执行状态跟踪

#### 2.3.2 调度策略
```go
// 调度策略接口
type SchedulerStrategy interface {
    // 为设备分配 Sentinel
    AssignSentinel(device *Device) (sentinelID string, err error)
    
    // 计算采集频率
    CalculateInterval(device *Device) time.Duration
}

// 1. 就近原则：按网络区域分配
type ProximityScheduler struct {}

// 2. 负载均衡：按 Sentinel 负载分配
type LoadBalancingScheduler struct {}

// 3. 固定分配：手动指定
type StaticScheduler struct {}
```

#### 2.3.3 数据模型
```sql
-- 采集任务表
CREATE TABLE collection_tasks (
    id BIGSERIAL PRIMARY KEY,
    task_id VARCHAR(64) UNIQUE NOT NULL,
    device_id VARCHAR(64) REFERENCES devices(device_id),
    sentinel_id VARCHAR(64) NOT NULL,
    plugin_name VARCHAR(64) NOT NULL,
    config JSONB,                      -- 插件配置
    interval_seconds INTEGER,          -- 采集间隔
    enabled BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 5,        -- 优先级 1-10
    retry_count INTEGER DEFAULT 3,
    timeout_seconds INTEGER DEFAULT 30,
    last_executed_at TIMESTAMP,
    next_execution_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 任务执行记录
CREATE TABLE task_executions (
    id BIGSERIAL PRIMARY KEY,
    task_id VARCHAR(64) NOT NULL,
    sentinel_id VARCHAR(64),
    status VARCHAR(32),                -- success, failed, timeout
    metrics_collected INTEGER,
    error_message TEXT,
    execution_time_ms INTEGER,
    executed_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_tasks_sentinel ON collection_tasks(sentinel_id);
CREATE INDEX idx_tasks_device ON collection_tasks(device_id);
CREATE INDEX idx_tasks_next_exec ON collection_tasks(next_execution_at);
```

#### 2.3.4 API 设计
```yaml
# 获取任务列表（供 Sentinel 调用）
GET /api/v1/tasks
  Headers: X-Sentinel-ID: sentinel-001
  Response: {tasks: [Task]}

# 上报任务执行结果
POST /api/v1/tasks/{task_id}/report
  Body: {status, metrics_collected, error_message, execution_time_ms}

# 创建任务（内部 API）
POST /api/v1/tasks
  Body: {device_id, plugin_name, config, interval, priority}

# 更新任务配置
PUT /api/v1/tasks/{task_id}
  Body: {config, interval, enabled}

# 任务重新调度（手动触发）
POST /api/v1/tasks/{task_id}/reschedule
```

### 2.4 数据转发模块

#### 2.4.1 功能描述
- 接收采集端上报的数据
- 数据格式转换（统一格式 → 目标格式）
- 数据路由（根据配置转发到不同数据库）
- 数据聚合和预处理
- 失败重试和熔断

#### 2.4.2 转发流程
```
Sentinel 数据上报
    ↓
接收并验证
    ↓
数据转换 (Transform)
    ↓
├─→ Prometheus (Remote Write)
├─→ VictoriaMetrics (Remote Write)
└─→ ClickHouse (Batch Insert)
```

#### 2.4.3 配置模型
```yaml
# 转发配置示例
forwarders:
  - name: "prom-prod"
    type: prometheus
    enabled: true
    endpoint: "http://prometheus:9090/api/v1/write"
    auth:
      type: basic
      username: admin
      password: ${PROM_PASSWORD}
    batch_size: 1000
    flush_interval: 10s
    retry_times: 3
    timeout: 30s
    
  - name: "vm-cluster"
    type: victoria-metrics
    enabled: true
    endpoint: "http://victoria:8428/api/v1/write"
    batch_size: 5000
    flush_interval: 5s
    
  - name: "clickhouse-analytics"
    type: clickhouse
    enabled: true
    dsn: "tcp://clickhouse:9000/metrics"
    table: "metrics.data"
    batch_size: 10000
    flush_interval: 30s
```

#### 2.4.4 数据模型
```sql
-- 转发配置表
CREATE TABLE forwarder_configs (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,
    type VARCHAR(64) NOT NULL,         -- prometheus, victoria-metrics, clickhouse
    enabled BOOLEAN DEFAULT true,
    endpoint TEXT,
    auth_config JSONB,
    batch_size INTEGER,
    flush_interval INTEGER,
    retry_times INTEGER,
    timeout_seconds INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 转发统计表
CREATE TABLE forwarder_stats (
    id BIGSERIAL PRIMARY KEY,
    forwarder_name VARCHAR(255),
    success_count BIGINT,
    failed_count BIGINT,
    total_bytes BIGINT,
    avg_latency_ms INTEGER,
    recorded_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.4.5 API 设计
```yaml
# 接收数据（由 Sentinel 调用）
POST /api/v1/data/ingest
  Headers: X-Sentinel-ID: sentinel-001
  Body: {metrics: [Metric]}
  Response: {received: 1000}

# 转发配置管理
GET /api/v1/forwarders
POST /api/v1/forwarders
PUT /api/v1/forwarders/{name}
DELETE /api/v1/forwarders/{name}

# 转发统计
GET /api/v1/forwarders/{name}/stats
  Query: time_range
  Response: {success_rate, throughput, latency}
```

### 2.5 采集端管理模块

#### 2.5.1 功能描述
- Sentinel 注册和认证
- 心跳监控
- 状态管理（在线/离线/异常）
- 配置推送
- 远程控制（重启、更新配置）
- 版本管理

#### 2.5.2 数据模型
```sql
-- Sentinel 注册表
CREATE TABLE sentinels (
    id BIGSERIAL PRIMARY KEY,
    sentinel_id VARCHAR(64) UNIQUE NOT NULL,
    name VARCHAR(255),
    hostname VARCHAR(255),
    ip_address VARCHAR(64),
    version VARCHAR(32),
    os VARCHAR(64),
    arch VARCHAR(32),
    region VARCHAR(64),                -- 地理区域
    labels JSONB,
    api_token VARCHAR(255),            -- 认证 Token
    status VARCHAR(32),                -- online, offline, error
    last_heartbeat TIMESTAMP,
    registered_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 心跳记录表（可选，用于分析）
CREATE TABLE sentinel_heartbeats (
    id BIGSERIAL PRIMARY KEY,
    sentinel_id VARCHAR(64) NOT NULL,
    cpu_usage FLOAT,
    memory_usage FLOAT,
    disk_usage FLOAT,
    task_count INTEGER,
    plugin_count INTEGER,
    uptime_seconds BIGINT,
    received_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_sentinels_status ON sentinels(status);
CREATE INDEX idx_heartbeats_sentinel ON sentinel_heartbeats(sentinel_id, received_at DESC);
```

#### 2.5.3 API 设计
```yaml
# Sentinel 注册
POST /api/v1/sentinels/register
  Body: {name, hostname, ip, version, os, arch, region}
  Response: {sentinel_id, api_token}

# 心跳上报
POST /api/v1/sentinels/heartbeat
  Headers: X-Sentinel-ID: sentinel-001
  Body: {cpu_usage, memory_usage, disk_usage, task_count, uptime}
  Response: {status: "ok", config_version}

# Sentinel 列表
GET /api/v1/sentinels
  Query: status, region
  Response: {total, items: [Sentinel]}

# Sentinel 详情
GET /api/v1/sentinels/{sentinel_id}
  Response: Sentinel + 关联任务 + 性能指标

# 远程控制
POST /api/v1/sentinels/{sentinel_id}/control
  Body: {action: "reload_config" | "restart" | "stop"}
```

### 2.6 配置管理模块

#### 2.6.1 功能描述
- 全局配置管理
- 配置版本控制
- 配置模板
- 配置验证
- 配置审计

#### 2.6.2 数据模型
```sql
-- 配置表
CREATE TABLE configurations (
    id BIGSERIAL PRIMARY KEY,
    config_key VARCHAR(255) UNIQUE NOT NULL,
    config_value JSONB,
    category VARCHAR(64),              -- system, alert, forwarder, etc.
    description TEXT,
    version INTEGER DEFAULT 1,
    created_by BIGINT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 配置变更历史
CREATE TABLE config_history (
    id BIGSERIAL PRIMARY KEY,
    config_key VARCHAR(255) NOT NULL,
    old_value JSONB,
    new_value JSONB,
    changed_by BIGINT,
    changed_at TIMESTAMP DEFAULT NOW()
);
```

### 2.7 用户认证模块

#### 2.7.1 功能描述
- 用户管理（CRUD）
- 角色权限管理（RBAC）
- JWT Token 认证
- API Token 管理
- 登录日志

#### 2.7.2 数据模型
```sql
-- 用户表
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(64) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE,
    password_hash VARCHAR(255),
    role_id BIGINT REFERENCES roles(id),
    enabled BOOLEAN DEFAULT true,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 角色表
CREATE TABLE roles (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(64) UNIQUE NOT NULL,
    permissions JSONB,                 -- 权限列表
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- API Token 表
CREATE TABLE api_tokens (
    id BIGSERIAL PRIMARY KEY,
    token VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255),
    user_id BIGINT REFERENCES users(id),
    sentinel_id VARCHAR(64),           -- 如果是 Sentinel Token
    permissions JSONB,
    expires_at TIMESTAMP,
    last_used TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.7.3 权限定义
```yaml
# 权限示例
permissions:
  - devices.read          # 查看设备
  - devices.write         # 创建/修改设备
  - devices.delete        # 删除设备
  - alerts.read
  - alerts.write
  - alerts.delete
  - tasks.read
  - tasks.write
  - sentinels.read
  - sentinels.control     # 控制 Sentinel
  - admin.users           # 用户管理
  - admin.config          # 配置管理

# 预定义角色
roles:
  - name: admin
    permissions: ["*"]    # 所有权限
  
  - name: operator
    permissions:
      - devices.*
      - alerts.*
      - tasks.read
      - sentinels.read
  
  - name: viewer
    permissions:
      - "*.read"          # 只读权限
```

## 3. 数据展示模块

### 3.1 Grafana 集成

#### 3.1.1 集成方式
- **嵌入式**: 使用 iframe 嵌入 Grafana Dashboard
- **数据源**: 预配置 Prometheus/VictoriaMetrics/ClickHouse 数据源
- **Dashboard**: 内置常用 Dashboard 模板
- **认证**: 支持 Grafana 匿名访问或 OAuth

#### 3.1.2 预置 Dashboard
```yaml
dashboards:
  - name: "系统总览"
    description: "全局设备状态、告警统计"
    panels:
      - 设备在线率
      - 告警趋势图
      - 采集任务成功率
      - 数据吞吐量
  
  - name: "设备详情"
    description: "单个设备的详细监控"
    variables:
      - device_id
    panels:
      - CPU 使用率
      - 内存使用率
      - 网络流量
      - 磁盘 I/O
  
  - name: "网络设备"
    description: "交换机、路由器专用"
    panels:
      - 端口流量
      - 端口状态
      - CPU/内存
      - 温度
```

### 3.2 自定义 Dashboard

#### 3.2.1 功能描述
- 可视化编辑器（拖拽式）
- 多种图表类型（折线图、柱状图、饼图、仪表盘等）
- 实时数据刷新
- 时间范围选择
- 数据过滤和聚合
- Dashboard 分享和导出

#### 3.2.2 数据模型
```sql
-- 自定义 Dashboard 表
CREATE TABLE custom_dashboards (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    layout JSONB,                      -- 布局配置
    panels JSONB,                      -- 面板配置
    variables JSONB,                   -- 变量定义
    created_by BIGINT,
    is_public BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 3.2.3 Panel 配置示例
```json
{
  "id": "panel-1",
  "type": "line-chart",
  "title": "CPU 使用率",
  "position": {"x": 0, "y": 0, "w": 6, "h": 4},
  "datasource": "prometheus",
  "query": "avg(cpu_usage{device_type='server'})",
  "options": {
    "unit": "percent",
    "decimals": 2,
    "legend": true,
    "tooltip": true,
    "thresholds": [
      {"value": 80, "color": "yellow"},
      {"value": 90, "color": "red"}
    ]
  }
}
```

### 3.3 API 设计
```yaml
# 查询指标数据
GET /api/v1/metrics/query
  Query: query, start, end, step
  Response: {metric, values: [[timestamp, value]]}

# 查询指标列表
GET /api/v1/metrics/list
  Query: device_id, metric_prefix
  Response: {metrics: [string]}

# Dashboard CRUD
GET /api/v1/dashboards
POST /api/v1/dashboards
PUT /api/v1/dashboards/{id}
DELETE /api/v1/dashboards/{id}

# 获取 Dashboard 数据
GET /api/v1/dashboards/{id}/data
  Query: time_range, variables
  Response: {panels: [PanelData]}
```

## 4. 技术实现细节

### 4.1 技术选型（Go 语言示例）

```go
// 推荐框架和库
dependencies:
  - Web 框架: github.com/gin-gonic/gin
  - ORM: gorm.io/gorm
  - Redis: github.com/go-redis/redis/v8
  - JWT: github.com/golang-jwt/jwt/v4
  - 配置: github.com/spf13/viper
  - 日志: go.uber.org/zap
  - 定时任务: github.com/robfig/cron/v3
  - Prometheus 客户端: github.com/prometheus/client_golang
  - ClickHouse: github.com/ClickHouse/clickhouse-go/v2
```

### 4.2 项目结构
```
gravital-core/
├── cmd/
│   └── server/
│       └── main.go
├── internal/
│   ├── api/                      # API 层
│   │   ├── handler/              # HTTP 处理器
│   │   ├── middleware/           # 中间件
│   │   └── router/               # 路由
│   ├── service/                  # 业务逻辑层
│   │   ├── device.go
│   │   ├── alert.go
│   │   ├── task.go
│   │   ├── forwarder.go
│   │   └── sentinel.go
│   ├── repository/               # 数据访问层
│   │   ├── device_repo.go
│   │   ├── alert_repo.go
│   │   └── ...
│   ├── model/                    # 数据模型
│   │   ├── device.go
│   │   ├── alert.go
│   │   └── ...
│   ├── pkg/                      # 公共包
│   │   ├── auth/                 # 认证
│   │   ├── cache/                # 缓存
│   │   ├── config/               # 配置
│   │   ├── logger/               # 日志
│   │   └── validator/            # 验证
│   ├── alert/                    # 告警模块
│   │   ├── engine.go             # 告警引擎
│   │   ├── notifier.go           # 通知器
│   │   └── providers/            # 通知渠道实现
│   ├── forwarder/                # 转发模块
│   │   ├── manager.go
│   │   ├── prometheus.go
│   │   ├── victoria.go
│   │   └── clickhouse.go
│   └── scheduler/                # 任务调度
│       ├── scheduler.go
│       └── strategy.go
├── web/                          # 前端代码
│   ├── src/
│   │   ├── views/
│   │   ├── components/
│   │   ├── api/
│   │   └── store/
│   └── package.json
├── config/
│   ├── config.yaml               # 配置文件
│   └── config.example.yaml
├── migrations/                   # 数据库迁移
│   ├── 001_init.up.sql
│   └── 001_init.down.sql
├── scripts/
│   ├── build.sh
│   └── run.sh
├── Dockerfile
├── docker-compose.yaml
└── README.md
```

### 4.3 核心代码示例

#### 4.3.1 告警引擎
```go
// internal/alert/engine.go
type AlertEngine struct {
    repo      repository.AlertRepository
    notifier  *Notifier
    evaluator *Evaluator
}

func (e *AlertEngine) Start(ctx context.Context) {
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            e.evaluate(ctx)
        case <-ctx.Done():
            return
        }
    }
}

func (e *AlertEngine) evaluate(ctx context.Context) {
    rules, _ := e.repo.GetEnabledRules(ctx)
    
    for _, rule := range rules {
        go func(r *model.AlertRule) {
            // 评估规则
            triggered, value := e.evaluator.Eval(r)
            if triggered {
                e.handleAlert(r, value)
            }
        }(rule)
    }
}
```

#### 4.3.2 数据转发
```go
// internal/forwarder/manager.go
type ForwarderManager struct {
    forwarders map[string]Forwarder
    buffer     chan *model.Metric
}

func (m *ForwarderManager) Forward(metrics []*model.Metric) {
    for _, metric := range metrics {
        m.buffer <- metric
    }
}

func (m *ForwarderManager) Start(ctx context.Context) {
    // 批量处理
    batch := make([]*model.Metric, 0, 1000)
    ticker := time.NewTicker(10 * time.Second)
    
    for {
        select {
        case metric := <-m.buffer:
            batch = append(batch, metric)
            if len(batch) >= 1000 {
                m.flush(batch)
                batch = batch[:0]
            }
        case <-ticker.C:
            if len(batch) > 0 {
                m.flush(batch)
                batch = batch[:0]
            }
        case <-ctx.Done():
            return
        }
    }
}

func (m *ForwarderManager) flush(batch []*model.Metric) {
    for name, forwarder := range m.forwarders {
        go func(n string, f Forwarder) {
            if err := f.Write(batch); err != nil {
                log.Errorf("Forwarder %s failed: %v", n, err)
            }
        }(name, forwarder)
    }
}
```

## 5. 性能优化

### 5.1 数据库优化
- 使用连接池
- 添加必要索引
- 分表分库（大数据量场景）
- 读写分离
- 定期清理历史数据

### 5.2 缓存策略
```yaml
Redis 缓存:
  - 设备配置: TTL 5m
  - Sentinel 信息: TTL 1m
  - 告警规则: TTL 10m
  - 用户会话: TTL 24h
  - 热点数据: LRU 淘汰
```

### 5.3 并发处理
- 使用协程池
- 限流和熔断
- 异步处理非关键路径
- 使用消息队列解耦

## 6. 监控和运维

### 6.1 自监控指标
```yaml
系统指标:
  - gravital_api_requests_total
  - gravital_api_request_duration_seconds
  - gravital_alert_rules_total
  - gravital_alert_events_total
  - gravital_forwarder_success_total
  - gravital_forwarder_failed_total
  - gravital_sentinel_online_count
  - gravital_tasks_total
```

### 6.2 健康检查
```yaml
GET /health
  Response:
    {
      "status": "healthy",
      "version": "1.0.0",
      "uptime": "72h15m30s",
      "components": {
        "database": "healthy",
        "redis": "healthy",
        "forwarders": {
          "prometheus": "healthy",
          "victoria-metrics": "healthy"
        }
      }
    }
```

## 7. 部署建议

### 7.1 配置文件
```yaml
# config.yaml
server:
  host: 0.0.0.0
  port: 8080
  mode: production          # debug, release, production

database:
  host: localhost
  port: 5432
  database: gravital
  username: postgres
  password: ${DB_PASSWORD}
  max_open_conns: 100
  max_idle_conns: 10

redis:
  host: localhost
  port: 6379
  password: ${REDIS_PASSWORD}
  db: 0

auth:
  jwt_secret: ${JWT_SECRET}
  token_expire: 24h

alert:
  evaluation_interval: 10s
  notification_timeout: 30s

forwarder:
  buffer_size: 10000
  batch_size: 1000
  flush_interval: 10s

sentinel:
  heartbeat_timeout: 60s
  offline_threshold: 180s

grafana:
  url: http://localhost:3000
  admin_user: admin
  admin_password: ${GRAFANA_PASSWORD}
```

### 7.2 Docker 部署
```dockerfile
# Dockerfile
FROM golang:1.21 AS builder
WORKDIR /app
COPY . .
RUN go mod download
RUN CGO_ENABLED=0 go build -o gravital-core ./cmd/server

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/gravital-core .
COPY --from=builder /app/config ./config
COPY --from=builder /app/web/dist ./web
EXPOSE 8080
CMD ["./gravital-core"]
```

### 7.3 Docker Compose
```yaml
# docker-compose.yaml
version: '3.8'

services:
  gravital-core:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
      - redis
    volumes:
      - ./config:/root/config
  
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=gravital
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7
    command: redis-server --requirepass ${REDIS_PASSWORD}
  
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  postgres_data:
  grafana_data:
```

