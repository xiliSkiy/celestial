# 告警模块详细设计

## 目录

1. [模块概述](#1-模块概述)
2. [核心功能](#2-核心功能)
3. [数据模型](#3-数据模型)
4. [告警引擎](#4-告警引擎)
5. [数据流详解](#5-数据流详解)
6. [API 接口](#6-api-接口)
7. [前端实现](#7-前端实现)
8. [已知问题与优化](#8-已知问题与优化)

---

## 1. 模块概述

### 1.1 功能定位

告警模块是 Celestial 监控系统的核心组件之一，负责：
- 基于时序数据的实时告警规则评估
- 告警事件的生命周期管理
- 告警聚合与批量操作
- 告警通知（规划中）

### 1.2 架构组件

```
┌─────────────────────────────────────────────────────────────────┐
│                         告警模块架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐ │
│  │  前端 UI     │◄────►│  API Handler │◄────►│  Service     │ │
│  │  (Vue.js)    │      │  (Gin)       │      │  (Business)  │ │
│  └──────────────┘      └──────────────┘      └──────┬───────┘ │
│                                                      │         │
│                        ┌─────────────────────────────┘         │
│                        │                                       │
│  ┌──────────────┐      ▼                  ┌──────────────┐    │
│  │  Alert       │◄────Repository◄─────────┤  Database    │    │
│  │  Engine      │                         │  (PostgreSQL)│    │
│  │  (定时评估)   │                         └──────────────┘    │
│  └──────┬───────┘                                              │
│         │                                                      │
│         ▼                                                      │
│  ┌──────────────┐                                              │
│  │  Metrics     │                                              │
│  │  Query       │                                              │
│  │  (VM/PG)     │                                              │
│  └──────────────┘                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心功能

### 2.1 告警规则管理

#### 功能列表
- ✅ 创建告警规则
- ✅ 更新告警规则
- ✅ 删除告警规则
- ✅ 启用/禁用规则
- ✅ 规则列表查询（支持分页、过滤）

#### 规则配置项
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `rule_name` | string | 规则名称 | "设备离线告警" |
| `enabled` | boolean | 是否启用 | true |
| `severity` | string | 告警级别 | "critical", "warning", "info" |
| `condition` | string | 告警条件（PromQL 风格） | "device_status != 1" |
| `filters` | object | 过滤条件 | `{"device_type": "router"}` |
| `duration` | int | 持续时间（秒） | 300 |
| `notification_config` | object | 通知配置 | `{"channels": ["email"]}` |
| `description` | string | 规则描述 | "监控设备在线状态" |

### 2.2 告警事件管理

#### 事件状态流转

```
┌─────────┐
│ firing  │  告警触发
└────┬────┘
     │
     ├──────────┐
     │          │
     ▼          ▼
┌─────────┐  ┌─────────┐
│acknowledged│  resolved│  手动确认 / 自动解决
└────┬────┘  └─────────┘
     │
     ▼
┌─────────┐
│resolved │  手动解决
└─────────┘
```

#### 事件操作
- ✅ 查看事件列表（支持分页、按状态/严重级别/设备过滤）
- ✅ 查看事件详情
- ✅ 确认事件（Acknowledge）
- ✅ 解决事件（Resolve）
- ✅ 批量确认
- ✅ 批量解决
- ✅ 按规则解决所有事件
- ⏳ 静默事件（Silence）- 已实现接口，待完善

### 2.3 告警聚合

#### 聚合维度
按 **告警规则** 聚合活跃告警（`firing` 和 `acknowledged` 状态），提供：
- 规则基本信息（ID、名称、严重级别、描述）
- 统计数据：
  - 总告警数
  - 告警中数量
  - 已确认数量
- 时间范围：
  - 首次触发时间
  - 最近触发时间
- 受影响设备列表

#### 使用场景
- 告警概览页面：快速了解当前告警态势
- 减少告警噪音：避免显示过多重复告警
- 批量操作入口：一键解决某规则的所有告警

---

## 3. 数据模型

### 3.1 告警规则表 (alert_rules)

```sql
CREATE TABLE alert_rules (
    id                  SERIAL PRIMARY KEY,
    rule_name           VARCHAR(255) NOT NULL,
    enabled             BOOLEAN DEFAULT TRUE,
    severity            VARCHAR(32),                    -- critical, warning, info
    condition           TEXT NOT NULL,                  -- 告警条件，如 "device_status != 1"
    filters             JSONB,                          -- 过滤条件，如 {"device_type": "router"}
    duration            INTEGER,                        -- 持续时间（秒）
    notification_config JSONB,                          -- 通知配置
    inhibit_rules       JSONB,                          -- 抑制规则
    mute_periods        JSONB,                          -- 静默时段
    description         TEXT,                           -- 规则描述
    created_by          INTEGER,                        -- 创建人 ID
    created_at          TIMESTAMP DEFAULT NOW(),
    updated_at          TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_alert_rules_enabled ON alert_rules(enabled);
CREATE INDEX idx_alert_rules_severity ON alert_rules(severity);
```

### 3.2 告警事件表 (alert_events)

```sql
CREATE TABLE alert_events (
    id                  SERIAL PRIMARY KEY,
    alert_id            VARCHAR(64) UNIQUE NOT NULL,    -- 唯一标识，如 "alert-rule1-dev123-1234567890"
    rule_id             INTEGER NOT NULL,               -- 关联的规则 ID
    device_id           VARCHAR(64),                    -- 关联的设备 ID
    metric_name         VARCHAR(255),                   -- 指标名称
    severity            VARCHAR(32),                    -- 告警级别
    message             TEXT,                           -- 告警消息
    labels              JSONB,                          -- 标签
    triggered_at        TIMESTAMP NOT NULL,             -- 触发时间
    resolved_at         TIMESTAMP,                      -- 解决时间
    status              VARCHAR(32),                    -- firing, acknowledged, resolved, silenced
    notification_sent   BOOLEAN DEFAULT FALSE,          -- 是否已发送通知
    acknowledged        BOOLEAN DEFAULT FALSE,          -- 是否已确认
    acknowledged_by     INTEGER,                        -- 确认人 ID
    acknowledged_at     TIMESTAMP,                      -- 确认时间
    comment             TEXT,                           -- 备注
    created_at          TIMESTAMP DEFAULT NOW(),
    
    FOREIGN KEY (rule_id) REFERENCES alert_rules(id) ON DELETE CASCADE
);

CREATE INDEX idx_alert_events_rule_id ON alert_events(rule_id);
CREATE INDEX idx_alert_events_device_id ON alert_events(device_id);
CREATE INDEX idx_alert_events_status ON alert_events(status);
CREATE INDEX idx_alert_events_triggered_at ON alert_events(triggered_at);
CREATE UNIQUE INDEX idx_alert_events_alert_id ON alert_events(alert_id);
```

### 3.3 告警通知记录表 (alert_notifications)

```sql
CREATE TABLE alert_notifications (
    id              SERIAL PRIMARY KEY,
    alert_event_id  INTEGER NOT NULL,
    channel         VARCHAR(64),                        -- email, webhook, sms
    recipient       VARCHAR(255),                       -- 接收人
    status          VARCHAR(32),                        -- pending, sent, failed
    sent_at         TIMESTAMP,
    error_message   TEXT,
    created_at      TIMESTAMP DEFAULT NOW(),
    
    FOREIGN KEY (alert_event_id) REFERENCES alert_events(id) ON DELETE CASCADE
);

CREATE INDEX idx_alert_notifications_event_id ON alert_notifications(alert_event_id);
```

---

## 4. 告警引擎

### 4.1 引擎架构

**文件位置**: `gravital-core/internal/alert/engine/engine.go`

```go
type AlertEngine struct {
    db             *gorm.DB              // 数据库连接
    logger         *zap.Logger           // 日志
    alertRepo      repository.AlertRepository
    vmURL          string                // VictoriaMetrics URL
    checkInterval  time.Duration         // 检查间隔（默认 30 秒）
    ctx            context.Context
    cancel         context.CancelFunc
    wg             sync.WaitGroup
    activeAlerts   map[uint]map[string]*ActiveAlert  // rule_id -> device_id -> alert
    activeAlertsMu sync.RWMutex
}
```

### 4.2 工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      告警引擎评估流程                             │
└─────────────────────────────────────────────────────────────────┘

1. 启动定时器（每 30 秒）
   │
   ▼
2. 查询所有启用的告警规则
   │
   ▼
3. 并发评估每个规则
   │
   ├─► 解析规则条件（metric_name operator threshold）
   │   例如: "device_status != 1"
   │
   ├─► 构建查询（PromQL 风格）
   │   例如: device_status{device_type="router"}
   │
   ├─► 查询指标数据
   │   ├─► 【当前实现】从 PostgreSQL 查询 devices.status
   │   └─► 【规划中】从 VictoriaMetrics 查询时序数据
   │
   ├─► 遍历查询结果
   │   │
   │   ├─► 检查条件是否满足
   │   │   │
   │   │   ├─► 满足 ──► 触发告警
   │   │   │            │
   │   │   │            ├─► 检查是否已有活跃告警
   │   │   │            │   ├─► 有 ──► 更新最后触发时间
   │   │   │            │   └─► 无 ──► 创建新告警事件
   │   │   │            │              │
   │   │   │            │              ├─► 生成 alert_id
   │   │   │            │              ├─► 构造告警消息
   │   │   │            │              ├─► 写入数据库
   │   │   │            │              └─► 记录到 activeAlerts
   │   │   │            │
   │   │   └─► 不满足 ──► 解决告警
   │   │                 │
   │   │                 ├─► 检查是否有活跃告警
   │   │                 │   └─► 有 ──► 更新状态为 resolved
   │   │                 │              ├─► 更新数据库
   │   │                 │              └─► 从 activeAlerts 移除
   │   │                 │
   │   │                 └─► 无 ──► 跳过
   │   │
   │   └─► 下一个设备
   │
   └─► 下一个规则

4. 等待下一次评估周期
```

### 4.3 核心方法

#### 4.3.1 evaluateRule - 评估单个规则

```go
func (e *AlertEngine) evaluateRule(rule *model.AlertRule) {
    // 1. 解析条件：metric_name operator threshold
    parts := strings.Fields(rule.Condition)
    metricName := parts[0]
    operator := parts[1]
    threshold, _ := strconv.ParseFloat(parts[2], 64)
    
    // 2. 构建查询
    query := metricName
    if rule.Filters != nil {
        // 添加过滤条件，如 device_status{device_type="router"}
        query = fmt.Sprintf("%s{%s}", metricName, buildFilters(rule.Filters))
    }
    
    // 3. 查询指标数据
    results, err := e.queryMetric(query)
    
    // 4. 评估每个时间序列
    for _, result := range results {
        deviceID := result.Labels["device_id"]
        
        if e.checkCondition(result.Value, operator, threshold) {
            // 触发告警
            e.triggerAlert(rule, deviceID, metricName, result.Value, threshold, operator)
        } else {
            // 解决告警
            e.resolveAlert(rule, deviceID)
        }
    }
}
```

#### 4.3.2 queryMetric - 查询指标数据

**当前实现**（简化版，查询 PostgreSQL）：

```go
func (e *AlertEngine) queryMetric(query string) ([]MetricResult, error) {
    // 解析查询
    metricName, filters := parseQuery(query)
    
    // 对于 device_status 指标，从数据库查询
    if metricName == "device_status" {
        var devices []model.Device
        dbQuery := e.db.Model(&model.Device{})
        
        // 应用过滤条件
        if deviceID, ok := filters["device_id"]; ok {
            dbQuery = dbQuery.Where("device_id = ?", deviceID)
        }
        if deviceType, ok := filters["device_type"]; ok {
            dbQuery = dbQuery.Where("device_type = ?", deviceType)
        }
        
        dbQuery.Find(&devices)
        
        // 转换为 MetricResult
        results := []MetricResult{}
        for _, device := range devices {
            value := 0.0
            if device.Status == "online" {
                value = 1.0
            }
            results = append(results, MetricResult{
                Labels: map[string]string{
                    "device_id":   device.DeviceID,
                    "device_type": device.DeviceType,
                },
                Value: value,
            })
        }
        return results, nil
    }
    
    return nil, fmt.Errorf("unsupported metric: %s", metricName)
}
```

**规划实现**（查询 VictoriaMetrics）：

```go
func (e *AlertEngine) queryMetric(query string) ([]MetricResult, error) {
    // 构建 VictoriaMetrics API 请求
    url := fmt.Sprintf("%s/api/v1/query?query=%s", e.vmURL, url.QueryEscape(query))
    
    resp, err := http.Get(url)
    // ... 解析响应
    
    // 转换为 MetricResult
    results := []MetricResult{}
    for _, item := range vmResponse.Data.Result {
        results = append(results, MetricResult{
            Labels: item.Metric,
            Value:  parseFloat(item.Value[1]),
        })
    }
    return results, nil
}
```

#### 4.3.3 triggerAlert - 触发告警

```go
func (e *AlertEngine) triggerAlert(rule *model.AlertRule, deviceID, metricName string, 
                                   currentValue, threshold float64, operator string) {
    e.activeAlertsMu.Lock()
    defer e.activeAlertsMu.Unlock()
    
    // 检查是否已有活跃告警
    if deviceAlerts, ok := e.activeAlerts[rule.ID]; ok {
        if alert, exists := deviceAlerts[deviceID]; exists {
            // 已有活跃告警，仅更新时间
            alert.LastFiredAt = time.Now()
            return
        }
    }
    
    // 创建新告警事件
    alertID := fmt.Sprintf("alert-%s-%s-%d", rule.RuleName, deviceID, time.Now().Unix())
    message := fmt.Sprintf("%s: 当前值 %.2f %s 阈值 %.2f", 
                          rule.RuleName, currentValue, operator, threshold)
    
    event := &model.AlertEvent{
        AlertID:     alertID,
        RuleID:      rule.ID,
        DeviceID:    deviceID,
        MetricName:  metricName,
        Severity:    rule.Severity,
        Message:     message,
        TriggeredAt: time.Now(),
        Status:      "firing",
    }
    
    // 写入数据库
    e.alertRepo.CreateEvent(e.ctx, event)
    
    // 记录到活跃告警
    if e.activeAlerts[rule.ID] == nil {
        e.activeAlerts[rule.ID] = make(map[string]*ActiveAlert)
    }
    e.activeAlerts[rule.ID][deviceID] = &ActiveAlert{
        RuleID:       rule.ID,
        DeviceID:     deviceID,
        EventID:      event.ID,
        FirstFiredAt: time.Now(),
        LastFiredAt:  time.Now(),
    }
    
    e.logger.Info("Alert triggered", 
                  zap.String("rule", rule.RuleName),
                  zap.String("device_id", deviceID))
}
```

#### 4.3.4 resolveAlert - 解决告警

```go
func (e *AlertEngine) resolveAlert(rule *model.AlertRule, deviceID string) {
    e.activeAlertsMu.Lock()
    defer e.activeAlertsMu.Unlock()
    
    // 检查是否有活跃告警
    deviceAlerts, ok := e.activeAlerts[rule.ID]
    if !ok {
        return
    }
    
    alert, exists := deviceAlerts[deviceID]
    if !exists {
        return
    }
    
    // 更新数据库：状态改为 resolved
    now := time.Now()
    e.db.Model(&model.AlertEvent{}).
        Where("id = ?", alert.EventID).
        Updates(map[string]interface{}{
            "status":      "resolved",
            "resolved_at": now,
        })
    
    // 从活跃告警中移除
    delete(deviceAlerts, deviceID)
    if len(deviceAlerts) == 0 {
        delete(e.activeAlerts, rule.ID)
    }
    
    e.logger.Info("Alert resolved",
                  zap.String("rule", rule.RuleName),
                  zap.String("device_id", deviceID))
}
```

### 4.4 引擎启动

**文件位置**: `gravital-core/cmd/server/main.go`

```go
// 启动告警引擎
logger.Info("Starting alert engine...")

// 查找 VictoriaMetrics 端点
vmURL := ""
for _, target := range cfg.Forwarder.Targets {
    if target.Type == "victoriametrics" && target.Enabled {
        vmURL = target.Endpoint
        break
    }
}

// 创建并启动引擎
alertEngine := engine.NewAlertEngine(db, logger.Get(), &engine.Config{
    VMURL:         vmURL,
    CheckInterval: 30 * time.Second,  // 每 30 秒评估一次
})
alertEngine.Start()
logger.Info("Alert engine started")

// 优雅关闭
go func() {
    <-ctx.Done()
    alertEngine.Stop()
}()
```

---

## 5. 数据流详解

### 5.1 告警规则创建流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 前端 UI │─────►│ Handler │─────►│ Service │─────►│Database │
└─────────┘      └─────────┘      └─────────┘      └─────────┘
    │                 │                 │                 │
    │ POST /v1/       │                 │                 │
    │ alert-rules     │                 │                 │
    │ {               │                 │                 │
    │   rule_name,    │                 │                 │
    │   condition,    │                 │                 │
    │   ...           │                 │                 │
    │ }               │                 │                 │
    ├────────────────►│                 │                 │
    │                 │ CreateRule()    │                 │
    │                 ├────────────────►│                 │
    │                 │                 │ INSERT INTO     │
    │                 │                 │ alert_rules     │
    │                 │                 ├────────────────►│
    │                 │                 │                 │
    │                 │                 │◄────────────────┤
    │                 │                 │ rule.ID         │
    │                 │◄────────────────┤                 │
    │                 │ rule            │                 │
    │◄────────────────┤                 │                 │
    │ {code: 0,       │                 │                 │
    │  data: {id}}    │                 │                 │
    │                 │                 │                 │
```

**请求示例**：

```bash
POST /api/v1/alert-rules
Content-Type: application/json

{
  "rule_name": "设备离线告警",
  "description": "监控设备在线状态",
  "severity": "critical",
  "condition": "device_status != 1",
  "duration": 300,
  "filters": {
    "device_type": "router"
  },
  "enabled": true
}
```

**响应示例**：

```json
{
  "code": 0,
  "data": {
    "id": 1
  }
}
```

### 5.2 告警评估与触发流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ Alert Engine │     │   Metrics    │     │   Database   │
│  (定时器)     │     │   Source     │     │  (PG/VM)     │
└──────────────┘     └──────────────┘     └──────────────┘
       │                     │                     │
       │ 每 30 秒            │                     │
       ├─────────────────────┼─────────────────────┤
       │                     │                     │
       │ 1. 查询启用的规则   │                     │
       ├────────────────────────────────────────►│
       │                     │                     │
       │◄────────────────────────────────────────┤
       │ rules[]             │                     │
       │                     │                     │
       │ 2. 并发评估每个规则 │                     │
       │                     │                     │
       │ 3. 查询指标数据     │                     │
       ├────────────────────►│                     │
       │ queryMetric(        │                     │
       │   "device_status{   │                     │
       │    device_type=     │                     │
       │    'router'}"       │                     │
       │ )                   │                     │
       │                     │ SELECT * FROM       │
       │                     │ devices WHERE ...   │
       │                     ├────────────────────►│
       │                     │                     │
       │                     │◄────────────────────┤
       │                     │ devices[]           │
       │◄────────────────────┤                     │
       │ MetricResult[]      │                     │
       │                     │                     │
       │ 4. 检查条件         │                     │
       │ for each device:    │                     │
       │   if value != 1:    │                     │
       │     triggerAlert()  │                     │
       │                     │                     │
       │ 5. 创建告警事件     │                     │
       ├────────────────────────────────────────►│
       │ INSERT INTO         │                     │
       │ alert_events        │                     │
       │                     │                     │
       │◄────────────────────────────────────────┤
       │ event.ID            │                     │
       │                     │                     │
       │ 6. 记录活跃告警     │                     │
       │ activeAlerts[       │                     │
       │   rule_id][         │                     │
       │   device_id]        │                     │
       │ = alert             │                     │
       │                     │                     │
```

### 5.3 告警事件确认流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 前端 UI │      │ Handler │      │ Service │      │Database │
└─────────┘      └─────────┘      └─────────┘      └─────────┘
    │                 │                 │                 │
    │ POST /v1/       │                 │                 │
    │ alert-events/   │                 │                 │
    │ {id}/           │                 │                 │
    │ acknowledge     │                 │                 │
    │ {comment: ""}   │                 │                 │
    ├────────────────►│                 │                 │
    │                 │ Acknowledge()   │                 │
    │                 ├────────────────►│                 │
    │                 │                 │ GetEventByID()  │
    │                 │                 ├────────────────►│
    │                 │                 │                 │
    │                 │                 │◄────────────────┤
    │                 │                 │ event           │
    │                 │                 │                 │
    │                 │                 │ UPDATE          │
    │                 │                 │ alert_events    │
    │                 │                 │ SET             │
    │                 │                 │   acknowledged  │
    │                 │                 │   = true,       │
    │                 │                 │   acknowledged_ │
    │                 │                 │   by = user_id, │
    │                 │                 │   acknowledged_ │
    │                 │                 │   at = now()    │
    │                 │                 ├────────────────►│
    │                 │                 │                 │
    │                 │                 │◄────────────────┤
    │                 │◄────────────────┤                 │
    │◄────────────────┤                 │                 │
    │ {code: 0}       │                 │                 │
    │                 │                 │                 │
```

### 5.4 告警聚合查询流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 前端 UI │      │ Handler │      │ Service │      │Database │
└─────────┘      └─────────┘      └─────────┘      └─────────┘
    │                 │                 │                 │
    │ GET /v1/        │                 │                 │
    │ alert-          │                 │                 │
    │ aggregations    │                 │                 │
    ├────────────────►│                 │                 │
    │                 │ GetAggregations │                 │
    │                 ├────────────────►│                 │
    │                 │                 │ SELECT * FROM   │
    │                 │                 │ alert_events    │
    │                 │                 │ WHERE status IN │
    │                 │                 │ ('firing',      │
    │                 │                 │  'acknowledged')│
    │                 │                 │ PRELOAD Rule    │
    │                 │                 ├────────────────►│
    │                 │                 │                 │
    │                 │                 │◄────────────────┤
    │                 │                 │ events[]        │
    │                 │                 │                 │
    │                 │                 │ 按 rule_id 聚合 │
    │                 │                 │ 计算统计数据    │
    │                 │                 │                 │
    │                 │◄────────────────┤                 │
    │                 │ aggregations[]  │                 │
    │◄────────────────┤                 │                 │
    │ {code: 0,       │                 │                 │
    │  data: [        │                 │                 │
    │    {rule_id,    │                 │                 │
    │     rule_name,  │                 │                 │
    │     total_count,│                 │                 │
    │     firing_count│                 │                 │
    │     ...}        │                 │                 │
    │  ]}             │                 │                 │
    │                 │                 │                 │
```

**响应示例**：

```json
{
  "code": 0,
  "data": [
    {
      "rule_id": 1,
      "rule_name": "设备离线告警",
      "severity": "critical",
      "description": "监控设备在线状态",
      "total_count": 5,
      "firing_count": 3,
      "acked_count": 2,
      "first_fired": "2025-11-23 10:00:00",
      "last_fired": "2025-11-23 10:30:00",
      "devices": [
        {
          "device_id": "dev-001",
          "device_name": "dev-001",
          "status": "firing",
          "triggered_at": "2025-11-23 10:00:00"
        },
        {
          "device_id": "dev-002",
          "device_name": "dev-002",
          "status": "acknowledged",
          "triggered_at": "2025-11-23 10:15:00"
        }
      ]
    }
  ]
}
```

### 5.5 批量解决告警流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 前端 UI │      │ Handler │      │ Service │      │Database │
└─────────┘      └─────────┘      └─────────┘      └─────────┘
    │                 │                 │                 │
    │ POST /v1/       │                 │                 │
    │ alert-events/   │                 │                 │
    │ batch-resolve   │                 │                 │
    │ {               │                 │                 │
    │   ids: [1,2,3], │                 │                 │
    │   comment: ""   │                 │                 │
    │ }               │                 │                 │
    ├────────────────►│                 │                 │
    │                 │ BatchResolve()  │                 │
    │                 ├────────────────►│                 │
    │                 │                 │ UPDATE          │
    │                 │                 │ alert_events    │
    │                 │                 │ SET status =    │
    │                 │                 │   'resolved',   │
    │                 │                 │   resolved_at = │
    │                 │                 │   now()         │
    │                 │                 │ WHERE id IN     │
    │                 │                 │   (1, 2, 3)     │
    │                 │                 ├────────────────►│
    │                 │                 │                 │
    │                 │                 │◄────────────────┤
    │                 │◄────────────────┤                 │
    │◄────────────────┤                 │                 │
    │ {code: 0}       │                 │                 │
    │                 │                 │                 │
```

---

## 6. API 接口

### 6.1 告警规则接口

#### 6.1.1 获取规则列表

**请求**：
```
GET /api/v1/alert-rules?page=1&page_size=20&enabled=true&severity=critical&keyword=设备
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "total": 10,
    "page": 1,
    "page_size": 20,
    "items": [
      {
        "id": 1,
        "rule_name": "设备离线告警",
        "enabled": true,
        "severity": "critical",
        "condition": "device_status != 1",
        "filters": {"device_type": "router"},
        "duration": 300,
        "description": "监控设备在线状态",
        "created_at": "2025-11-23T10:00:00Z",
        "updated_at": "2025-11-23T10:00:00Z"
      }
    ]
  }
}
```

#### 6.1.2 创建规则

**请求**：
```
POST /api/v1/alert-rules
Content-Type: application/json

{
  "rule_name": "设备离线告警",
  "description": "监控设备在线状态",
  "severity": "critical",
  "condition": "device_status != 1",
  "duration": 300,
  "filters": {"device_type": "router"},
  "enabled": true
}
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "id": 1
  }
}
```

#### 6.1.3 更新规则

**请求**：
```
PUT /api/v1/alert-rules/1
Content-Type: application/json

{
  "rule_name": "设备离线告警（更新）",
  "enabled": false
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success"
}
```

#### 6.1.4 删除规则

**请求**：
```
DELETE /api/v1/alert-rules/1
```

**响应**：
```json
{
  "code": 0,
  "message": "success"
}
```

#### 6.1.5 启用/禁用规则

**请求**：
```
POST /api/v1/alert-rules/1/toggle
Content-Type: application/json

{
  "enabled": false
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success"
}
```

#### 6.1.6 解决规则的所有告警

**请求**：
```
POST /api/v1/alert-rules/1/resolve-all
Content-Type: application/json

{
  "comment": "批量解决"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success"
}
```

### 6.2 告警事件接口

#### 6.2.1 获取事件列表

**请求**：
```
GET /api/v1/alert-events?page=1&page_size=20&status=firing&severity=critical&device_id=dev-001&rule_id=1
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "total": 5,
    "page": 1,
    "page_size": 20,
    "items": [
      {
        "id": 1,
        "alert_id": "alert-rule1-dev001-1732348800",
        "rule_id": 1,
        "device_id": "dev-001",
        "metric_name": "device_status",
        "severity": "critical",
        "message": "设备离线告警: 当前值 0.00 != 阈值 1.00",
        "triggered_at": "2025-11-23T10:00:00Z",
        "status": "firing",
        "acknowledged": false
      }
    ]
  }
}
```

#### 6.2.2 确认事件

**请求**：
```
POST /api/v1/alert-events/1/acknowledge
Content-Type: application/json

{
  "comment": "已知晓，正在处理"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success"
}
```

#### 6.2.3 解决事件

**请求**：
```
POST /api/v1/alert-events/1/resolve
Content-Type: application/json

{
  "comment": "问题已解决"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success"
}
```

#### 6.2.4 批量确认

**请求**：
```
POST /api/v1/alert-events/batch-acknowledge
Content-Type: application/json

{
  "ids": [1, 2, 3],
  "comment": "批量确认"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success"
}
```

#### 6.2.5 批量解决

**请求**：
```
POST /api/v1/alert-events/batch-resolve
Content-Type: application/json

{
  "ids": [1, 2, 3],
  "comment": "批量解决"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "success"
}
```

### 6.3 告警聚合接口

#### 6.3.1 获取聚合信息

**请求**：
```
GET /api/v1/alert-aggregations
```

**响应**：
```json
{
  "code": 0,
  "data": [
    {
      "rule_id": 1,
      "rule_name": "设备离线告警",
      "severity": "critical",
      "description": "监控设备在线状态",
      "total_count": 5,
      "firing_count": 3,
      "acked_count": 2,
      "first_fired": "2025-11-23 10:00:00",
      "last_fired": "2025-11-23 10:30:00",
      "devices": [
        {
          "device_id": "dev-001",
          "device_name": "dev-001",
          "status": "firing",
          "triggered_at": "2025-11-23 10:00:00"
        }
      ]
    }
  ]
}
```

---

## 7. 前端实现

### 7.1 页面结构

**文件位置**: `gravital-core/web/src/views/Alerts/Index.vue`

```
┌─────────────────────────────────────────────────────────────────┐
│                         告警管理页面                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Tab 1: 告警概览                                          │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │  聚合卡片 1                                         │  │  │
│  │  │  ┌──────────────────────────────────────────────┐  │  │  │
│  │  │  │ [Critical] 设备离线告警           [Badge: 3] │  │  │  │
│  │  │  │ 描述: 监控设备在线状态                        │  │  │  │
│  │  │  │ ┌─────┬─────┬─────┐                           │  │  │  │
│  │  │  │ │总计 │告警中│已确认│                           │  │  │  │
│  │  │  │ │  5  │  3  │  2  │                           │  │  │  │
│  │  │  │ └─────┴─────┴─────┘                           │  │  │  │
│  │  │  │ 首次: 2025-11-23 10:00  最近: 10:30           │  │  │  │
│  │  │  │ [查看详情] [全部解决]                          │  │  │  │
│  │  │  │ ▼ 受影响设备 (5)                              │  │  │  │
│  │  │  │   ┌────────────────────────────────────┐      │  │  │  │
│  │  │  │   │ 设备ID | 状态 | 触发时间           │      │  │  │  │
│  │  │  │   │ dev-001 | firing | 10:00          │      │  │  │  │
│  │  │  │   └────────────────────────────────────┘      │  │  │  │
│  │  │  └──────────────────────────────────────────────┘  │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Tab 2: 告警规则                                          │  │
│  │  [创建规则] [搜索框]                                       │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ 规则名称 | 严重级别 | 条件 | 状态 | 操作             │  │  │
│  │  │ 设备离线 | Critical | ... | 启用 | [编辑][删除]     │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Tab 3: 告警事件                                          │  │
│  │  [批量确认] [批量解决] [过滤器]                            │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ □ | 规则 | 设备 | 级别 | 消息 | 状态 | 操作          │  │  │
│  │  │ □ | ... | ... | ... | ... | firing | [确认][解决] │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 核心功能实现

#### 7.2.1 告警概览（自动刷新）

```typescript
// 自动刷新
const startAutoRefresh = () => {
  if (autoRefreshTimer.value) {
    clearInterval(autoRefreshTimer.value)
  }
  
  autoRefreshTimer.value = setInterval(() => {
    if (activeTab.value === 'overview') {
      loadAggregations()
    }
  }, 30000) // 每 30 秒刷新
}

// 加载聚合数据
const loadAggregations = async () => {
  loading.value = true
  try {
    const res = await alertApi.getAggregations()
    aggregations.value = res.data
  } finally {
    loading.value = false
  }
}
```

#### 7.2.2 批量操作

```typescript
// 批量确认
const handleBatchAcknowledge = async () => {
  if (selectedEvents.value.length === 0) {
    ElMessage.warning('请选择要确认的告警')
    return
  }
  
  try {
    await alertApi.batchAcknowledge(selectedEvents.value)
    ElMessage.success('批量确认成功')
    loadEvents()
    selectedEvents.value = []
  } catch (error) {
    ElMessage.error('批量确认失败')
  }
}

// 批量解决
const handleBatchResolve = async () => {
  if (selectedEvents.value.length === 0) {
    ElMessage.warning('请选择要解决的告警')
    return
  }
  
  try {
    await alertApi.batchResolve(selectedEvents.value)
    ElMessage.success('批量解决成功')
    loadEvents()
    selectedEvents.value = []
  } catch (error) {
    ElMessage.error('批量解决失败')
  }
}
```

#### 7.2.3 规则创建表单

```typescript
// 表单数据
const ruleForm = reactive({
  rule_name: '',
  description: '',
  severity: 'warning',
  metric_name: 'device_status',
  operator: '!=',
  threshold: 1,
  duration: 5, // 分钟
  filters: {},
  enabled: true
})

// 提交规则
const handleSubmitRule = async () => {
  // 转换为后端格式
  const data: AlertRuleCreate = {
    rule_name: ruleForm.rule_name,
    description: ruleForm.description,
    severity: ruleForm.severity,
    condition: `${ruleForm.metric_name} ${ruleForm.operator} ${ruleForm.threshold}`,
    duration: ruleForm.duration * 60, // 转换为秒
    filters: ruleForm.filters,
    enabled: ruleForm.enabled
  }
  
  try {
    if (editingRuleId.value) {
      await alertApi.updateRule(editingRuleId.value, data)
      ElMessage.success('更新成功')
    } else {
      await alertApi.createRule(data)
      ElMessage.success('创建成功')
    }
    ruleDialogVisible.value = false
    loadRules()
  } catch (error) {
    ElMessage.error('操作失败')
  }
}
```

### 7.3 类型定义

**文件位置**: `gravital-core/web/src/types/alert.ts`

```typescript
// 告警规则
export interface AlertRule {
  id: string
  rule_name: string
  enabled: boolean
  severity: 'critical' | 'warning' | 'info'
  condition: string
  filters?: Record<string, any>
  duration: number
  notification_config?: Record<string, any>
  description?: string
  created_at: string
  updated_at: string
}

// 创建规则请求
export interface AlertRuleCreate {
  rule_name: string
  description?: string
  severity: 'critical' | 'warning' | 'info'
  condition: string
  duration: number
  filters?: Record<string, any>
  notification_config?: Record<string, any>
  enabled?: boolean
}

// 告警事件
export interface AlertEvent {
  id: string
  alert_id: string
  rule_id: string
  device_id: string
  metric_name: string
  severity: 'critical' | 'warning' | 'info'
  message: string
  triggered_at: string
  resolved_at?: string
  status: 'firing' | 'acknowledged' | 'resolved' | 'silenced'
  acknowledged: boolean
  acknowledged_by?: number
  acknowledged_at?: string
  comment?: string
}

// 告警聚合
export interface AlertAggregation {
  rule_id: number
  rule_name: string
  severity: 'critical' | 'warning' | 'info'
  description: string
  total_count: number
  firing_count: number
  acked_count: number
  first_fired: string
  last_fired: string
  devices: {
    device_id: string
    device_name: string
    status: string
    triggered_at: string
  }[]
}
```

---

## 8. 已知问题与优化

### 8.1 数据源不一致问题 ✅ 已解决

#### 问题描述

**旧实现**：告警引擎查询 PostgreSQL 的 `devices.status` 字段
**新实现**：告警引擎查询 VictoriaMetrics 的时序数据（带自动回退机制）

#### 影响

- **误报**：设备实际在线（时序数据显示 `device_status = 1`），但 PostgreSQL 中 `status = offline`，导致触发告警
- **漏报**：设备实际离线（时序数据无数据），但 PostgreSQL 中 `status = online`，导致不触发告警
- **延迟**：PostgreSQL 状态更新依赖 DeviceMonitor（每分钟检查一次），存在延迟

#### 根本原因

1. **数据来源不同**：
   - 时序数据库：Sentinel 实时采集并上报（每 30 秒）
   - PostgreSQL：DeviceMonitor 定时检查 `last_seen` 字段（每 1 分钟）

2. **更新机制不同**：
   - 时序数据库：直接反映采集结果
   - PostgreSQL：依赖心跳或定时检查

#### 解决方案

**方案 1：修改告警引擎查询 VictoriaMetrics（推荐）** ✅

```go
// gravital-core/internal/alert/engine/vm_client.go
type VMClient struct {
    baseURL string
    client  *http.Client
}

func (c *VMClient) Query(promQL string) ([]MetricResult, error) {
    url := fmt.Sprintf("%s/api/v1/query?query=%s", c.baseURL, url.QueryEscape(promQL))
    
    resp, err := c.client.Get(url)
    // ... 解析 VictoriaMetrics 响应
    
    return results, nil
}

// 修改 engine.go
func (e *AlertEngine) queryMetric(query string) ([]MetricResult, error) {
    return e.vmClient.Query(query)
}
```

**优点**：
- ✅ 使用实时数据，准确反映设备当前状态
- ✅ 支持所有时序指标，不仅限于 `device_status`
- ✅ 符合告警引擎的设计初衷

**方案 2：同步 PostgreSQL 状态（不推荐）**

让 Sentinel 在上报时序数据的同时，也发送心跳更新 PostgreSQL。

**缺点**：
- ❌ 增加系统复杂度
- ❌ 仍然存在延迟
- ❌ 无法支持其他时序指标

#### 实施状态

- [x] 实现 VictoriaMetrics 查询客户端 ✅
- [x] 修改告警引擎使用 VM 客户端 ✅
- [x] 添加自动回退机制 ✅
- [x] 健康检查和日志记录 ✅
- [x] 测试脚本和文档 ✅

**详细说明**: 请参阅 [告警引擎 VictoriaMetrics 集成说明](../gravital-core/docs/ALERT_VM_INTEGRATION.md)

#### 临时解决方案

1. **调整 DeviceMonitor 超时时间**：
   ```go
   deviceMonitor := service.NewDeviceMonitor(db, logger.Get(), &service.DeviceMonitorConfig{
       CheckInterval:  1 * time.Minute,
       OfflineTimeout: 10 * time.Minute,  // 从 5 分钟改为 10 分钟
   })
   ```

2. **让 Sentinel 发送心跳**：
   ```go
   // orbital-sentinels/internal/scheduler/scheduler.go
   func (s *Scheduler) executeTask(task *model.CollectionTask) {
       // ... 采集数据 ...
       s.forwarder.Forward(metrics)
       
       // 发送心跳（临时方案）
       s.sendHeartbeat(task.DeviceID)
   }
   ```

### 8.2 告警自动解决问题 ✅ 已解决

#### 问题描述

用户报告：设备一直在线，但告警持续触发并立即自动解决。

#### 根本原因

告警引擎在每次评估时，如果条件不满足，会自动调用 `resolveAlert()`：

```go
// engine.go:207-212
if e.checkCondition(result.Value, operator, threshold) {
    e.triggerAlert(...)
} else {
    e.resolveAlert(...)  // 条件不满足时自动解决
}
```

结合数据源不一致问题：
1. 设备实际在线（时序数据 `device_status = 1`）
2. 但 PostgreSQL 显示 `status = offline`（`value = 0`）
3. 告警条件 `device_status != 1`，即 `0 != 1`，触发告警 ✅
4. 下一次评估时，如果 PostgreSQL 状态变为 `online`（`value = 1`）
5. 条件 `1 != 1` 不满足，自动解决告警 ❌

#### 解决方案

通过修改告警引擎查询 VictoriaMetrics（见 8.1），使用实时准确的时序数据，避免数据不一致导致的误报和自动解决问题。

**实施状态**: ✅ 已完成

### 8.3 告警概览无数据 ℹ️

#### 问题描述

用户报告：有告警数据，但告警概览为空。

#### 原因

告警概览只显示 **活跃告警**（`firing` 或 `acknowledged` 状态）：

```go
// alert_aggregation.go:35-38
err := db.WithContext(ctx).
    Preload("Rule").
    Where("status IN ?", []string{"firing", "acknowledged"}).
    Find(&events).Error
```

如果所有告警都已 `resolved`，概览将为空。

#### 解决方案

这是预期行为。如需查看历史告警，请切换到"告警事件"标签页。

### 8.4 性能优化建议 📈

#### 8.4.1 告警引擎

**当前问题**：
- 每 30 秒评估所有规则
- 规则数量增多时，评估耗时增加

**优化方案**：
1. **分片评估**：将规则分组，轮流评估
2. **增量评估**：只评估有数据更新的指标
3. **缓存查询结果**：相同查询条件缓存 N 秒

#### 8.4.2 告警聚合

**当前问题**：
- 每次查询都遍历所有活跃告警
- 前端每 30 秒刷新一次

**优化方案**：
1. **数据库视图**：创建聚合视图，减少计算
2. **缓存聚合结果**：缓存 10 秒
3. **WebSocket 推送**：有新告警时主动推送，减少轮询

#### 8.4.3 数据库索引

**已创建索引**：
```sql
CREATE INDEX idx_alert_events_rule_id ON alert_events(rule_id);
CREATE INDEX idx_alert_events_device_id ON alert_events(device_id);
CREATE INDEX idx_alert_events_status ON alert_events(status);
CREATE INDEX idx_alert_events_triggered_at ON alert_events(triggered_at);
```

**建议添加**：
```sql
-- 复合索引：按状态和规则查询
CREATE INDEX idx_alert_events_status_rule ON alert_events(status, rule_id);

-- 复合索引：按状态和触发时间排序
CREATE INDEX idx_alert_events_status_time ON alert_events(status, triggered_at DESC);
```

### 8.5 功能增强建议 🚀

#### 8.5.1 告警通知 ✅ 已实现

**当前状态**：核心功能已完成

**已实现**：
- [x] 邮件通知 ✅
- [x] Webhook 通知 ✅
- [x] 钉钉/企业微信通知 ✅
- [x] 通知去重（相同告警 N 分钟内只通知一次） ✅
- [x] 通知升级（告警持续 N 分钟后升级通知） ✅
- [x] 异步批量发送 ✅
- [x] 通知记录和历史查询 ✅

**待实现**：
- [ ] 短信通知
- [ ] Slack/Telegram 通知
- [ ] 通知模板自定义
- [ ] 通知静默时段
- [ ] 通知失败重试

**详细说明**: 请参阅 [告警通知功能文档](../gravital-core/docs/ALERT_NOTIFICATION.md)

#### 8.5.2 告警静默

**当前状态**：已实现接口，未完善逻辑

**待实现**：
- [ ] 静默期间不触发新告警
- [ ] 静默期间不发送通知
- [ ] 静默到期自动恢复
- [ ] 静默规则管理（按时间段、按标签）

#### 8.5.3 告警抑制

**当前状态**：数据模型中有 `inhibit_rules` 字段，未实现

**待实现**：
- [ ] 配置抑制规则（如：主机离线时，抑制该主机的所有服务告警）
- [ ] 抑制规则评估
- [ ] 抑制关系可视化

#### 8.5.4 告警分组

**当前状态**：仅按规则聚合

**待实现**：
- [ ] 按设备分组
- [ ] 按标签分组
- [ ] 自定义分组规则

#### 8.5.5 告警历史分析

**待实现**：
- [ ] 告警趋势图（按时间、级别、规则）
- [ ] 告警 Top N（最频繁的规则、设备）
- [ ] 告警响应时间统计（触发到确认、触发到解决）
- [ ] 告警导出（CSV、Excel）

---

## 9. 总结

### 9.1 已实现功能

✅ 告警规则 CRUD
✅ 告警规则启用/禁用
✅ 告警引擎（定时评估）
✅ 告警事件生命周期管理
✅ 告警事件确认/解决
✅ 告警聚合
✅ 批量操作（确认、解决）
✅ 按规则解决所有告警
✅ 前端 UI（概览、规则、事件）
✅ 自动刷新

### 9.2 待优化项

⚠️ 告警引擎查询 VictoriaMetrics（当前查询 PostgreSQL）
⏳ 告警通知
⏳ 告警静默
⏳ 告警抑制
⏳ 性能优化（缓存、分片、增量评估）
⏳ 告警历史分析

### 9.3 相关文档

- [告警引擎实现说明](./ALERT_ENGINE_IMPLEMENTATION.md)
- [告警概览故障排查](./ALERT_OVERVIEW_TROUBLESHOOTING.md)
- [告警自动解决问题](./ALERT_AUTO_RESOLVE_ISSUE.md)
- [告警数据源不一致问题](./ALERT_DATA_SOURCE_ISSUE.md)
- [告警优化方案](./ALERT_OPTIMIZATION.md)

---

**文档版本**: v1.0
**最后更新**: 2025-11-23
**维护者**: Celestial Team

