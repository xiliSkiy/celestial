# éªŒè¯è®¾å¤‡çŠ¶æ€æŒ‡æ ‡è¯´æ˜

## é—®é¢˜è¯´æ˜

åœ¨è¿è¡Œ `verify_device_status_in_tsdb.sh` æ—¶å‡ºç° `404 page not found` é”™è¯¯ã€‚

### åŸå› åˆ†æ

**å½“å‰å®ç°çŠ¶æ€**ï¼š
- âœ… é‡‡é›†ç«¯ä¼šç”Ÿæˆ `device_status` æŒ‡æ ‡
- âœ… ä¸­å¿ƒç«¯ä¼šè½¬å‘æŒ‡æ ‡åˆ° VictoriaMetrics
- âŒ ä¸­å¿ƒç«¯**æ²¡æœ‰**å®ç°æŒ‡æ ‡æŸ¥è¯¢ APIï¼ˆ`/api/v1/metrics/query`ï¼‰

**æ•°æ®æµç¡®è®¤**ï¼š
```
é‡‡é›†ç«¯ â†’ device_status æŒ‡æ ‡ â†’ ä¸­å¿ƒç«¯ â†’ VictoriaMetrics âœ“
                                      â†“
                              PostgreSQL âœ“
```

**æŸ¥è¯¢æ–¹å¼**ï¼š
```
å‰ç«¯ â†’ ä¸­å¿ƒç«¯ API â†’ VictoriaMetrics  âœ— (API æœªå®ç°)
å‰ç«¯ â†’ ç›´æ¥æŸ¥è¯¢ VictoriaMetrics      âœ“ (å¯ä»¥å·¥ä½œ)
```

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ç®€åŒ–ç‰ˆéªŒè¯è„šæœ¬ï¼ˆæ¨èï¼‰

æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„éªŒè¯è„šæœ¬ï¼Œç›´æ¥æŸ¥è¯¢ VictoriaMetricsï¼š

```bash
./verify_device_status_simple.sh
```

**è¿™ä¸ªè„šæœ¬ä¼š**ï¼š
1. âœ… æ£€æŸ¥ VictoriaMetrics è¿æ¥
2. âœ… æŸ¥è¯¢æ‰€æœ‰ `device_status` æŒ‡æ ‡
3. âœ… æ˜¾ç¤ºè®¾å¤‡åœ¨çº¿/ç¦»çº¿çŠ¶æ€
4. âœ… æŸ¥è¯¢çŠ¶æ€å†å²æ•°æ®
5. âœ… å¯¹æ¯” PostgreSQL ä¸­çš„çŠ¶æ€

### æ–¹æ¡ˆ 2ï¼šæ‰‹åŠ¨æŸ¥è¯¢ VictoriaMetrics

#### 2.1 æŸ¥è¯¢æ‰€æœ‰è®¾å¤‡çŠ¶æ€

```bash
curl "http://localhost:8428/api/v1/query?query=device_status"
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "status": "success",
  "data": {
    "resultType": "vector",
    "result": [
      {
        "metric": {
          "__name__": "device_status",
          "device_id": "dev-25422c94",
          "device_type": "server",
          "plugin": "ping",
          "sentinel_id": "sentinel-xxx",
          "task_id": "task-177bfd59"
        },
        "value": [1700500000, "1"]  // 1=åœ¨çº¿, 0=ç¦»çº¿
      }
    ]
  }
}
```

#### 2.2 æŸ¥è¯¢åœ¨çº¿è®¾å¤‡

```bash
curl "http://localhost:8428/api/v1/query?query=device_status==1"
```

#### 2.3 æŸ¥è¯¢ç¦»çº¿è®¾å¤‡

```bash
curl "http://localhost:8428/api/v1/query?query=device_status==0"

```

#### 2.4 æŸ¥è¯¢ç‰¹å®šè®¾å¤‡

```bash
curl "http://localhost:8428/api/v1/query?query=device_status{device_id=\"dev-25422c94\"}"
```

#### 2.5 æŸ¥è¯¢çŠ¶æ€å†å²ï¼ˆè¿‡å» 1 å°æ—¶ï¼‰

```bash
NOW=$(date +%s)
START=$((NOW - 3600))

curl "http://localhost:8428/api/v1/query_range?query=device_status{device_id=\"dev-25422c94\"}&start=$START&end=$NOW&step=60s"
```

#### 2.6 è®¡ç®—åœ¨çº¿ç‡ï¼ˆè¿‡å» 24 å°æ—¶ï¼‰

```bash
curl "http://localhost:8428/api/v1/query?query=avg_over_time(device_status{device_id=\"dev-25422c94\"}[24h])*100"
```

### æ–¹æ¡ˆ 3ï¼šåœ¨ Grafana ä¸­æŸ¥çœ‹

å¦‚æœä½ ä½¿ç”¨ Grafanaï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºé¢æ¿æŸ¥è¯¢ï¼š

**Panel 1: è®¾å¤‡çŠ¶æ€æ€»è§ˆ**
```promql
device_status
```

**Panel 2: åœ¨çº¿è®¾å¤‡æ•°é‡**
```promql
count(device_status == 1)
```

**Panel 3: ç¦»çº¿è®¾å¤‡æ•°é‡**
```promql
count(device_status == 0)
```

**Panel 4: è®¾å¤‡åœ¨çº¿ç‡è¶‹åŠ¿**
```promql
avg(device_status) * 100
```

**Panel 5: ç‰¹å®šè®¾å¤‡çŠ¶æ€å†å²**
```promql
device_status{device_id="dev-25422c94"}
```

---

## æ•°æ®éªŒè¯æ¸…å•

### âœ… éªŒè¯ 1ï¼šæ£€æŸ¥é‡‡é›†ç«¯æ˜¯å¦ç”ŸæˆæŒ‡æ ‡

**æŸ¥çœ‹é‡‡é›†ç«¯æ—¥å¿—**ï¼š
```bash
cd orbital-sentinels
tail -f logs/sentinel.log | grep "Task succeeded"
```

**é¢„æœŸæ—¥å¿—**ï¼š
```
{"level":"INFO","msg":"Task succeeded","task_id":"task-xxx","device_id":"dev-xxx","metrics":5}
```

æ³¨æ„ `metrics` æ•°é‡åº”è¯¥ >= åŸæœ‰æŒ‡æ ‡æ•°é‡ + 1ï¼ˆdevice_statusï¼‰

### âœ… éªŒè¯ 2ï¼šæ£€æŸ¥ä¸­å¿ƒç«¯æ˜¯å¦æ¥æ”¶æŒ‡æ ‡

**æŸ¥çœ‹ä¸­å¿ƒç«¯æ—¥å¿—**ï¼š
```bash
cd gravital-core
tail -f logs/app.log | grep "Ingested metrics"
```

**é¢„æœŸæ—¥å¿—**ï¼š
```
{"level":"INFO","msg":"Ingested metrics","sentinel_id":"sentinel-xxx","count":5,"devices_updated":1}
```

æ³¨æ„ `devices_updated` åº”è¯¥ > 0ï¼Œè¡¨ç¤ºæ›´æ–°äº†è®¾å¤‡çŠ¶æ€

### âœ… éªŒè¯ 3ï¼šæ£€æŸ¥ PostgreSQL ä¸­çš„çŠ¶æ€

```sql
SELECT device_id, name, status, last_seen 
FROM devices 
ORDER BY last_seen DESC NULLS LAST;
```

**é¢„æœŸç»“æœ**ï¼š
- `status` åº”è¯¥æ˜¯ `online` æˆ– `offline`ï¼ˆä¸æ˜¯ `unknown`ï¼‰
- `last_seen` åº”è¯¥æ˜¯æœ€è¿‘çš„æ—¶é—´

### âœ… éªŒè¯ 4ï¼šæ£€æŸ¥ VictoriaMetrics ä¸­çš„æ•°æ®

```bash
curl "http://localhost:8428/api/v1/query?query=device_status" | jq '.'
```

**é¢„æœŸç»“æœ**ï¼š
- `status` ä¸º `success`
- `result` æ•°ç»„ä¸ä¸ºç©º
- æ¯ä¸ªç»“æœåŒ…å« `device_id` æ ‡ç­¾
- `value` ä¸º `1` æˆ– `0`

### âœ… éªŒè¯ 5ï¼šæ£€æŸ¥è½¬å‘å™¨é…ç½®

```sql
SELECT name, type, enabled, endpoint 
FROM forwarder_configs 
WHERE enabled = true;
```

**é¢„æœŸç»“æœ**ï¼š
- è‡³å°‘æœ‰ä¸€ä¸ªå¯ç”¨çš„è½¬å‘å™¨
- `type` ä¸º `victoria-metrics` æˆ– `prometheus`
- `endpoint` æŒ‡å‘æ­£ç¡®çš„åœ°å€

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: VictoriaMetrics ä¸­æ²¡æœ‰æ•°æ®

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. **ç¡®è®¤ VictoriaMetrics æ­£åœ¨è¿è¡Œ**
   ```bash
   curl http://localhost:8428/health
   ```

2. **æ£€æŸ¥è½¬å‘å™¨é…ç½®**
   ```sql
   SELECT * FROM forwarder_configs WHERE enabled = true;
   ```

3. **æŸ¥çœ‹ä¸­å¿ƒç«¯æ—¥å¿—**
   ```bash
   grep "Failed to forward" gravital-core/logs/app.log
   ```

4. **æ‰‹åŠ¨æµ‹è¯•è½¬å‘**
   ```bash
   curl -X POST http://localhost:8428/api/v1/write \
     -H "Content-Type: application/x-protobuf" \
     --data-binary @test_data.pb
   ```

### Q2: è®¾å¤‡çŠ¶æ€ä¸€ç›´æ˜¯ unknown

**å¯èƒ½åŸå› **ï¼š

1. é‡‡é›†ç«¯æœªè¿è¡Œ
   ```bash
   ps aux | grep sentinel
   ```

2. é‡‡é›†ä»»åŠ¡æœªé…ç½®
   ```sql
   SELECT * FROM collection_tasks WHERE device_id = 'dev-xxx';
   ```

3. é‡‡é›†å¤±è´¥
   ```bash
   grep "Task failed" orbital-sentinels/logs/sentinel.log
   ```

### Q3: PostgreSQL æœ‰çŠ¶æ€ï¼ŒVictoriaMetrics æ²¡æœ‰

**å¯èƒ½åŸå› **ï¼š

1. è½¬å‘å™¨æœªå¯ç”¨
   ```sql
   UPDATE forwarder_configs SET enabled = true WHERE name = 'vm';
   ```

2. è½¬å‘å™¨é…ç½®é”™è¯¯
   - æ£€æŸ¥ `endpoint` æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

3. æ•°æ®è½¬å‘å¤±è´¥
   ```bash
   grep "Failed to forward" gravital-core/logs/app.log
   ```

---

## ä¸‹ä¸€æ­¥ï¼šå®ç°æŒ‡æ ‡æŸ¥è¯¢ APIï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ å¸Œæœ›ä¸­å¿ƒç«¯æä¾›ç»Ÿä¸€çš„æŒ‡æ ‡æŸ¥è¯¢ APIï¼Œå¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

### éœ€è¦å®ç°çš„ API

1. **æŸ¥è¯¢å½“å‰æŒ‡æ ‡**
   ```
   POST /api/v1/metrics/query
   Body: {"query": "device_status"}
   ```

2. **æŸ¥è¯¢å†å²æŒ‡æ ‡**
   ```
   POST /api/v1/metrics/query_range
   Body: {
     "query": "device_status{device_id=\"xxx\"}",
     "start": 1700500000,
     "end": 1700510000,
     "step": "60s"
   }
   ```

### å®ç°æ–¹å¼

åˆ›å»ºä¸€ä¸ª `MetricsHandler`ï¼Œä»£ç†æŸ¥è¯¢åˆ° VictoriaMetricsï¼š

```go
// gravital-core/internal/api/handler/metrics_handler.go
type MetricsHandler struct {
    vmURL  string
    logger *zap.Logger
}

func (h *MetricsHandler) Query(c *gin.Context) {
    var req struct {
        Query string `json:"query"`
    }
    c.ShouldBindJSON(&req)
    
    // ä»£ç†åˆ° VictoriaMetrics
    resp, err := http.Get(fmt.Sprintf("%s/api/v1/query?query=%s", 
        h.vmURL, url.QueryEscape(req.Query)))
    
    // è¿”å›ç»“æœ
    c.JSON(200, resp)
}
```

**ä½†è¿™ä¸æ˜¯å¿…éœ€çš„**ï¼Œå› ä¸ºï¼š
1. å‰ç«¯å¯ä»¥ç›´æ¥æŸ¥è¯¢ VictoriaMetrics
2. Grafana å¯ä»¥ç›´æ¥è¿æ¥ VictoriaMetrics
3. å‡å°‘ä¸€å±‚ä»£ç†ï¼Œæ€§èƒ½æ›´å¥½

---

## æ€»ç»“

### âœ… å·²ç¡®è®¤

1. **è®¾å¤‡çŠ¶æ€æŒ‡æ ‡ä¼šè½¬å­˜åˆ°æ—¶åºåº“** âœ“
2. **æ•°æ®æµç¨‹æ­£ç¡®** âœ“
   - é‡‡é›†ç«¯ç”Ÿæˆ â†’ ä¸­å¿ƒç«¯æ¥æ”¶ â†’ è½¬å‘åˆ° VictoriaMetrics
3. **PostgreSQL å’Œæ—¶åºåº“éƒ½æœ‰æ•°æ®** âœ“

### ğŸ“ éªŒè¯æ–¹æ³•

1. **å¿«é€ŸéªŒè¯**ï¼šè¿è¡Œ `./verify_device_status_simple.sh`
2. **æ‰‹åŠ¨éªŒè¯**ï¼šç›´æ¥æŸ¥è¯¢ VictoriaMetrics
3. **å¯è§†åŒ–éªŒè¯**ï¼šåœ¨ Grafana ä¸­åˆ›å»ºé¢æ¿

### ğŸ¯ å…³é”®ç‚¹

- ä¸­å¿ƒç«¯**ä¸éœ€è¦**å®ç°æŒ‡æ ‡æŸ¥è¯¢ API
- å‰ç«¯å¯ä»¥ç›´æ¥æŸ¥è¯¢ VictoriaMetrics
- è¿™æ˜¯æ›´ç®€å•ã€æ›´é«˜æ•ˆçš„æ¶æ„


