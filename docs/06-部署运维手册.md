# 部署运维手册

## 1. 系统要求

### 1.1 中心端 (Gravital Core)

#### 最小配置（< 100 设备）
```yaml
CPU: 2 核
内存: 4GB
磁盘: 50GB SSD
网络: 100Mbps
操作系统: 
  - Linux (推荐): Ubuntu 20.04+, CentOS 7+, Debian 10+
  - macOS 10.15+
  - Windows Server 2016+
```

#### 推荐配置（100-1000 设备）
```yaml
CPU: 4 核
内存: 8GB
磁盘: 200GB SSD
网络: 1Gbps
```

#### 大规模配置（> 1000 设备）
```yaml
CPU: 8+ 核
内存: 16GB+
磁盘: 500GB+ SSD (RAID 10)
网络: 10Gbps
```

### 1.2 采集端 (Orbital Sentinel)

#### 最小配置
```yaml
CPU: 1 核
内存: 512MB
磁盘: 10GB
网络: 10Mbps
操作系统:
  - Linux (推荐): Ubuntu 20.04+, CentOS 7+
  - macOS 10.15+
  - Windows 10+
```

#### 推荐配置（50+ 设备采集）
```yaml
CPU: 2 核
内存: 2GB
磁盘: 20GB
网络: 100Mbps
```

### 1.3 依赖服务

#### 中心端依赖
```yaml
PostgreSQL:
  版本: 12+
  推荐: 15
  资源: 2核/4GB/100GB

Redis:
  版本: 6+
  推荐: 7
  资源: 1核/2GB

Grafana (可选):
  版本: 9.0+
  推荐: 10.x
  资源: 1核/2GB

时序数据库（选一）:
  - Prometheus: 2.40+
  - VictoriaMetrics: 1.90+
  - ClickHouse: 23.x
```

## 2. 快速部署

### 2.1 使用 Docker Compose（推荐）

#### 步骤 1: 下载部署文件
```bash
# 克隆项目
git clone https://github.com/celestial/celestial.git
cd celestial

# 或直接下载 docker-compose.yaml
wget https://raw.githubusercontent.com/celestial/celestial/main/deploy/docker/docker-compose.yaml
```

#### 步骤 2: 配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
vi .env
```

`.env` 文件示例：
```bash
# 数据库配置
DB_PASSWORD=your_secure_password_here
POSTGRES_DB=gravital
POSTGRES_USER=postgres

# Redis 配置
REDIS_PASSWORD=your_redis_password_here

# JWT 密钥
JWT_SECRET=your_jwt_secret_key_here

# Grafana 配置
GRAFANA_PASSWORD=admin

# 中心端配置
GRAVITAL_PORT=8080
GRAVITAL_MODE=production

# 时序数据库选择
TSDB_TYPE=victoria-metrics  # prometheus, victoria-metrics, clickhouse
```

#### 步骤 3: 启动服务
```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f gravital-core

# 检查服务状态
docker-compose ps
```

#### 步骤 4: 初始化系统
```bash
# 等待服务启动（约 30 秒）
sleep 30

# 创建初始管理员用户
docker-compose exec gravital-core ./gravital-cli user create \
  --username admin \
  --password Admin@123 \
  --email admin@example.com \
  --role admin

# 或访问 Web UI 完成初始化
open http://localhost:8080
```

#### 步骤 5: 验证部署
```bash
# 检查健康状态
curl http://localhost:8080/health

# 访问 Web UI
# URL: http://localhost:8080
# 用户名: admin
# 密码: Admin@123

# 访问 Grafana
# URL: http://localhost:3000
# 用户名: admin
# 密码: (来自 .env 的 GRAFANA_PASSWORD)
```

### 2.2 Docker Compose 完整配置

```yaml
# docker-compose.yaml
version: '3.8'

services:
  # 中心端
  gravital-core:
    image: celestial/gravital-core:latest
    container_name: gravital-core
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB}
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - SERVER_MODE=${GRAVITAL_MODE}
    volumes:
      - ./config/gravital-core.yaml:/app/config/config.yaml
      - gravital-data:/app/data
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - celestial-network

  # PostgreSQL
  postgres:
    image: postgres:15
    container_name: celestial-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - celestial-network

  # Redis
  redis:
    image: redis:7
    container_name: celestial-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - celestial-network

  # VictoriaMetrics
  victoria-metrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: victoria-metrics
    ports:
      - "8428:8428"
    volumes:
      - victoria-data:/victoria-metrics-data
    command:
      - '--storageDataPath=/victoria-metrics-data'
      - '--retentionPeriod=12'  # 保留 12 个月
    restart: unless-stopped
    networks:
      - celestial-network

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: celestial-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - victoria-metrics
    restart: unless-stopped
    networks:
      - celestial-network

volumes:
  gravital-data:
  postgres-data:
  redis-data:
  victoria-data:
  grafana-data:

networks:
  celestial-network:
    driver: bridge
```

### 2.3 二进制部署

#### 步骤 1: 下载二进制文件
```bash
# Linux AMD64
wget https://releases.celestial.io/v1.0.0/gravital-core-linux-amd64.tar.gz
tar -xzf gravital-core-linux-amd64.tar.gz
cd gravital-core

# macOS
wget https://releases.celestial.io/v1.0.0/gravital-core-darwin-amd64.tar.gz

# Windows
# 下载 gravital-core-windows-amd64.zip 并解压
```

#### 步骤 2: 安装依赖服务
```bash
# 安装 PostgreSQL
sudo apt update
sudo apt install postgresql postgresql-contrib -y

# 创建数据库
sudo -u postgres psql
CREATE DATABASE gravital;
CREATE USER gravital WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE gravital TO gravital;
\q

# 安装 Redis
sudo apt install redis-server -y
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

#### 步骤 3: 配置中心端
```bash
# 复制配置模板
cp config/config.example.yaml config/config.yaml

# 编辑配置
vi config/config.yaml
```

配置文件示例：
```yaml
server:
  host: 0.0.0.0
  port: 8080
  mode: production

database:
  host: localhost
  port: 5432
  database: gravital
  username: gravital
  password: your_password
  max_open_conns: 100
  max_idle_conns: 10

redis:
  host: localhost
  port: 6379
  password: ""
  db: 0

auth:
  jwt_secret: change_this_to_random_string
  token_expire: 24h

logging:
  level: info
  format: json
  output: stdout
```

#### 步骤 4: 初始化数据库
```bash
# 运行数据库迁移
./gravital-core migrate up

# 创建管理员用户
./gravital-core user create \
  --username admin \
  --password Admin@123 \
  --email admin@example.com \
  --role admin
```

#### 步骤 5: 启动服务
```bash
# 前台运行（测试）
./gravital-core start

# 后台运行
nohup ./gravital-core start > gravital.log 2>&1 &

# 使用 systemd（推荐）
sudo cp scripts/gravital-core.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable gravital-core
sudo systemctl start gravital-core
sudo systemctl status gravital-core
```

Systemd 服务文件示例：
```ini
# /etc/systemd/system/gravital-core.service
[Unit]
Description=Celestial Gravital Core
After=network.target postgresql.service redis.service
Wants=postgresql.service redis.service

[Service]
Type=simple
User=gravital
Group=gravital
WorkingDirectory=/opt/gravital-core
ExecStart=/opt/gravital-core/gravital-core start
ExecStop=/bin/kill -s TERM $MAINPID
Restart=on-failure
RestartSec=10s
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

### 2.4 采集端部署

#### Docker 方式
```bash
# 拉取镜像
docker pull celestial/orbital-sentinel:latest

# 运行
docker run -d \
  --name sentinel-01 \
  --restart unless-stopped \
  -v ./config:/app/config \
  -v ./plugins:/app/plugins \
  -e CORE_URL=https://gravital-core.example.com \
  -e API_TOKEN=your_api_token \
  celestial/orbital-sentinel:latest
```

#### 二进制方式
```bash
# 下载
wget https://releases.celestial.io/v1.0.0/sentinel-linux-amd64.tar.gz
tar -xzf sentinel-linux-amd64.tar.gz
cd sentinel

# 配置
cp config/config.example.yaml config/config.yaml
vi config/config.yaml

# 注册到中心端
./sentinel register \
  --core-url https://gravital-core.example.com \
  --name sentinel-office-01 \
  --region office-beijing

# 启动
./sentinel start

# 或使用 systemd
sudo cp scripts/sentinel.service /etc/systemd/system/
sudo systemctl enable sentinel
sudo systemctl start sentinel
```

Sentinel 配置文件：
```yaml
sentinel:
  name: "sentinel-office-01"
  region: "office-beijing"
  labels:
    env: production
    datacenter: dc1

core:
  url: "https://gravital-core.example.com"
  api_token: "${API_TOKEN}"
  insecure_skip_verify: false

heartbeat:
  interval: 30s
  timeout: 10s

collector:
  worker_pool_size: 10
  task_fetch_interval: 60s

buffer:
  type: memory
  size: 10000
  flush_interval: 10s

sender:
  mode: core
  batch_size: 1000
  timeout: 30s

plugins:
  directory: "./plugins"
  auto_reload: true

logging:
  level: info
  format: json
  output: stdout
```

## 3. Kubernetes 部署

### 3.1 使用 Helm Chart

#### 添加 Helm 仓库
```bash
helm repo add celestial https://charts.celestial.io
helm repo update
```

#### 安装中心端
```bash
# 创建命名空间
kubectl create namespace celestial

# 安装
helm install gravital-core celestial/gravital-core \
  --namespace celestial \
  --set postgresql.enabled=true \
  --set redis.enabled=true \
  --set victoriametrics.enabled=true \
  --set grafana.enabled=true \
  --values custom-values.yaml
```

`custom-values.yaml` 示例：
```yaml
# 中心端配置
gravitaCore:
  replicas: 2
  image:
    repository: celestial/gravital-core
    tag: latest
    pullPolicy: IfNotPresent
  
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  
  config:
    server:
      mode: production
    auth:
      jwt_secret: "change_this_secret"
  
  ingress:
    enabled: true
    className: nginx
    hosts:
      - host: gravital.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: gravital-tls
        hosts:
          - gravital.example.com

# PostgreSQL 配置
postgresql:
  enabled: true
  auth:
    username: gravital
    password: changeme
    database: gravital
  primary:
    persistence:
      size: 100Gi
    resources:
      requests:
        cpu: 500m
        memory: 2Gi

# Redis 配置
redis:
  enabled: true
  auth:
    password: changeme
  master:
    persistence:
      size: 10Gi

# VictoriaMetrics 配置
victoriametrics:
  enabled: true
  server:
    persistentVolume:
      size: 500Gi
    retentionPeriod: 12  # 月

# Grafana 配置
grafana:
  enabled: true
  adminPassword: changeme
  persistence:
    enabled: true
    size: 10Gi
  ingress:
    enabled: true
    hosts:
      - grafana.example.com
```

#### 安装采集端
```bash
# 使用 DaemonSet 方式（每个节点一个）
helm install sentinel celestial/sentinel \
  --namespace celestial \
  --set core.url=https://gravital.example.com \
  --set core.apiToken=your_token

# 或使用 Deployment 方式（指定副本数）
helm install sentinel celestial/sentinel \
  --namespace celestial \
  --set deployment.enabled=true \
  --set deployment.replicas=3
```

### 3.2 原生 YAML 部署

#### 中心端部署文件
```yaml
# gravital-core-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gravital-core
  namespace: celestial
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gravital-core
  template:
    metadata:
      labels:
        app: gravital-core
    spec:
      containers:
      - name: gravital-core
        image: celestial/gravital-core:latest
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          value: postgresql
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gravital-secrets
              key: db-password
        - name: REDIS_HOST
          value: redis
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: gravital-secrets
              key: jwt-secret
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
        volumeMounts:
        - name: config
          mountPath: /app/config
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: gravital-config

---
apiVersion: v1
kind: Service
metadata:
  name: gravital-core
  namespace: celestial
spec:
  selector:
    app: gravital-core
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gravital-core
  namespace: celestial
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - gravital.example.com
    secretName: gravital-tls
  rules:
  - host: gravital.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gravital-core
            port:
              number: 8080
```

#### Secret 配置
```yaml
# gravital-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: gravital-secrets
  namespace: celestial
type: Opaque
stringData:
  db-password: your_db_password
  redis-password: your_redis_password
  jwt-secret: your_jwt_secret
```

#### ConfigMap 配置
```yaml
# gravital-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: gravital-config
  namespace: celestial
data:
  config.yaml: |
    server:
      host: 0.0.0.0
      port: 8080
      mode: production
    database:
      host: postgresql
      port: 5432
      database: gravital
      username: gravital
    # ... 其他配置
```

#### 应用部署
```bash
# 创建命名空间
kubectl create namespace celestial

# 应用配置
kubectl apply -f gravital-secrets.yaml
kubectl apply -f gravital-config.yaml
kubectl apply -f gravital-core-deployment.yaml

# 查看状态
kubectl get pods -n celestial
kubectl logs -f deployment/gravital-core -n celestial
```

## 4. 高可用部署

### 4.1 中心端 HA 架构

```
                    ┌─────────────┐
                    │   Nginx/LB  │
                    └──────┬──────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
    ┌─────▼─────┐    ┌─────▼─────┐    ┌────▼──────┐
    │ Core #1   │    │ Core #2   │    │ Core #3   │
    └─────┬─────┘    └─────┬─────┘    └────┬──────┘
          │                │                │
          └────────────────┼────────────────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
    ┌─────▼─────┐    ┌─────▼─────┐    ┌────▼──────┐
    │ PG Primary│    │ Redis Sen │    │ VM Cluster│
    │ PG Replica│    │ 3 nodes   │    │ 3 nodes   │
    └───────────┘    └───────────┘    └───────────┘
```

### 4.2 PostgreSQL 主从配置

使用 Patroni 实现自动故障转移：
```yaml
# patroni-config.yaml
scope: celestial-postgres
namespace: /db/
name: postgresql-1

restapi:
  listen: 0.0.0.0:8008
  connect_address: postgresql-1:8008

etcd:
  hosts: etcd-1:2379,etcd-2:2379,etcd-3:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        max_connections: 500
        shared_buffers: 2GB
        effective_cache_size: 6GB
        maintenance_work_mem: 512MB
        checkpoint_completion_target: 0.9
        wal_buffers: 16MB
        default_statistics_target: 100
        random_page_cost: 1.1
        effective_io_concurrency: 200
        work_mem: 10485kB
        min_wal_size: 1GB
        max_wal_size: 4GB

  initdb:
    - encoding: UTF8
    - data-checksums

postgresql:
  listen: 0.0.0.0:5432
  connect_address: postgresql-1:5432
  data_dir: /var/lib/postgresql/15/main
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: rep_password
    superuser:
      username: postgres
      password: postgres_password
```

### 4.3 Redis Sentinel 配置

```bash
# redis-sentinel.conf
port 26379
dir /tmp
sentinel monitor mymaster redis-master 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 10000
```

### 4.4 负载均衡配置

#### Nginx 配置
```nginx
upstream gravital_core {
    least_conn;
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name gravital.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name gravital.example.com;
    
    ssl_certificate /etc/nginx/ssl/gravital.crt;
    ssl_certificate_key /etc/nginx/ssl/gravital.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    location / {
        proxy_pass http://gravital_core;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://gravital_core/health;
        access_log off;
    }
}
```

## 5. 监控和告警

### 5.1 系统自监控

Celestial 导出自身的监控指标：
```yaml
# Prometheus 抓取配置
scrape_configs:
  - job_name: 'gravital-core'
    static_configs:
      - targets: ['gravital-core:8080']
    metrics_path: '/metrics'
    scrape_interval: 15s
  
  - job_name: 'sentinels'
    http_sd_configs:
      - url: http://gravital-core:8080/api/v1/sentinels/discovery
```

### 5.2 关键指标告警

Prometheus 告警规则：
```yaml
# alerts.yaml
groups:
  - name: celestial
    rules:
      # 中心端离线
      - alert: GravitalCoreDown
        expr: up{job="gravital-core"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Gravital Core is down"
          description: "Gravital Core {{ $labels.instance }} has been down for more than 1 minute"
      
      # Sentinel 离线过多
      - alert: TooManySentinelsOffline
        expr: (count(celestial_sentinel_online == 0) / count(celestial_sentinel_online)) > 0.3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Too many Sentinels offline"
          description: "More than 30% of Sentinels are offline"
      
      # API 响应时间过长
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High API latency"
          description: "95th percentile API latency is above 1s"
      
      # 数据库连接数过高
      - alert: HighDatabaseConnections
        expr: pg_stat_database_numbackends > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High database connections"
```

### 5.3 日志收集

使用 ELK 或 Loki 收集日志：

#### Loki + Promtail 配置
```yaml
# promtail-config.yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: gravital-core
    static_configs:
      - targets:
          - localhost
        labels:
          job: gravital-core
          __path__: /var/log/gravital-core/*.log
```

## 6. 备份和恢复

### 6.1 数据库备份

#### 自动备份脚本
```bash
#!/bin/bash
# backup-postgres.sh

BACKUP_DIR=/backup/postgres
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/gravital_$DATE.sql.gz"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -h localhost -U gravital gravital | gzip > $BACKUP_FILE

# 保留最近 7 天的备份
find $BACKUP_DIR -name "gravital_*.sql.gz" -mtime +7 -delete

# 上传到对象存储（可选）
# aws s3 cp $BACKUP_FILE s3://my-bucket/backups/
```

#### 定时任务
```bash
# 添加到 crontab
0 2 * * * /opt/scripts/backup-postgres.sh
```

### 6.2 数据恢复
```bash
# 恢复数据库
gunzip < gravital_20251101_020000.sql.gz | psql -h localhost -U gravital gravital

# 或从备份文件直接恢复
pg_restore -h localhost -U gravital -d gravital gravital_backup.dump
```

### 6.3 配置备份
```bash
# 备份中心端配置
tar -czf config-backup.tar.gz \
  /opt/gravital-core/config/ \
  /opt/gravital-core/migrations/

# 备份 Sentinel 配置
tar -czf sentinel-config-backup.tar.gz \
  /opt/sentinel/config/ \
  /opt/sentinel/plugins/
```

## 7. 升级指南

### 7.1 中心端升级

#### Docker 方式
```bash
# 1. 备份数据
docker-compose exec postgres pg_dump -U gravital gravital > backup.sql

# 2. 拉取新版本
docker-compose pull gravital-core

# 3. 停止服务
docker-compose stop gravital-core

# 4. 升级
docker-compose up -d gravital-core

# 5. 查看日志
docker-compose logs -f gravital-core

# 6. 验证
curl http://localhost:8080/health
```

#### 二进制方式
```bash
# 1. 备份
cp -r /opt/gravital-core /opt/gravital-core.backup

# 2. 下载新版本
wget https://releases.celestial.io/v1.1.0/gravital-core-linux-amd64.tar.gz

# 3. 停止服务
sudo systemctl stop gravital-core

# 4. 替换二进制文件
tar -xzf gravital-core-linux-amd64.tar.gz
cp gravital-core /opt/gravital-core/

# 5. 运行迁移（如果需要）
/opt/gravital-core/gravital-core migrate up

# 6. 启动服务
sudo systemctl start gravital-core

# 7. 验证
sudo systemctl status gravital-core
curl http://localhost:8080/health
```

### 7.2 采集端升级

#### 滚动升级策略
```bash
# 1. 升级第一批 Sentinel（10%）
for sentinel in sentinel-01 sentinel-02; do
  ssh $sentinel "wget -O /tmp/sentinel https://releases.celestial.io/v1.1.0/sentinel-linux-amd64"
  ssh $sentinel "sudo systemctl stop sentinel"
  ssh $sentinel "sudo mv /tmp/sentinel /opt/sentinel/sentinel && sudo chmod +x /opt/sentinel/sentinel"
  ssh $sentinel "sudo systemctl start sentinel"
done

# 2. 等待并验证
sleep 60

# 3. 检查状态
curl https://gravital-core.example.com/api/v1/sentinels | jq '.data.items[] | select(.status!="online")'

# 4. 如果正常，继续升级其他 Sentinel
```

#### Kubernetes 滚动更新
```bash
# 更新镜像
kubectl set image deployment/sentinel \
  sentinel=celestial/sentinel:v1.1.0 \
  -n celestial

# 查看滚动更新状态
kubectl rollout status deployment/sentinel -n celestial

# 如果出现问题，回滚
kubectl rollout undo deployment/sentinel -n celestial
```

### 7.3 零停机升级

使用蓝绿部署：
```bash
# 1. 部署新版本（绿色环境）
helm install gravital-core-green celestial/gravital-core \
  --namespace celestial-green \
  --set image.tag=v1.1.0

# 2. 测试新版本
curl https://gravital-green.example.com/health

# 3. 切换流量（修改 Ingress 或 DNS）
kubectl patch ingress gravital-core \
  -n celestial \
  -p '{"spec":{"rules":[{"host":"gravital.example.com","http":{"paths":[{"backend":{"service":{"name":"gravital-core-green","port":{"number":8080}}}}]}}]}}'

# 4. 观察一段时间后，删除旧版本
helm uninstall gravital-core -n celestial
```

## 8. 故障排查

### 8.1 常见问题

#### 问题 1: 中心端无法启动
```bash
# 检查日志
docker-compose logs gravital-core
# 或
journalctl -u gravital-core -f

# 常见原因:
# 1. 数据库连接失败
# 检查数据库状态
docker-compose ps postgres
psql -h localhost -U gravital -d gravital -c "SELECT 1;"

# 2. 端口被占用
sudo lsof -i:8080

# 3. 配置文件错误
./gravital-core validate-config
```

#### 问题 2: Sentinel 无法连接中心端
```bash
# 检查网络连通性
curl -v https://gravital-core.example.com/health

# 检查 API Token
curl -H "X-API-Token: your_token" \
  https://gravital-core.example.com/api/v1/sentinels/heartbeat

# 检查证书
openssl s_client -connect gravital-core.example.com:443

# 检查 Sentinel 日志
journalctl -u sentinel -f
```

#### 问题 3: 数据未采集
```bash
# 1. 检查任务状态
curl -H "Authorization: Bearer $TOKEN" \
  https://gravital-core.example.com/api/v1/tasks?device_id=dev-001

# 2. 检查 Sentinel 状态
curl -H "Authorization: Bearer $TOKEN" \
  https://gravital-core.example.com/api/v1/sentinels/sentinel-001

# 3. 手动测试设备连接
./sentinel test-connection \
  --plugin snmp \
  --host 192.168.1.1 \
  --community public
```

#### 问题 4: 告警未触发
```bash
# 1. 检查告警规则
curl -H "Authorization: Bearer $TOKEN" \
  https://gravital-core.example.com/api/v1/alert-rules

# 2. 检查告警引擎日志
docker-compose logs gravital-core | grep "alert"

# 3. 手动触发告警规则评估
curl -X POST -H "Authorization: Bearer $TOKEN" \
  https://gravital-core.example.com/api/v1/alert-rules/1/evaluate
```

### 8.2 性能问题排查

#### CPU 使用率高
```bash
# 查看 goroutine 数量
curl http://localhost:8080/debug/pprof/goroutine?debug=2

# CPU Profile
curl http://localhost:8080/debug/pprof/profile?seconds=30 > cpu.prof
go tool pprof cpu.prof

# Top CPU 消耗函数
go tool pprof -top cpu.prof
```

#### 内存使用率高
```bash
# 堆内存 Profile
curl http://localhost:8080/debug/pprof/heap > heap.prof
go tool pprof heap.prof

# 查看内存分配
go tool pprof -alloc_space heap.prof
```

#### 数据库慢查询
```sql
-- 查看慢查询
SELECT query, calls, total_time, mean_time, max_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 20;

-- 查看锁等待
SELECT * FROM pg_stat_activity
WHERE wait_event IS NOT NULL;

-- 查看长时间运行的查询
SELECT pid, now() - query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY duration DESC;
```

### 8.3 日志分析

#### 使用 grep 分析日志
```bash
# 错误日志
grep "ERROR" gravital.log | tail -100

# 慢请求
grep "slow_request" gravital.log | awk '{print $NF}' | sort -n | tail -20

# 统计错误类型
grep "ERROR" gravital.log | awk '{print $5}' | sort | uniq -c | sort -rn
```

#### 使用 jq 分析 JSON 日志
```bash
# 提取错误信息
cat gravital.log | jq 'select(.level=="error") | {time, msg, error}'

# 统计 API 调用
cat gravital.log | jq 'select(.api_path) | .api_path' | sort | uniq -c | sort -rn

# 慢请求分析
cat gravital.log | jq 'select(.duration_ms > 1000) | {api_path, duration_ms}' | sort -k2 -rn
```

## 9. 安全加固

### 9.1 网络安全
```bash
# 配置防火墙（仅开放必要端口）
sudo ufw enable
sudo ufw allow 22/tcp     # SSH
sudo ufw allow 80/tcp     # HTTP
sudo ufw allow 443/tcp    # HTTPS
sudo ufw deny 8080/tcp    # 禁止直接访问应用端口（通过 Nginx 代理）
```

### 9.2 HTTPS 配置
```bash
# 使用 Let's Encrypt
sudo certbot --nginx -d gravital.example.com

# 或使用自签名证书（开发环境）
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/gravital.key \
  -out /etc/nginx/ssl/gravital.crt \
  -subj "/CN=gravital.example.com"
```

### 9.3 数据库安全
```sql
-- 创建只读用户
CREATE USER gravital_readonly WITH PASSWORD 'readonly_password';
GRANT CONNECT ON DATABASE gravital TO gravital_readonly;
GRANT USAGE ON SCHEMA public TO gravital_readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO gravital_readonly;

-- 限制访问来源（修改 pg_hba.conf）
# IPv4 local connections:
host    gravital    gravital    192.168.1.0/24    md5
```

### 9.4 审计日志
```yaml
# 启用审计日志
audit:
  enabled: true
  log_all_requests: false
  log_sensitive_data: false
  retention_days: 90
  log_events:
    - user_login
    - user_logout
    - device_create
    - device_delete
    - alert_rule_create
    - alert_rule_delete
    - config_change
```

## 10. 维护任务清单

### 10.1 日常维护（每天）
- [ ] 检查系统健康状态
- [ ] 查看错误日志
- [ ] 检查告警事件
- [ ] 验证数据采集正常

### 10.2 周维护（每周）
- [ ] 检查磁盘使用率
- [ ] 检查数据库性能
- [ ] 清理过期数据
- [ ] 检查 Sentinel 状态
- [ ] 审查安全日志

### 10.3 月维护（每月）
- [ ] 数据库备份验证
- [ ] 系统性能评估
- [ ] 容量规划
- [ ] 安全补丁更新
- [ ] 文档更新

### 10.4 季度维护（每季度）
- [ ] 灾难恢复演练
- [ ] 架构评审
- [ ] 性能优化
- [ ] 安全审计

## 11. 附录

### 11.1 端口列表
```yaml
中心端:
  8080: HTTP API
  8443: HTTPS API (可选)

数据库:
  5432: PostgreSQL
  6379: Redis
  9090: Prometheus
  8428: VictoriaMetrics
  9000: ClickHouse
  3000: Grafana

采集端:
  无需监听端口（仅出站连接）
```

### 11.2 文件路径
```yaml
中心端:
  配置: /opt/gravital-core/config/config.yaml
  日志: /var/log/gravital-core/
  数据: /var/lib/gravital-core/

采集端:
  配置: /opt/sentinel/config/config.yaml
  插件: /opt/sentinel/plugins/
  日志: /var/log/sentinel/
  数据: /var/lib/sentinel/
```

### 11.3 有用的命令
```bash
# 查看版本
./gravital-core version
./sentinel version

# 验证配置
./gravital-core validate-config
./sentinel validate-config

# 数据库迁移
./gravital-core migrate status
./gravital-core migrate up
./gravital-core migrate down

# 用户管理
./gravital-core user list
./gravital-core user create --username admin --password xxx
./gravital-core user reset-password --username admin

# Sentinel 管理
./sentinel register --core-url xxx
./sentinel test-connection --plugin snmp --host xxx
./sentinel list-plugins
```

---

如有问题，请访问:
- 官方文档: https://docs.celestial.io
- GitHub Issues: https://github.com/celestial/celestial/issues
- 社区论坛: https://community.celestial.io

