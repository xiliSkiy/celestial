# 设备网络拓扑详细设计

## 1. 功能概述

### 1.1 设计目标

设备网络拓扑功能旨在为运维人员提供直观的网络设备连接关系可视化展示，帮助快速理解网络架构、定位故障点、规划网络变更。

### 1.2 核心功能

- **拓扑自动发现**: 基于 LLDP/CDP 协议自动发现设备连接关系
- **手动拓扑编辑**: 支持手动添加、编辑、删除连接关系
- **多层级展示**: 支持核心层、汇聚层、接入层等分层展示
- **实时状态**: 设备和链路状态实时更新
- **交互操作**: 拖拽、缩放、搜索、过滤等交互功能
- **拓扑导出**: 支持导出为图片、PDF、JSON 等格式
- **告警关联**: 在拓扑图上显示告警信息

### 1.3 应用场景

| 场景 | 描述 | 价值 |
|-----|------|------|
| 网络架构可视化 | 直观展示网络设备连接关系 | 快速理解网络结构 |
| 故障定位 | 在拓扑图上标识故障设备和链路 | 加速故障排查 |
| 变更影响分析 | 模拟设备或链路故障的影响范围 | 降低变更风险 |
| 容量规划 | 分析网络流量和瓶颈 | 优化网络架构 |
| 文档生成 | 自动生成网络拓扑文档 | 提高文档准确性 |

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    前端展示层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  拓扑画布     │  │  控制面板     │  │  属性面板     │   │
│  │  (Canvas)    │  │  (Toolbar)   │  │  (Panel)     │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                    API 网关层                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  拓扑 API  │  设备 API  │  链路 API  │  布局 API  │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                    业务逻辑层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  拓扑服务     │  │  发现服务     │  │  布局引擎     │   │
│  │ TopologyService│ │DiscoveryService│ │LayoutEngine │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  链路服务     │  │  分析服务     │  │  导出服务     │   │
│  │  LinkService  │  │AnalysisService│ │ ExportService│   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                    数据访问层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  拓扑仓储     │  │  设备仓储     │  │  链路仓储     │   │
│  │TopologyRepo  │  │ DeviceRepo   │  │  LinkRepo    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                    数据存储层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  PostgreSQL  │  │    Redis     │  │  时序数据库   │   │
│  │  (关系数据)   │  │   (缓存)     │  │  (流量数据)   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块职责

#### 2.2.1 前端模块

| 模块 | 职责 | 技术选型 |
|-----|------|---------|
| 拓扑画布 | 渲染拓扑图、处理交互 | D3.js / Cytoscape.js / G6 |
| 控制面板 | 工具栏、布局切换、过滤 | Vue 3 + Element Plus |
| 属性面板 | 显示节点/链路详情 | Vue 3 + Element Plus |
| 数据管理 | 状态管理、API 调用 | Pinia |

#### 2.2.2 后端模块

| 模块 | 职责 | 关键功能 |
|-----|------|---------|
| 拓扑服务 | 拓扑 CRUD、版本管理 | 创建、查询、更新、删除拓扑 |
| 发现服务 | 自动发现设备连接 | LLDP/CDP 解析、邻居发现 |
| 链路服务 | 链路管理、状态监控 | 链路创建、状态更新、流量统计 |
| 布局引擎 | 自动布局算法 | 力导向、层次、环形、树形布局 |
| 分析服务 | 路径分析、影响分析 | 最短路径、连通性、影响范围 |
| 导出服务 | 拓扑导出 | PNG、SVG、PDF、JSON 导出 |

---

## 3. 数据模型设计

### 3.1 拓扑图表 (topologies)

```sql
CREATE TABLE topologies (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    type VARCHAR(32) NOT NULL,              -- physical, logical, custom
    scope VARCHAR(32),                       -- global, datacenter, region
    layout_type VARCHAR(32) DEFAULT 'force', -- force, hierarchical, circular, tree
    layout_config JSONB,                     -- 布局配置
    view_config JSONB,                       -- 视图配置（缩放、中心点等）
    is_auto_discovery BOOLEAN DEFAULT false, -- 是否自动发现
    discovery_interval INT,                  -- 发现间隔（秒）
    last_discovery_at TIMESTAMP,             -- 最后发现时间
    version INT DEFAULT 1,                   -- 版本号
    created_by BIGINT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_type (type),
    INDEX idx_scope (scope)
);
```

**字段说明**:
- `type`: 拓扑类型
  - `physical`: 物理拓扑（真实连接）
  - `logical`: 逻辑拓扑（业务关系）
  - `custom`: 自定义拓扑
- `layout_type`: 布局算法类型
- `layout_config`: 布局参数配置
- `view_config`: 视图状态（缩放级别、中心坐标等）

### 3.2 拓扑节点表 (topology_nodes)

```sql
CREATE TABLE topology_nodes (
    id BIGSERIAL PRIMARY KEY,
    topology_id BIGINT NOT NULL REFERENCES topologies(id) ON DELETE CASCADE,
    device_id VARCHAR(64) NOT NULL,         -- 关联设备
    node_type VARCHAR(32) NOT NULL,         -- device, group, cloud, internet
    label VARCHAR(255),                      -- 节点显示名称
    icon VARCHAR(64),                        -- 图标类型
    position_x FLOAT,                        -- X 坐标
    position_y FLOAT,                        -- Y 坐标
    layer INT DEFAULT 0,                     -- 层级（核心层=0，汇聚层=1，接入层=2）
    size INT DEFAULT 40,                     -- 节点大小
    color VARCHAR(32),                       -- 节点颜色
    shape VARCHAR(32) DEFAULT 'circle',      -- 节点形状
    properties JSONB,                        -- 自定义属性
    is_locked BOOLEAN DEFAULT false,         -- 是否锁定位置
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(topology_id, device_id),
    INDEX idx_topology_device (topology_id, device_id),
    INDEX idx_layer (topology_id, layer)
);
```

**字段说明**:
- `node_type`: 节点类型
  - `device`: 网络设备
  - `group`: 设备组
  - `cloud`: 云服务
  - `internet`: 互联网
- `layer`: 网络层级（用于层次布局）
- `is_locked`: 锁定后自动布局不会改变其位置

### 3.3 拓扑链路表 (topology_links)

```sql
CREATE TABLE topology_links (
    id BIGSERIAL PRIMARY KEY,
    topology_id BIGINT NOT NULL REFERENCES topologies(id) ON DELETE CASCADE,
    source_node_id BIGINT NOT NULL REFERENCES topology_nodes(id) ON DELETE CASCADE,
    target_node_id BIGINT NOT NULL REFERENCES topology_nodes(id) ON DELETE CASCADE,
    link_type VARCHAR(32) NOT NULL,         -- physical, logical, virtual
    source_interface VARCHAR(128),          -- 源接口
    target_interface VARCHAR(128),          -- 目标接口
    bandwidth BIGINT,                       -- 带宽（bps）
    protocol VARCHAR(32),                   -- 协议（Ethernet, Fiber, Wireless）
    status VARCHAR(32) DEFAULT 'unknown',   -- up, down, degraded, unknown
    utilization FLOAT,                      -- 利用率（0-100）
    latency FLOAT,                          -- 延迟（ms）
    packet_loss FLOAT,                      -- 丢包率（%）
    line_style VARCHAR(32) DEFAULT 'solid', -- solid, dashed, dotted
    line_width INT DEFAULT 2,               -- 线宽
    color VARCHAR(32),                      -- 线条颜色
    label VARCHAR(255),                     -- 链路标签
    properties JSONB,                       -- 自定义属性
    discovered_by VARCHAR(32),              -- 发现方式（lldp, cdp, manual）
    discovered_at TIMESTAMP,                -- 发现时间
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_topology (topology_id),
    INDEX idx_source (source_node_id),
    INDEX idx_target (target_node_id),
    INDEX idx_status (status)
);
```

**字段说明**:
- `link_type`: 链路类型
  - `physical`: 物理连接
  - `logical`: 逻辑连接（如 VLAN）
  - `virtual`: 虚拟连接（如 VPN）
- `discovered_by`: 发现方式
  - `lldp`: LLDP 协议发现
  - `cdp`: CDP 协议发现
  - `manual`: 手动添加

### 3.4 拓扑分组表 (topology_groups)

```sql
CREATE TABLE topology_groups (
    id BIGSERIAL PRIMARY KEY,
    topology_id BIGINT NOT NULL REFERENCES topologies(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    parent_id BIGINT REFERENCES topology_groups(id),
    position_x FLOAT,                       -- 分组框 X 坐标
    position_y FLOAT,                       -- 分组框 Y 坐标
    width FLOAT,                            -- 分组框宽度
    height FLOAT,                           -- 分组框高度
    color VARCHAR(32),                      -- 背景颜色
    border_color VARCHAR(32),               -- 边框颜色
    is_collapsed BOOLEAN DEFAULT false,     -- 是否折叠
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_topology (topology_id),
    INDEX idx_parent (parent_id)
);
```

### 3.5 拓扑版本历史表 (topology_versions)

```sql
CREATE TABLE topology_versions (
    id BIGSERIAL PRIMARY KEY,
    topology_id BIGINT NOT NULL REFERENCES topologies(id) ON DELETE CASCADE,
    version INT NOT NULL,
    snapshot JSONB NOT NULL,                -- 完整拓扑快照
    change_description TEXT,                -- 变更说明
    changed_by BIGINT,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(topology_id, version),
    INDEX idx_topology_version (topology_id, version)
);
```

### 3.6 LLDP 邻居表 (lldp_neighbors)

```sql
CREATE TABLE lldp_neighbors (
    id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(64) NOT NULL,         -- 本地设备
    local_interface VARCHAR(128) NOT NULL,  -- 本地接口
    neighbor_chassis_id VARCHAR(128),       -- 邻居 Chassis ID
    neighbor_port_id VARCHAR(128),          -- 邻居端口 ID
    neighbor_system_name VARCHAR(255),      -- 邻居系统名称
    neighbor_system_desc TEXT,              -- 邻居系统描述
    neighbor_port_desc VARCHAR(255),        -- 邻居端口描述
    neighbor_mgmt_addr VARCHAR(64),         -- 邻居管理地址
    ttl INT,                                -- TTL（秒）
    discovered_at TIMESTAMP,                -- 发现时间
    last_seen TIMESTAMP,                    -- 最后更新时间
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(device_id, local_interface, neighbor_chassis_id, neighbor_port_id),
    INDEX idx_device (device_id),
    INDEX idx_neighbor (neighbor_chassis_id)
);
```

---

## 4. API 接口设计

### 4.1 拓扑管理 API

#### 4.1.1 获取拓扑列表

```http
GET /api/v1/topologies
```

**查询参数**:
```json
{
  "page": 1,
  "page_size": 20,
  "type": "physical",
  "scope": "datacenter",
  "keyword": "核心网络"
}
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "total": 10,
    "items": [
      {
        "id": 1,
        "name": "数据中心核心网络",
        "type": "physical",
        "scope": "datacenter",
        "node_count": 50,
        "link_count": 80,
        "created_at": "2024-01-01T00:00:00Z"
      }
    ]
  }
}
```

#### 4.1.2 获取拓扑详情

```http
GET /api/v1/topologies/:id
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "name": "数据中心核心网络",
    "description": "数据中心核心层拓扑",
    "type": "physical",
    "layout_type": "hierarchical",
    "nodes": [
      {
        "id": 1,
        "device_id": "dev-001",
        "label": "核心交换机-1",
        "node_type": "device",
        "layer": 0,
        "position": { "x": 100, "y": 50 },
        "status": "online",
        "properties": {
          "ip": "192.168.1.1",
          "model": "Cisco Catalyst 9500"
        }
      }
    ],
    "links": [
      {
        "id": 1,
        "source": 1,
        "target": 2,
        "link_type": "physical",
        "source_interface": "GigabitEthernet1/0/1",
        "target_interface": "GigabitEthernet1/0/1",
        "bandwidth": 10000000000,
        "status": "up",
        "utilization": 45.5
      }
    ],
    "groups": []
  }
}
```

#### 4.1.3 创建拓扑

```http
POST /api/v1/topologies
```

**请求体**:
```json
{
  "name": "新拓扑",
  "description": "描述",
  "type": "physical",
  "scope": "datacenter",
  "layout_type": "force",
  "is_auto_discovery": true,
  "discovery_interval": 300
}
```

#### 4.1.4 更新拓扑

```http
PUT /api/v1/topologies/:id
```

#### 4.1.5 删除拓扑

```http
DELETE /api/v1/topologies/:id
```

### 4.2 节点管理 API

#### 4.2.1 添加节点

```http
POST /api/v1/topologies/:id/nodes
```

**请求体**:
```json
{
  "device_id": "dev-001",
  "node_type": "device",
  "label": "核心交换机",
  "position": { "x": 100, "y": 50 },
  "layer": 0
}
```

#### 4.2.2 更新节点位置

```http
PATCH /api/v1/topologies/:id/nodes/:node_id/position
```

**请求体**:
```json
{
  "x": 150,
  "y": 100
}
```

#### 4.2.3 批量更新节点

```http
PATCH /api/v1/topologies/:id/nodes/batch
```

**请求体**:
```json
{
  "nodes": [
    { "id": 1, "position": { "x": 100, "y": 50 } },
    { "id": 2, "position": { "x": 200, "y": 50 } }
  ]
}
```

#### 4.2.4 删除节点

```http
DELETE /api/v1/topologies/:id/nodes/:node_id
```

### 4.3 链路管理 API

#### 4.3.1 添加链路

```http
POST /api/v1/topologies/:id/links
```

**请求体**:
```json
{
  "source_node_id": 1,
  "target_node_id": 2,
  "link_type": "physical",
  "source_interface": "GigabitEthernet1/0/1",
  "target_interface": "GigabitEthernet1/0/1",
  "bandwidth": 10000000000
}
```

#### 4.3.2 更新链路状态

```http
PATCH /api/v1/topologies/:id/links/:link_id/status
```

**请求体**:
```json
{
  "status": "up",
  "utilization": 45.5,
  "latency": 2.5,
  "packet_loss": 0.01
}
```

#### 4.3.3 删除链路

```http
DELETE /api/v1/topologies/:id/links/:link_id
```

### 4.4 自动发现 API

#### 4.4.1 触发自动发现

```http
POST /api/v1/topologies/:id/discover
```

**请求体**:
```json
{
  "method": "lldp",
  "scope": "all"
}
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "task_id": "task-12345",
    "status": "running",
    "discovered_nodes": 0,
    "discovered_links": 0
  }
}
```

#### 4.4.2 获取发现任务状态

```http
GET /api/v1/topologies/:id/discover/:task_id
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "task_id": "task-12345",
    "status": "completed",
    "discovered_nodes": 10,
    "discovered_links": 15,
    "started_at": "2024-01-01T00:00:00Z",
    "completed_at": "2024-01-01T00:05:00Z"
  }
}
```

### 4.5 布局 API

#### 4.5.1 应用自动布局

```http
POST /api/v1/topologies/:id/layout
```

**请求体**:
```json
{
  "layout_type": "hierarchical",
  "options": {
    "direction": "TB",
    "node_spacing": 100,
    "layer_spacing": 150
  }
}
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "nodes": [
      { "id": 1, "position": { "x": 100, "y": 50 } },
      { "id": 2, "position": { "x": 200, "y": 50 } }
    ]
  }
}
```

### 4.6 分析 API

#### 4.6.1 路径分析

```http
POST /api/v1/topologies/:id/analyze/path
```

**请求体**:
```json
{
  "source_node_id": 1,
  "target_node_id": 10,
  "algorithm": "shortest"
}
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "paths": [
      {
        "nodes": [1, 3, 5, 10],
        "links": [1, 5, 8],
        "hop_count": 3,
        "total_latency": 5.2
      }
    ]
  }
}
```

#### 4.6.2 影响分析

```http
POST /api/v1/topologies/:id/analyze/impact
```

**请求体**:
```json
{
  "node_id": 3,
  "scenario": "failure"
}
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "affected_nodes": [5, 6, 7, 8, 9, 10],
    "affected_links": [5, 6, 7, 8],
    "isolated_nodes": [10],
    "impact_level": "high"
  }
}
```

### 4.7 导出 API

#### 4.7.1 导出为图片

```http
POST /api/v1/topologies/:id/export/image
```

**请求体**:
```json
{
  "format": "png",
  "width": 1920,
  "height": 1080,
  "background": "#ffffff"
}
```

**响应**: 图片文件流

#### 4.7.2 导出为 JSON

```http
GET /api/v1/topologies/:id/export/json
```

---

## 5. 前端设计

### 5.1 页面布局

```
┌─────────────────────────────────────────────────────────┐
│  顶部工具栏                                               │
│  [拓扑列表] [布局] [视图] [工具] [导出] [设置]            │
└─────────────────────────────────────────────────────────┘
┌──────┬────────────────────────────────────────┬──────────┐
│      │                                        │          │
│ 左侧 │          拓扑画布                       │  右侧    │
│ 面板 │      (可拖拽、缩放、旋转)                │  面板    │
│      │                                        │          │
│ 设备 │                                        │  属性    │
│ 列表 │                                        │  详情    │
│      │                                        │          │
│ 图层 │                                        │  统计    │
│ 管理 │                                        │  信息    │
│      │                                        │          │
└──────┴────────────────────────────────────────┴──────────┘
┌─────────────────────────────────────────────────────────┐
│  底部状态栏                                               │
│  [缩放: 100%] [节点: 50] [链路: 80] [选中: 2]            │
└─────────────────────────────────────────────────────────┘
```

### 5.2 核心组件

#### 5.2.1 拓扑画布组件 (TopologyCanvas)

**功能**:
- 渲染节点和链路
- 处理鼠标交互（拖拽、点击、框选）
- 支持缩放和平移
- 动画效果

**技术选型**:
- **D3.js**: 强大的数据可视化库，灵活但学习曲线陡
- **Cytoscape.js**: 专注于图论可视化，性能好
- **G6 (AntV)**: 阿里开源，功能丰富，中文文档完善
- **推荐**: G6，理由：功能完整、性能好、社区活跃

#### 5.2.2 工具栏组件 (TopologyToolbar)

**功能**:
- 布局切换（力导向、层次、环形、树形）
- 视图控制（缩放、适应、居中）
- 编辑工具（添加节点、添加链路、删除）
- 过滤器（按类型、状态、层级过滤）
- 搜索（节点搜索、高亮）

#### 5.2.3 属性面板组件 (PropertyPanel)

**功能**:
- 显示选中节点/链路的详细信息
- 编辑节点/链路属性
- 显示实时监控数据
- 显示告警信息

#### 5.2.4 图层管理组件 (LayerManager)

**功能**:
- 管理网络层级（核心层、汇聚层、接入层）
- 显示/隐藏特定层级
- 调整层级顺序

#### 5.2.5 迷你地图组件 (MiniMap)

**功能**:
- 显示整体拓扑缩略图
- 指示当前视口位置
- 快速导航

### 5.3 交互设计

#### 5.3.1 节点交互

| 操作 | 行为 | 反馈 |
|-----|------|------|
| 单击节点 | 选中节点，显示详情 | 高亮边框，显示属性面板 |
| 双击节点 | 进入设备详情页 | 页面跳转 |
| 右键节点 | 显示上下文菜单 | 弹出菜单 |
| 拖拽节点 | 移动节点位置 | 实时更新位置 |
| 悬停节点 | 显示工具提示 | 显示基本信息 |

#### 5.3.2 链路交互

| 操作 | 行为 | 反馈 |
|-----|------|------|
| 单击链路 | 选中链路，显示详情 | 高亮链路，显示属性面板 |
| 悬停链路 | 显示流量信息 | 显示带宽、利用率等 |
| 右键链路 | 显示上下文菜单 | 弹出菜单 |

#### 5.3.3 画布交互

| 操作 | 行为 | 反馈 |
|-----|------|------|
| 拖拽画布 | 平移视图 | 画布移动 |
| 滚轮 | 缩放视图 | 缩放动画 |
| 框选 | 多选节点 | 显示选框，高亮节点 |
| 双击空白 | 取消选择 | 清除高亮 |

### 5.4 视觉设计

#### 5.4.1 节点样式

| 设备类型 | 图标 | 颜色 | 形状 |
|---------|------|------|------|
| 核心交换机 | 🔷 | 蓝色 (#409EFF) | 正方形 |
| 汇聚交换机 | 🔶 | 橙色 (#E6A23C) | 菱形 |
| 接入交换机 | 🔸 | 绿色 (#67C23A) | 圆形 |
| 路由器 | 🔺 | 紫色 (#9B59B6) | 三角形 |
| 防火墙 | 🛡️ | 红色 (#F56C6C) | 六边形 |
| 服务器 | 🖥️ | 灰色 (#909399) | 矩形 |

#### 5.4.2 链路样式

| 链路状态 | 颜色 | 线型 | 宽度 |
|---------|------|------|------|
| 正常 (up) | 绿色 | 实线 | 2px |
| 故障 (down) | 红色 | 虚线 | 2px |
| 降级 (degraded) | 橙色 | 点线 | 2px |
| 未知 (unknown) | 灰色 | 实线 | 1px |

#### 5.4.3 状态指示

- **节点状态**: 在节点右上角显示状态徽章
  - 🟢 在线
  - 🔴 离线
  - 🟡 告警
  - ⚪ 未知

- **链路利用率**: 通过颜色渐变表示
  - 0-50%: 绿色
  - 50-80%: 黄色
  - 80-100%: 红色

### 5.5 布局算法

#### 5.5.1 力导向布局 (Force-Directed)

**适用场景**: 通用拓扑，自动优化节点分布

**参数**:
- `strength`: 引力强度
- `distance`: 节点间距
- `iterations`: 迭代次数

**优点**: 自动优化，美观
**缺点**: 每次布局结果可能不同

#### 5.5.2 层次布局 (Hierarchical)

**适用场景**: 有明确层级关系的网络（核心-汇聚-接入）

**参数**:
- `direction`: 方向（TB/BT/LR/RL）
- `layerSpacing`: 层间距
- `nodeSpacing`: 节点间距

**优点**: 清晰展示层级关系
**缺点**: 需要预先定义层级

#### 5.5.3 环形布局 (Circular)

**适用场景**: 环形网络拓扑

**参数**:
- `radius`: 半径
- `startAngle`: 起始角度
- `endAngle`: 结束角度

**优点**: 节省空间，适合环形结构
**缺点**: 链路可能交叉

#### 5.5.4 树形布局 (Tree)

**适用场景**: 树形结构网络

**参数**:
- `direction`: 方向
- `levelSeparation`: 层级间距
- `siblingDistance`: 兄弟节点间距

**优点**: 清晰展示树形关系
**缺点**: 只适用于树形结构

---

## 6. 自动发现机制

### 6.1 LLDP 发现流程

```
1. 采集端定期采集 LLDP 邻居信息
   ↓
2. 上报到 Gravital Core
   ↓
3. 存储到 lldp_neighbors 表
   ↓
4. 拓扑发现服务解析 LLDP 数据
   ↓
5. 匹配设备（通过 Chassis ID、IP、名称）
   ↓
6. 创建或更新拓扑节点和链路
   ↓
7. 触发前端更新
```

### 6.2 发现策略

#### 6.2.1 增量发现

- 只处理新增和变更的邻居关系
- 减少计算开销
- 保留手动编辑的节点位置

#### 6.2.2 全量发现

- 重新扫描所有设备
- 清除过期的链路
- 重新计算布局

### 6.3 设备匹配规则

**优先级**:
1. Chassis ID 精确匹配
2. 管理 IP 匹配
3. 系统名称模糊匹配
4. 创建新设备（如果不存在）

### 6.4 链路去重

**规则**:
- 同一对设备之间的同一对接口只创建一条链路
- 双向链路合并为一条（A→B 和 B→A）
- 保留最新发现的链路信息

---

## 7. 实时更新机制

### 7.1 WebSocket 推送

**推送事件**:

```typescript
// 节点状态变更
{
  "type": "node_status_changed",
  "topology_id": 1,
  "node_id": 5,
  "status": "offline",
  "timestamp": "2024-01-01T00:00:00Z"
}

// 链路状态变更
{
  "type": "link_status_changed",
  "topology_id": 1,
  "link_id": 10,
  "status": "down",
  "timestamp": "2024-01-01T00:00:00Z"
}

// 拓扑结构变更
{
  "type": "topology_changed",
  "topology_id": 1,
  "change_type": "node_added",
  "data": { ... }
}
```

### 7.2 前端更新策略

**增量更新**:
- 只更新变化的节点/链路
- 保持当前视图状态
- 平滑动画过渡

**全量刷新**:
- 重新加载整个拓扑
- 适用于大规模变更

---

## 8. 性能优化

### 8.1 大规模拓扑优化

#### 8.1.1 节点数量分级

| 节点数 | 策略 | 说明 |
|-------|------|------|
| < 100 | 全量渲染 | 无需优化 |
| 100-500 | 虚拟化渲染 | 只渲染可见区域 |
| 500-1000 | 简化渲染 | 降低细节级别 |
| > 1000 | 分层加载 | 按需加载子图 |

#### 8.1.2 渲染优化

- **Canvas 渲染**: 使用 Canvas 代替 SVG（性能更好）
- **LOD (Level of Detail)**: 根据缩放级别调整细节
- **聚合显示**: 将多个节点聚合为一个
- **延迟渲染**: 使用 requestAnimationFrame

#### 8.1.3 数据优化

- **分页加载**: 按区域分页加载节点
- **缓存策略**: 缓存已加载的拓扑数据
- **增量更新**: 只传输变化的数据

### 8.2 后端优化

#### 8.2.1 数据库优化

- 添加合适的索引
- 使用 JSONB 索引加速查询
- 定期清理过期数据

#### 8.2.2 缓存策略

```
Redis 缓存层次:
- L1: 拓扑基本信息 (TTL: 1小时)
- L2: 节点和链路数据 (TTL: 5分钟)
- L3: 实时状态数据 (TTL: 30秒)
```

#### 8.2.3 查询优化

- 使用预加载避免 N+1 查询
- 批量查询设备状态
- 异步处理耗时操作

---

## 9. 安全设计

### 9.1 权限控制

#### 9.1.1 操作权限

| 操作 | 权限 | 说明 |
|-----|------|------|
| 查看拓扑 | `topology.read` | 查看拓扑图 |
| 创建拓扑 | `topology.write` | 创建新拓扑 |
| 编辑拓扑 | `topology.write` | 修改拓扑结构 |
| 删除拓扑 | `topology.delete` | 删除拓扑 |
| 触发发现 | `topology.discover` | 执行自动发现 |
| 导出拓扑 | `topology.export` | 导出拓扑数据 |

#### 9.1.2 数据隔离

- 租户级隔离（多租户场景）
- 用户级隔离（个人拓扑）
- 团队级共享（团队拓扑）

### 9.2 审计日志

**记录内容**:
- 拓扑创建/修改/删除
- 节点和链路的添加/删除
- 布局变更
- 导出操作

---

## 10. 扩展功能

### 10.1 告警集成

**功能**:
- 在拓扑图上显示告警设备（红色闪烁）
- 在链路上显示告警（红色高亮）
- 点击告警节点查看告警详情
- 告警统计（按严重程度）

### 10.2 流量可视化

**功能**:
- 链路流量动画（流动的粒子）
- 流量方向指示（箭头）
- 流量热力图
- 历史流量回放

### 10.3 路径追踪

**功能**:
- 输入源和目标，高亮显示路径
- 显示路径跳数、延迟
- 支持多路径对比
- 路径质量评分

### 10.4 变更模拟

**功能**:
- 模拟设备或链路故障
- 显示影响范围
- 生成变更报告
- 回滚操作

### 10.5 拓扑对比

**功能**:
- 对比不同时间点的拓扑
- 高亮显示变化（新增、删除、修改）
- 生成变更报告
- 版本回滚

### 10.6 自定义图层

**功能**:
- 添加自定义标注
- 绘制区域边界
- 添加文本说明
- 插入图片/图标

---

## 11. 技术选型建议

### 11.1 前端技术栈

| 技术 | 推荐方案 | 理由 |
|-----|---------|------|
| 框架 | Vue 3 | 已有技术栈 |
| 图形库 | G6 (AntV) | 功能完整、性能好、中文文档 |
| 状态管理 | Pinia | Vue 3 官方推荐 |
| UI 组件 | Element Plus | 已有技术栈 |
| 工具库 | Lodash | 通用工具函数 |

### 11.2 后端技术栈

| 技术 | 推荐方案 | 理由 |
|-----|---------|------|
| 语言 | Go | 已有技术栈 |
| 框架 | Gin | 已有技术栈 |
| 数据库 | PostgreSQL | 已有技术栈 |
| 缓存 | Redis | 已有技术栈 |
| 消息队列 | Redis Streams | 轻量级，无需额外组件 |

---

## 12. 实施计划

### 12.1 第一阶段：基础功能（2周）

- [ ] 数据模型设计和建表
- [ ] 基础 API 实现（CRUD）
- [ ] 前端拓扑画布组件
- [ ] 节点和链路渲染
- [ ] 基本交互（拖拽、缩放）

### 12.2 第二阶段：自动发现（2周）

- [ ] LLDP 数据采集
- [ ] 邻居关系解析
- [ ] 自动拓扑生成
- [ ] 设备匹配算法
- [ ] 增量更新机制

### 12.3 第三阶段：高级功能（2周）

- [ ] 多种布局算法
- [ ] 实时状态更新
- [ ] 告警集成
- [ ] 路径分析
- [ ] 影响分析

### 12.4 第四阶段：优化和扩展（2周）

- [ ] 性能优化
- [ ] 大规模拓扑支持
- [ ] 导出功能
- [ ] 版本管理
- [ ] 文档完善

---

## 13. 测试策略

### 13.1 单元测试

- 布局算法测试
- 路径分析算法测试
- 设备匹配逻辑测试
- API 接口测试

### 13.2 集成测试

- 自动发现流程测试
- 实时更新测试
- 多用户并发测试

### 13.3 性能测试

- 大规模拓扑渲染测试（1000+ 节点）
- 并发访问测试
- 内存泄漏测试

### 13.4 用户测试

- 可用性测试
- 交互体验测试
- 跨浏览器兼容性测试

---

## 14. 风险和挑战

### 14.1 技术风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 大规模拓扑性能 | 高 | 分层加载、虚拟化渲染 |
| 自动发现准确性 | 中 | 多种匹配策略、人工校验 |
| 实时更新延迟 | 中 | WebSocket、增量更新 |
| 浏览器兼容性 | 低 | 使用成熟的图形库 |

### 14.2 业务风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 用户学习成本 | 中 | 提供教程、简化操作 |
| 数据准确性 | 高 | 支持手动编辑、版本管理 |
| 网络复杂度 | 高 | 分层展示、过滤功能 |

---

## 15. 参考资料

### 15.1 相关标准

- **IEEE 802.1AB**: LLDP 协议标准
- **RFC 4293**: IP MIB 定义
- **RFC 2863**: 接口 MIB 定义

### 15.2 开源项目

- **G6**: https://g6.antv.vision/
- **Cytoscape.js**: https://js.cytoscape.org/
- **D3.js**: https://d3js.org/
- **vis.js**: https://visjs.org/

### 15.3 商业产品参考

- **Cisco Prime Infrastructure**: 网络拓扑管理
- **SolarWinds Network Topology Mapper**: 自动拓扑发现
- **NetBrain**: 动态网络拓扑
- **Zabbix Network Maps**: 网络地图

---

## 16. 总结

设备网络拓扑功能是网络运维管理的核心功能之一，本设计文档涵盖了从数据模型、API 接口、前端展示到自动发现、实时更新的完整方案。

**核心亮点**:
- ✅ 自动发现：基于 LLDP/CDP 自动构建拓扑
- ✅ 实时更新：WebSocket 推送设备和链路状态
- ✅ 多种布局：支持力导向、层次、环形等多种布局
- ✅ 性能优化：支持大规模拓扑（1000+ 节点）
- ✅ 告警集成：在拓扑图上直观展示告警
- ✅ 路径分析：支持路径追踪和影响分析
- ✅ 版本管理：支持拓扑版本历史和回滚

**实施建议**:
1. 优先实现基础功能和手动编辑
2. 逐步完善自动发现机制
3. 持续优化性能和用户体验
4. 根据用户反馈迭代功能

本设计文档为后续开发提供了清晰的指导，可根据实际需求进行调整和扩展。

