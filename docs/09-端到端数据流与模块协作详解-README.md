# 端到端数据流与模块协作详解 - 文档导航

> 本系列文档详细说明了 Gravital 监控系统的数据流转、模块协作和设计决策。

## 📚 文档列表

### Part 1: 核心业务流程
**文件**: `09-端到端数据流与模块协作详解.md`

**内容概要**:
- 系统全局视图和架构分层
- 数据分类与存储策略（元数据、时序数据、缓存数据）
- 设备接入与管理流程
- 采集任务配置与下发流程
- 数据采集与上报流程（部分）

**适合人群**: 
- 需要了解系统整体架构的开发者
- 需要理解业务流程的产品经理
- 新加入团队的工程师

### Part 2: 数据查询与告警
**文件**: `09-端到端数据流与模块协作详解-Part2.md`

**内容概要**:
- 数据查询与展示流程
  - 设备列表页面的数据来源
  - 监控大盘的实时指标展示
  - 设备详情页的综合信息展示
- 告警触发与处理流程
  - 告警架构设计
  - 告警规则配置
  - 告警检测实现（定时查询 vs vmalert）
  - 告警通知发送

**适合人群**:
- 前端开发者（了解数据消费方式）
- 告警系统开发者
- 运维人员（了解告警机制）

### Part 3A: 模块职责与边界
**文件**: `09-端到端数据流与模块协作详解-Part3-模块职责.md`

**内容概要**:
- 中心端模块划分（Handler、Service、Repository）
- 各层职责详解（应该做什么、不应该做什么）
- 采集端模块划分
- 模块交互规则（分层调用、跨模块通信）
- 模块边界案例分析
- 依赖注入和组件初始化

**适合人群**:
- 后端开发者（理解代码组织）
- 架构师（理解设计原则）
- Code Review 人员

### Part 3B: 数据库设计与时序库使用
**文件**: `09-端到端数据流与模块协作详解-Part3-数据库设计.md`

**内容概要**:
- PostgreSQL 表结构设计
  - 设备表、任务表、采集端表
  - 告警规则表、告警事件表
  - 转发器配置表
- 数据流转路径（从设备录入到前端展示）
- VictoriaMetrics 使用详解
  - 架构和存储格式
  - 标签设计原则
  - PromQL 查询示例
  - 数据保留策略
  - 查询性能优化
- 前端如何使用时序数据

**适合人群**:
- 数据库设计者
- 时序数据库使用者
- 性能优化工程师

---

## 🎯 快速导航

### 按角色查找

#### 前端开发者
1. **数据来源理解**: Part 2 → 3.5 数据查询与展示流程
2. **API 调用方式**: Part 2 → 3.5.3 场景 1/2/3
3. **时序数据使用**: Part 3B → 6.6 前端如何使用时序数据

#### 后端开发者
1. **代码组织**: Part 3A → 4.1-4.2 模块划分和职责
2. **API 实现**: Part 1 → 3.1-3.2 业务流程
3. **数据库设计**: Part 3B → 5.1 表结构设计

#### 采集端开发者
1. **注册流程**: Part 1 → 3.2 任务配置与下发
2. **数据采集**: Part 1 → 3.3 数据采集与上报
3. **模块组织**: Part 3A → 4.3 采集端模块划分

#### 运维人员
1. **系统架构**: Part 1 → 2.1 系统架构分层
2. **数据流转**: Part 3B → 5.2 数据流转路径
3. **告警机制**: Part 2 → 3.6 告警触发与处理

#### 架构师
1. **整体设计**: Part 1 → 2. 系统全局视图
2. **模块边界**: Part 3A → 4.4 模块交互规则
3. **设计决策**: 所有文档的"关键设计决策"章节

### 按问题查找

#### "数据从哪里来？"
- **设备信息**: Part 3B → 5.1.1 设备表
- **采集指标**: Part 1 → 3.3 数据采集流程
- **告警事件**: Part 2 → 3.6 告警触发流程

#### "数据到哪里去？"
- **元数据**: PostgreSQL（Part 3B → 5.1）
- **时序数据**: VictoriaMetrics（Part 3B → 6.1）
- **缓存数据**: Redis（Part 1 → 2.2.3）

#### "模块怎么协作？"
- **分层调用**: Part 3A → 4.4.1 分层调用规则
- **跨模块通信**: Part 3A → 4.4.2 跨模块通信
- **事件驱动**: Part 3A → 4.5 模块边界案例

#### "为什么这样设计？"
- **数据分类**: Part 1 → 2.2 数据分类与存储策略
- **任务拉取**: Part 1 → 3.2.4 Q1（拉取 vs 推送）
- **批量发送**: Part 1 → 3.3.5 Q1（批量 vs 实时）
- **标签设计**: Part 3B → 6.2.2 标签设计原则

---

## 🔍 核心概念索引

### 数据流转
- **采集流程**: Part 1 → 3.3
- **转发流程**: Part 2 → 3.4（需补充）
- **查询流程**: Part 2 → 3.5
- **告警流程**: Part 2 → 3.6

### 模块职责
- **Handler 层**: Part 3A → 4.2.1
- **Service 层**: Part 3A → 4.2.2
- **Repository 层**: Part 3A → 4.2.3
- **Forwarder**: Part 3A → 4.5 案例 2

### 数据库
- **表结构**: Part 3B → 5.1
- **索引策略**: Part 3B → 5.1.2 设计要点
- **查询优化**: Part 3B → 5.2.2

### 时序库
- **架构**: Part 3B → 6.1
- **标签设计**: Part 3B → 6.2.2
- **PromQL**: Part 3B → 6.3
- **性能优化**: Part 3B → 6.5

---

## 📖 阅读建议

### 新手入门路径
1. Part 1 → 2. 系统全局视图（理解整体架构）
2. Part 1 → 3.1 设备接入流程（理解第一个业务流程）
3. Part 3A → 4.2 各层职责详解（理解代码组织）
4. Part 2 → 3.5.3 场景 1（理解一个完整的数据查询）

### 深入理解路径
1. 阅读所有业务流程（Part 1 和 Part 2 的 3.x 章节）
2. 理解模块边界（Part 3A → 4.4-4.5）
3. 学习数据库设计（Part 3B → 5.1）
4. 掌握时序库使用（Part 3B → 6.x）

### 问题驱动路径
1. 遇到问题时，先在"按问题查找"中找到相关章节
2. 阅读相关的流程图和代码示例
3. 查看"关键设计决策"了解为什么这样设计
4. 如需深入，阅读相关模块的完整章节

---

## 🎓 学习检查清单

### 理解系统架构 ✓
- [ ] 能画出系统的整体架构图
- [ ] 能说出三种数据类型及其存储位置
- [ ] 能解释为什么需要时序数据库

### 理解业务流程 ✓
- [ ] 能描述设备从录入到数据展示的完整流程
- [ ] 能解释采集端如何获取任务
- [ ] 能说明告警是如何触发的

### 理解模块职责 ✓
- [ ] 能区分 Handler、Service、Repository 的职责
- [ ] 知道什么逻辑应该放在哪一层
- [ ] 能识别违反分层原则的代码

### 理解数据库设计 ✓
- [ ] 能说出主要表的字段和用途
- [ ] 理解为什么某些字段使用 JSONB
- [ ] 知道如何优化常见查询

### 掌握时序库使用 ✓
- [ ] 能写出基本的 PromQL 查询
- [ ] 理解标签的基数问题
- [ ] 知道如何优化查询性能

---

## 💡 常见问题 FAQ

### Q1: 为什么设备信息存 PostgreSQL，指标数据存 VictoriaMetrics？
**A**: 见 Part 1 → 2.2 数据分类与存储策略。简单来说：
- PostgreSQL: 适合低频更新、需要复杂查询的元数据
- VictoriaMetrics: 适合高频写入、按时间查询的时序数据

### Q2: 采集端如何知道要采集哪些设备？
**A**: 见 Part 1 → 3.2 采集任务配置与下发流程。采集端定时拉取任务列表，中心端会合并设备连接配置到任务中。

### Q3: 前端如何获取实时监控数据？
**A**: 见 Part 2 → 3.5.4 场景 2。前端通过中心端 API 代理查询 VictoriaMetrics，使用 PromQL 查询语言。

### Q4: 告警是如何工作的？
**A**: 见 Part 2 → 3.6 告警触发与处理流程。告警引擎定时查询时序库，评估规则，创建事件，发送通知。

### Q5: 如何添加新的插件？
**A**: 见原有文档《04-插件开发指南.md》，本系列文档主要关注数据流转和模块协作。

### Q6: 数据转发失败会丢失吗？
**A**: 当前实现会丢失。如需保证不丢失，可以：
- 采集端直连时序库
- 中心端添加持久化队列（如 Kafka）
- 采集端本地缓存失败数据

### Q7: 如何扩展系统支持更多设备？
**A**: 
1. 水平扩展采集端（增加 Sentinel 实例）
2. 时序库集群化（VictoriaMetrics Cluster）
3. 中心端无状态，可水平扩展

---

## 📝 文档维护

### 更新记录
- 2025-11-20: 创建初始版本
- 待补充: Part 2 中的数据转发流程详细说明

### 待完善内容
- [ ] 数据转发流程的详细说明（Part 2 → 3.4）
- [ ] 更多 PromQL 查询示例
- [ ] 性能调优指南
- [ ] 故障排查手册

### 贡献指南
如果你发现文档中的问题或有改进建议，请：
1. 在对应章节添加注释
2. 提交 Issue 或 PR
3. 联系文档维护者

---

## 🔗 相关文档

- [系统整体架构设计](./01-系统整体架构设计.md)
- [中心端详细设计](./02-中心端详细设计.md)
- [采集端详细设计](./03-采集端详细设计.md)
- [插件开发指南](./04-插件开发指南.md)
- [API 接口文档](./05-API接口文档.md)
- [部署运维手册](./06-部署运维手册.md)
- [前端 UI 设计方案](./07-前端UI设计方案.md)

---

## 📞 联系方式

如有疑问，请联系：
- 技术负责人: [待补充]
- 文档维护: [待补充]
- 项目仓库: [待补充]


