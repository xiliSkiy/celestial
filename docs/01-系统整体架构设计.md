# Celestial 监控系统 - 整体架构设计

## 1. 项目概述

Celestial 是一个分布式监控系统，由中心端（gravital-core）和数据采集端（orbital-sentinels）组成，支持灵活的数据流转和多种时序数据库存储。

### 1.1 项目命名寓意
- **Celestial**: 天体系统，寓意整个监控生态
- **Gravital Core**: 引力核心，负责管理、调度和协调整个系统
- **Orbital Sentinels**: 轨道哨兵，分布式部署在各个节点进行数据采集

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户层 (User Layer)                          │
├─────────────────────────────────────────────────────────────────────┤
│  Grafana Dashboard  │  Custom Web UI  │  Alert Notification        │
└────────────┬────────────────────┬──────────────────┬───────────────┘
             │                    │                  │
┌────────────▼────────────────────▼──────────────────▼───────────────┐
│                    中心端 (Gravital Core)                            │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │ 设备管理模块  │  │ 告警管理模块  │  │ 任务调度模块  │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │ 数据转发模块  │  │ API网关模块   │  │ 配置管理模块  │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │ 采集端管理    │  │ 用户认证模块  │  │ 数据展示模块  │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
└────────────┬────────────────────┬──────────────────┬───────────────┘
             │                    │                  │
    ┌────────▼─────────┐  ┌──────▼────────┐  ┌──────▼────────┐
    │   Prometheus     │  │ VictoriaMetrics│  │  ClickHouse   │
    │  (时序数据库)     │  │  (时序数据库)   │  │  (分析数据库)  │
    └──────────────────┘  └───────────────┘  └───────────────┘
             ▲                    ▲                  ▲
             │                    │                  │
    ┌────────┴────────────────────┴──────────────────┴───────────────┐
    │                      HTTP/HTTPS 协议                            │
    └────────┬────────────────────┬──────────────────┬───────────────┘
             │                    │                  │
┌────────────▼────────┐  ┌────────▼──────────┐  ┌───▼───────────────┐
│ Orbital Sentinel #1 │  │ Orbital Sentinel #2│  │ Orbital Sentinel #N│
├─────────────────────┤  ├────────────────────┤  ├────────────────────┤
│ ┌─────────────────┐ │  │ ┌─────────────────┐│  │ ┌─────────────────┐│
│ │  采集调度引擎   │ │  │ │  采集调度引擎   ││  │ │  采集调度引擎   ││
│ └─────────────────┘ │  │ └─────────────────┘│  │ └─────────────────┘│
│ ┌─────────────────┐ │  │ ┌─────────────────┐│  │ ┌─────────────────┐│
│ │  插件管理器     │ │  │ │  插件管理器     ││  │ │  插件管理器     ││
│ └─────────────────┘ │  │ └─────────────────┘│  │ └─────────────────┘│
│ ┌─────────────────┐ │  │ ┌─────────────────┐│  │ ┌─────────────────┐│
│ │  数据缓冲队列   │ │  │ │  数据缓冲队列   ││  │ │  数据缓冲队列   ││
│ └─────────────────┘ │  │ └─────────────────┘│  │ └─────────────────┘│
│ ┌─────────────────┐ │  │ ┌─────────────────┐│  │ ┌─────────────────┐│
│ │  心跳管理       │ │  │ │  心跳管理       ││  │ │  心跳管理       ││
│ └─────────────────┘ │  │ └─────────────────┘│  │ └─────────────────┘│
│      Plugins:       │  │      Plugins:       │  │      Plugins:       │
│  [SNMP][Modbus]     │  │  [OPC-UA][HTTP]     │  │  [MQTT][Custom]     │
│  [SSH][JMX]...      │  │  [Database]...      │  │  [Script]...        │
└─────────┬───────────┘  └─────────┬───────────┘  └─────────┬──────────┘
          │                        │                        │
          ▼                        ▼                        ▼
    ┌─────────────┐          ┌─────────────┐          ┌─────────────┐
    │  设备/系统   │          │  设备/系统   │          │  设备/系统   │
    └─────────────┘          └─────────────┘          └─────────────┘
```

## 3. 核心设计理念

### 3.1 分布式架构
- **中心端单点管理**: 统一的设备管理、告警管理和任务分配
- **采集端分布式部署**: 可在多个网络区域部署，支持边缘计算
- **弹性扩展**: 采集端可按需增减，中心端支持水平扩展

### 3.2 灵活的数据流
支持三种数据流模式：

#### 模式1: 直连模式（高性能场景）
```
Sentinel → Prometheus/VictoriaMetrics/ClickHouse → Grafana
```
- 优点：延迟低，性能高
- 适用：数据库网络可达，不需要中心端处理

#### 模式2: 中转模式（统一管理场景）
```
Sentinel → Gravital Core → Prometheus/VictoriaMetrics/ClickHouse → Grafana
```
- 优点：统一管理，数据清洗，告警处理
- 适用：需要统一告警、数据预处理

#### 模式3: 混合模式（推荐）
```
Sentinel → {直连数据库 + 中心端} → 数据库 → Grafana
```
- 实时数据直连，元数据/告警走中心端
- 兼顾性能和管理

### 3.3 插件化设计
- 采集端采用插件架构，支持动态加载
- 插件标准化接口，方便第三方开发
- 配置文件驱动，降低开发难度

### 3.4 高可用设计
- 中心端：支持集群部署，主备切换
- 采集端：本地缓冲，断线重连，数据补发
- 数据库：支持多种时序数据库，避免单点依赖

## 4. 技术栈建议

### 4.1 中心端 (Gravital Core)
**推荐技术栈**:
- **后端框架**: Go + Gin/Echo (高性能、并发友好)
- **数据库**: PostgreSQL (设备配置、规则) + Redis (缓存、队列)
- **消息队列**: NATS/Kafka (可选，用于数据转发)
- **前端**: Vue 3 + TypeScript + Element Plus
- **Grafana**: 集成版本 9.x+

**备选方案**:
- Python + FastAPI (快速开发，生态丰富)
- Java + Spring Boot (企业级场景)

### 4.2 采集端 (Orbital Sentinels)
**推荐技术栈**:
- **核心**: Go (跨平台、低资源占用)
- **插件系统**: Go Plugin / Hashicorp go-plugin
- **配置**: YAML/TOML
- **日志**: Zap/Logrus

### 4.3 通信协议
- **HTTP/HTTPS**: RESTful API (中心端↔采集端)
- **gRPC**: 可选，用于高频数据传输
- **WebSocket**: 实时推送配置变更

## 5. 数据流设计

### 5.1 采集端 → 中心端
```yaml
数据类型:
  - 心跳数据: 每 30s 一次
  - 采集数据: 实时或批量
  - 状态数据: 采集任务状态、插件状态
  - 日志数据: 错误日志、告警日志
```

### 5.2 中心端 → 采集端
```yaml
数据类型:
  - 采集任务配置: 设备信息、采集频率
  - 控制指令: 启动/停止采集、重载配置
  - 插件更新: 插件下载地址
```

### 5.3 数据格式
采用标准化的 JSON 格式:
```json
{
  "sentinel_id": "sentinel-001",
  "timestamp": 1698883200000,
  "metrics": [
    {
      "device_id": "device-001",
      "metric_name": "cpu_usage",
      "value": 75.5,
      "labels": {
        "host": "server-01",
        "region": "us-east"
      }
    }
  ]
}
```

## 6. 安全设计

### 6.1 认证与授权
- **采集端认证**: API Token / JWT
- **用户认证**: 用户名密码 + MFA (可选)
- **RBAC**: 角色基础的访问控制

### 6.2 通信安全
- **HTTPS**: 强制使用 TLS 1.2+
- **证书管理**: 支持自签名和 CA 签发证书
- **数据加密**: 敏感配置加密存储

### 6.3 审计日志
- 所有配置变更记录
- API 访问日志
- 告警触发记录

## 7. 部署架构建议

### 7.1 小型部署（< 100 设备）
```
单节点 Gravital Core + PostgreSQL + Redis
多个 Sentinel 按区域部署
VictoriaMetrics 单节点
```

### 7.2 中型部署（100-1000 设备）
```
Gravital Core 双节点 HA + PostgreSQL 主从 + Redis Sentinel
Sentinel 按网络分区部署
VictoriaMetrics 集群
```

### 7.3 大型部署（> 1000 设备）
```
Gravital Core 集群 (3+ 节点) + PostgreSQL 集群 + Redis 集群
Sentinel 分布式部署 + 边缘计算节点
VictoriaMetrics 集群 + ClickHouse (长期存储)
消息队列: Kafka/NATS
```

## 8. 优化建议

### 8.1 性能优化
1. **批量处理**: 采集端批量发送数据，减少 HTTP 请求
2. **数据压缩**: gzip 压缩传输数据
3. **本地缓存**: 采集端本地缓存配置，减少中心端访问
4. **异步处理**: 中心端异步处理数据转发和告警

### 8.2 可靠性优化
1. **重试机制**: 发送失败自动重试（指数退避）
2. **熔断机制**: 下游服务异常时熔断保护
3. **降级策略**: 中心端不可用时，采集端直连数据库
4. **数据持久化**: 本地队列持久化，防止数据丢失

### 8.3 可观测性
1. **自监控**: 系统本身的监控指标
2. **链路追踪**: OpenTelemetry 集成
3. **日志聚合**: ELK/Loki 集成
4. **性能分析**: pprof 支持

### 8.4 运维友好
1. **配置热更新**: 无需重启即可更新配置
2. **健康检查**: HTTP 健康检查端点
3. **优雅关闭**: 处理完在途请求后关闭
4. **版本管理**: 采集端版本管理和升级

## 9. 开发路线图

### Phase 1: MVP (最小可行产品)
- [ ] 中心端基础框架（API、数据库）
- [ ] 采集端基础框架（插件系统）
- [ ] 2-3 个基础插件（SNMP、HTTP、Ping）
- [ ] 基础 Web UI（设备管理、查看数据）
- [ ] 数据直连 Prometheus

### Phase 2: 核心功能
- [ ] 告警规则引擎
- [ ] 数据转发模块（支持 VictoriaMetrics）
- [ ] Grafana 集成
- [ ] 更多插件（Modbus、MQTT、数据库）
- [ ] 采集任务调度优化

### Phase 3: 高级功能
- [ ] ClickHouse 支持（长期存储）
- [ ] 集群部署支持
- [ ] 自定义 Dashboard
- [ ] 插件市场
- [ ] 移动端 App

### Phase 4: 企业级功能
- [ ] 多租户支持
- [ ] 高级 RBAC
- [ ] SSO 集成
- [ ] 审计和合规
- [ ] AI 智能告警

## 10. 项目结构规划

```
celestial/
├── docs/                          # 文档目录
│   ├── 架构设计/
│   ├── API文档/
│   ├── 插件开发指南/
│   └── 部署运维手册/
├── gravital-core/                 # 中心端
│   ├── cmd/                       # 启动入口
│   ├── internal/                  # 内部代码
│   │   ├── api/                   # API 层
│   │   ├── service/               # 业务逻辑层
│   │   ├── model/                 # 数据模型
│   │   ├── repository/            # 数据访问层
│   │   ├── alert/                 # 告警模块
│   │   ├── forwarder/             # 数据转发模块
│   │   └── scheduler/             # 任务调度
│   ├── web/                       # 前端代码
│   ├── config/                    # 配置文件
│   └── migrations/                # 数据库迁移
├── orbital-sentinels/             # 采集端
│   ├── cmd/                       # 启动入口
│   ├── internal/                  # 内部代码
│   │   ├── agent/                 # 采集代理
│   │   ├── plugin/                # 插件管理
│   │   ├── collector/             # 采集调度
│   │   └── sender/                # 数据发送
│   ├── plugins/                   # 插件目录
│   │   ├── snmp/
│   │   ├── modbus/
│   │   ├── http/
│   │   └── ...
│   └── config/                    # 配置文件
├── sdk/                           # 插件开发 SDK
├── deploy/                        # 部署文件
│   ├── docker/
│   ├── kubernetes/
│   └── systemd/
└── scripts/                       # 工具脚本
```

## 11. 关键指标定义

### 11.1 性能指标
- **数据采集延迟**: < 5s (99th percentile)
- **告警响应时间**: < 10s
- **中心端 API 响应**: < 100ms (95th percentile)
- **系统吞吐量**: > 10w metrics/s (单中心端节点)

### 11.2 可靠性指标
- **系统可用性**: 99.9%
- **数据完整性**: 99.99%
- **采集端存活率**: > 99%

### 11.3 资源占用
- **采集端内存**: < 100MB (空闲) / < 500MB (高负载)
- **采集端 CPU**: < 5% (空闲) / < 30% (高负载)
- **中心端内存**: < 2GB (1000 设备)
- **中心端 CPU**: < 50% (1000 设备)

