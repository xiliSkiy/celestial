# 时序数据库集成说明

## 概述

本文档说明如何集成时序数据库（VictoriaMetrics/Prometheus）来获取设备监控指标数据。

## 功能特性

### 1. 时序数据库客户端

**位置**: `gravital-core/internal/timeseries/client.go`

**功能**:
- 支持 PromQL 查询语言
- 范围查询（query_range）
- 自动计算查询步长
- 健康检查
- 完整的错误处理

**核心方法**:
```go
// 创建客户端
func NewClient(baseURL string, logger *zap.Logger) *Client

// 范围查询
func (c *Client) QueryRange(promQL string, start, end time.Time, step time.Duration) (*QueryRangeResponse, error)

// 获取设备监控指标
func (c *Client) GetDeviceMetrics(deviceID string, hours int) (*DeviceMetrics, error)

// 健康检查
func (c *Client) Health() error
```

### 2. 支持的监控指标

| 指标名称 | PromQL 查询 | 说明 |
|---------|------------|------|
| CPU 使用率 | `cpu_usage{device_id="xxx"}` | CPU 使用百分比 |
| 内存使用率 | `memory_usage{device_id="xxx"}` | 内存使用百分比 |
| 磁盘使用率 | `disk_usage{device_id="xxx"}` | 磁盘使用百分比 |
| 网络入流量 | `network_in_bytes{device_id="xxx"}` | 入站流量（字节） |
| 网络出流量 | `network_out_bytes{device_id="xxx"}` | 出站流量（字节） |

### 3. 自动步长计算

根据查询时间范围自动计算合适的步长：

| 时间范围 | 步长 | 数据点数量（约） |
|---------|------|----------------|
| ≤ 1小时 | 30秒 | 120 |
| ≤ 6小时 | 1分钟 | 360 |
| ≤ 24小时 | 5分钟 | 288 |
| ≤ 7天 | 30分钟 | 336 |
| > 7天 | 1小时 | 可变 |

## 配置说明

### 1. 配置文件

在 `config/config.yaml` 中添加时序数据库配置：

```yaml
# 时序数据库配置
timeseries:
  enabled: true
  url: "http://localhost:8428"  # VictoriaMetrics URL
  timeout: 30s
```

### 2. 配置项说明

| 配置项 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|--------|------|
| `enabled` | bool | 是 | false | 是否启用时序数据库 |
| `url` | string | 是 | - | 时序数据库地址 |
| `timeout` | duration | 否 | 30s | 查询超时时间 |

### 3. 环境变量

也可以通过环境变量配置：

```bash
export TIMESERIES_ENABLED=true
export TIMESERIES_URL=http://localhost:8428
export TIMESERIES_TIMEOUT=30s
```

## 数据流程

### 1. 查询流程

```
前端请求
  ↓
API: GET /api/v1/devices/:id/metrics?hours=24
  ↓
Handler: GetMetrics
  ↓
Service: GetMetrics
  ↓
TimeSeries Client: GetDeviceMetrics
  ↓
构建 PromQL 查询
  ↓
VictoriaMetrics: /api/v1/query_range
  ↓
解析响应数据
  ↓
格式化为前端格式
  ↓
返回 JSON 响应
```

### 2. 降级策略

如果时序数据库不可用，系统会优雅降级：

```go
if s.tsClient != nil {
    // 尝试从时序数据库查询
    metrics, err := s.tsClient.GetDeviceMetrics(deviceID, hours)
    if err != nil {
        // 查询失败，返回空数据结构
        return emptyMetrics, nil
    }
    return metrics, nil
}

// 未配置时序数据库，返回空数据结构
return emptyMetrics, nil
```

## API 响应格式

### 请求

```http
GET /api/v1/devices/1/metrics?hours=24
Authorization: Bearer <token>
```

### 响应

```json
{
  "code": 0,
  "data": {
    "device_id": "dev-12345678",
    "metrics": {
      "cpu": {
        "timestamps": [
          "2024-01-01 00:00:00",
          "2024-01-01 00:05:00",
          "2024-01-01 00:10:00"
        ],
        "values": [45.2, 52.3, 48.7]
      },
      "memory": {
        "timestamps": [
          "2024-01-01 00:00:00",
          "2024-01-01 00:05:00",
          "2024-01-01 00:10:00"
        ],
        "values": [62.5, 68.1, 65.3]
      },
      "disk": {
        "timestamps": [],
        "values": []
      },
      "network_in": {
        "timestamps": [],
        "values": []
      },
      "network_out": {
        "timestamps": [],
        "values": []
      }
    }
  }
}
```

## 部署指南

### 1. 安装 VictoriaMetrics

#### Docker 方式

```bash
docker run -d \
  --name victoria-metrics \
  -p 8428:8428 \
  -v victoria-metrics-data:/victoria-metrics-data \
  victoriametrics/victoria-metrics:latest
```

#### 二进制方式

```bash
# 下载
wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.93.0/victoria-metrics-linux-amd64-v1.93.0.tar.gz

# 解压
tar -xzf victoria-metrics-linux-amd64-v1.93.0.tar.gz

# 运行
./victoria-metrics-prod -storageDataPath=/var/lib/victoria-metrics-data
```

### 2. 配置数据转发

确保 Sentinel 采集的数据能够转发到 VictoriaMetrics：

在 `config/config.yaml` 中配置转发器：

```yaml
forwarder:
  targets:
    - name: "victoria-metrics"
      type: "victoria"
      enabled: true
      endpoint: "http://localhost:8428/api/v1/import/prometheus"
      timeout: 10s
      batch_size: 1000
```

### 3. 验证数据写入

```bash
# 查询所有指标
curl 'http://localhost:8428/api/v1/query?query=up'

# 查询特定设备的 CPU 使用率
curl 'http://localhost:8428/api/v1/query?query=cpu_usage{device_id="dev-12345678"}'
```

### 4. 启动 Gravital Core

```bash
# 确保配置文件中启用了时序数据库
./gravital-core -config config/config.yaml
```

查看日志确认初始化成功：

```
INFO  Time series database client initialized  {"url": "http://localhost:8428"}
INFO  Time series database health check passed
```

## 故障排查

### 问题 1: 无法连接到时序数据库

**错误信息**:
```
WARN  Time series database health check failed  {"error": "failed to check health: ..."}
```

**解决方案**:
1. 检查 VictoriaMetrics 是否正在运行
2. 检查配置的 URL 是否正确
3. 检查网络连接和防火墙规则

### 问题 2: 查询返回空数据

**原因**:
- 时序数据库中没有数据
- 设备 ID 不匹配
- 时间范围内没有数据

**解决方案**:
1. 验证数据是否已写入时序数据库
2. 检查 device_id 标签是否正确
3. 调整查询时间范围

### 问题 3: 查询超时

**错误信息**:
```
failed to query time series database: context deadline exceeded
```

**解决方案**:
1. 增加超时时间配置
2. 优化查询范围和步长
3. 检查时序数据库性能

## 性能优化

### 1. 查询优化

- 使用合适的时间范围
- 避免过小的步长
- 使用标签过滤减少数据量

### 2. 缓存策略

可以在前端或中间层添加缓存：

```typescript
// 前端缓存示例
const metricsCache = new Map()
const cacheKey = `${deviceId}-${hours}`

if (metricsCache.has(cacheKey)) {
  return metricsCache.get(cacheKey)
}

const metrics = await deviceApi.getDeviceMetrics(deviceId, hours)
metricsCache.set(cacheKey, metrics)
```

### 3. 批量查询

对于多个设备，可以使用批量查询：

```go
// 批量查询多个设备的 CPU 使用率
query := `cpu_usage{device_id=~"dev-1|dev-2|dev-3"}`
```

## 监控指标

### 1. 客户端指标

- 查询次数
- 查询延迟
- 错误率
- 超时次数

### 2. 数据库指标

- 存储大小
- 查询 QPS
- 内存使用
- 磁盘 I/O

## 扩展建议

### 1. 更多指标类型

添加更多监控指标：
- 进程数量
- 连接数
- 响应时间
- 错误率
- 自定义业务指标

### 2. 聚合查询

支持聚合查询：
```go
// 平均值
avg_over_time(cpu_usage{device_id="xxx"}[5m])

// 最大值
max_over_time(memory_usage{device_id="xxx"}[1h])

// 增长率
rate(network_in_bytes{device_id="xxx"}[5m])
```

### 3. 告警集成

基于时序数据触发告警：
```go
// CPU 使用率过高
cpu_usage{device_id="xxx"} > 80

// 内存使用率持续高于阈值
avg_over_time(memory_usage{device_id="xxx"}[5m]) > 90
```

### 4. 数据导出

支持导出历史数据：
- CSV 格式
- Excel 格式
- JSON 格式

## 总结

时序数据库集成为设备监控提供了：

✅ 实时数据查询
✅ 历史数据分析
✅ 高性能存储
✅ 灵活的查询语言
✅ 优雅的降级策略

所有功能已经实现并通过测试，可以正常使用。

