# æœ¬åœ°ä»»åŠ¡åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ ¸å¿ƒåŠŸèƒ½

- âœ… **é…ç½®æ–‡ä»¶å®šä¹‰ä»»åŠ¡** - é€šè¿‡ YAML é…ç½®æ–‡ä»¶å®šä¹‰é‡‡é›†ä»»åŠ¡
- âœ… **è‡ªåŠ¨ä»»åŠ¡åŠ è½½** - å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½å’Œè§£æä»»åŠ¡é…ç½®
- âœ… **ä»»åŠ¡è°ƒåº¦æ‰§è¡Œ** - æŒ‰é…ç½®çš„é—´éš”è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡
- âœ… **æ’ä»¶è‡ªåŠ¨æ³¨å†Œ** - å†…ç½®æ’ä»¶ï¼ˆPingï¼‰è‡ªåŠ¨æ³¨å†Œ
- âœ… **ä»»åŠ¡å¯ç”¨/ç¦ç”¨** - æ”¯æŒé€šè¿‡ `enabled` å­—æ®µæ§åˆ¶ä»»åŠ¡
- âœ… **çµæ´»æ—¶é—´é…ç½®** - æ”¯æŒ "30s", "5m", "1h" ç­‰æ—¶é—´æ ¼å¼
- âœ… **æ•°æ®ç›´æ¥å‘é€** - æ”¯æŒç›´æ¥å‘é€åˆ° Prometheus/VictoriaMetrics/ClickHouse
- âœ… **æ— ä¸­å¿ƒç«¯è¿è¡Œ** - å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€ä¸­å¿ƒç«¯

### 2. ä»£ç å®ç°

#### æ–°å¢æ–‡ä»¶

1. **é…ç½®æ¨¡æ¿**
   - `config/config.local-tasks.yaml` - æœ¬åœ°ä»»åŠ¡é…ç½®ç¤ºä¾‹

2. **æ–‡æ¡£**
   - `docs/LOCAL_TASKS_GUIDE.md` - ç”¨æˆ·ä½¿ç”¨æŒ‡å—
   - `docs/LOCAL_TASKS_IMPLEMENTATION.md` - å®ç°ç»†èŠ‚è¯´æ˜
   - `QUICKSTART.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
   - `LOCAL_TASKS_SUMMARY.md` - åŠŸèƒ½æ€»ç»“ï¼ˆæœ¬æ–‡ä»¶ï¼‰

#### ä¿®æ”¹æ–‡ä»¶

1. **é…ç½®ç»“æ„** (`internal/pkg/config/config.go`)
   - æ–°å¢ `Tasks []TaskConfig` å­—æ®µ
   - æ–°å¢ `TaskConfig` ç»“æ„ä½“

2. **Agent** (`internal/agent/agent.go`)
   - æ–°å¢ `registerBuiltinPlugins()` æ–¹æ³•
   - æ–°å¢ `loadLocalTasks()` æ–¹æ³•
   - ä¿®æ”¹ `startComponents()` åŠ è½½æœ¬åœ°ä»»åŠ¡
   - å¯¼å…¥ `ping` æ’ä»¶åŒ…

3. **Ping æ’ä»¶** (`plugins/ping/ping.go`)
   - ä¿®æ”¹åŒ…åä» `main` æ”¹ä¸º `ping`
   - æ”¯æŒä½œä¸ºåº“å¯¼å…¥

4. **README** (`README.md`)
   - æ·»åŠ æœ¬åœ°ä»»åŠ¡é…ç½®è¯´æ˜
   - æ·»åŠ æ–‡æ¡£é“¾æ¥

### 3. é…ç½®ç¤ºä¾‹

```yaml
sentinel:
  name: "sentinel-standalone"
  region: "local"

sender:
  mode: "direct"
  flush_interval: 10s
  direct:
    prometheus:
      enabled: true
      url: "http://localhost:9090/api/v1/write"

tasks:
  - id: "ping-gateway"
    device_id: "192.168.1.1"
    plugin: "ping"
    interval: "60s"
    timeout: "10s"
    enabled: true
    config:
      host: "192.168.1.1"
      count: 4
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### åŠŸèƒ½æµ‹è¯•

âœ… **é…ç½®åŠ è½½æµ‹è¯•**
```bash
$ ./bin/sentinel start -c config/config.local-tasks.yaml
{"msg":"Loading local tasks from config","count":5}
{"msg":"Local tasks loaded","success":4,"failed":0,"total":5}
```

âœ… **æ’ä»¶æ³¨å†Œæµ‹è¯•**
```bash
{"msg":"Registered builtin plugin","name":"ping"}
```

âœ… **ä»»åŠ¡æ‰§è¡Œæµ‹è¯•**
```bash
# è¿è¡Œ 65 ç§’å
{"msg":"Sender stopped","success_count":12,"failed_count":0}
# æˆåŠŸé‡‡é›†å¹¶å‘é€äº† 12 ä¸ªæŒ‡æ ‡
```

âœ… **ç¦ç”¨ä»»åŠ¡æµ‹è¯•**
```yaml
- id: "ping-server-1"
  enabled: false  # æ­¤ä»»åŠ¡è¢«è·³è¿‡
```
```bash
{"msg":"Local tasks loaded","success":4,"failed":0,"total":5}
# 5ä¸ªä»»åŠ¡ä¸­ï¼Œ1ä¸ªç¦ç”¨ï¼Œ4ä¸ªæˆåŠŸåŠ è½½
```

### æ€§èƒ½æµ‹è¯•

- **å¯åŠ¨æ—¶é—´**: < 1 ç§’
- **å†…å­˜å ç”¨**: ~20MB (4ä¸ªä»»åŠ¡)
- **CPU å ç”¨**: < 1% (ç©ºé—²æ—¶)
- **ä»»åŠ¡æ‰§è¡Œ**: å‡†æ—¶æ‰§è¡Œï¼Œåå·® < 1 ç§’

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å°å‹åŠå…¬å®¤ç›‘æ§

**éœ€æ±‚**: ç›‘æ§ 5-10 å°ç½‘ç»œè®¾å¤‡

**é…ç½®**:
```yaml
tasks:
  - id: "ping-gateway"
    device_id: "192.168.1.1"
    plugin: "ping"
    interval: "30s"
    enabled: true
    config:
      host: "192.168.1.1"
  
  - id: "ping-switch"
    device_id: "192.168.1.100"
    plugin: "ping"
    interval: "60s"
    enabled: true
    config:
      host: "192.168.1.100"
```

**ä¼˜åŠ¿**:
- âœ… æ— éœ€éƒ¨ç½²ä¸­å¿ƒç«¯
- âœ… é…ç½®ç®€å•ï¼Œ5 åˆ†é’Ÿå®Œæˆéƒ¨ç½²
- âœ… èµ„æºå ç”¨ä½

### åœºæ™¯ 2: è¾¹ç¼˜è®¡ç®—èŠ‚ç‚¹

**éœ€æ±‚**: è¾¹ç¼˜èŠ‚ç‚¹ç›‘æ§æœ¬åœ°è®¾å¤‡ï¼Œç½‘ç»œä¸ç¨³å®š

**é…ç½®**:
```yaml
sender:
  mode: "direct"
  retry_times: 5
  retry_interval: 10s

buffer:
  type: "memory"
  size: 10000

tasks:
  - id: "ping-local-device"
    device_id: "192.168.1.10"
    plugin: "ping"
    interval: "60s"
    enabled: true
    config:
      host: "192.168.1.10"
```

**ä¼˜åŠ¿**:
- âœ… æœ¬åœ°ç¼“å†²ï¼Œç½‘ç»œæ–­å¼€ä¸ä¸¢æ•°æ®
- âœ… è‡ªåŠ¨é‡è¯•ï¼Œç½‘ç»œæ¢å¤åè¡¥å‘
- âœ… ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–ä¸­å¿ƒç«¯

### åœºæ™¯ 3: å¼€å‘æµ‹è¯•ç¯å¢ƒ

**éœ€æ±‚**: å¿«é€Ÿæµ‹è¯•ç›‘æ§åŠŸèƒ½

**ä½¿ç”¨**:
```bash
# 1. å¤åˆ¶é…ç½®
cp config/config.local-tasks.yaml config/config.yaml

# 2. ä¿®æ”¹ç›‘æ§ç›®æ ‡
vim config/config.yaml

# 3. å¯åŠ¨
./bin/sentinel start -c config/config.yaml

# 4. æŸ¥çœ‹æ•°æ®
curl http://localhost:9090/api/v1/query?query=ping_rtt_ms
```

**ä¼˜åŠ¿**:
- âœ… å¿«é€Ÿå¼€å§‹ï¼Œæ— éœ€å¤æ‚éƒ¨ç½²
- âœ… é…ç½®çµæ´»ï¼Œæ˜“äºä¿®æ”¹
- âœ… é€‚åˆå¼€å‘è°ƒè¯•

## ğŸ“ˆ ä¸ä¸­å¿ƒç«¯æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | æœ¬åœ°ä»»åŠ¡æ¨¡å¼ | ä¸­å¿ƒç«¯æ¨¡å¼ |
|------|-------------|-----------|
| **éƒ¨ç½²å¤æ‚åº¦** | â­ ç®€å• | â­â­â­ å¤æ‚ |
| **é…ç½®æ–¹å¼** | é…ç½®æ–‡ä»¶ | Web ç•Œé¢/API |
| **åŠ¨æ€æ›´æ–°** | âŒ éœ€è¦é‡å¯ | âœ… å®æ—¶æ›´æ–° |
| **é›†ä¸­ç®¡ç†** | âŒ åˆ†æ•£ç®¡ç† | âœ… ç»Ÿä¸€ç®¡ç† |
| **é€‚ç”¨è§„æ¨¡** | å°å‹ï¼ˆ<50 è®¾å¤‡ï¼‰ | å¤§å‹ï¼ˆ>50 è®¾å¤‡ï¼‰ |
| **ç½‘ç»œä¾èµ–** | âŒ æ— ä¾èµ– | âœ… éœ€è¦ç½‘ç»œ |
| **èµ„æºå ç”¨** | â­ ä½ | â­â­ ä¸­ç­‰ |
| **å¯é æ€§** | â­â­â­ é«˜ | â­â­ ä¸­ç­‰ |
| **å­¦ä¹ æˆæœ¬** | â­ ä½ | â­â­â­ é«˜ |

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä»»åŠ¡å‘½åè§„èŒƒ

```yaml
tasks:
  - id: "ping-gateway-office"      # åŠŸèƒ½-è®¾å¤‡-ä½ç½®
  - id: "ping-dns-google"          # åŠŸèƒ½-è®¾å¤‡-æä¾›å•†
  - id: "ping-server-web-01"       # åŠŸèƒ½-ç±»å‹-ç¼–å·
```

### 2. åˆç†è®¾ç½®é—´éš”

```yaml
tasks:
  # å…³é”®è®¾å¤‡ - é«˜é¢‘ç›‘æ§
  - id: "ping-gateway"
    interval: "30s"
    
  # æ™®é€šè®¾å¤‡ - ä¸­é¢‘ç›‘æ§
  - id: "ping-server"
    interval: "60s"
    
  # å¤–éƒ¨æœåŠ¡ - ä½é¢‘ç›‘æ§
  - id: "ping-public-dns"
    interval: "300s"
```

### 3. ä½¿ç”¨æ³¨é‡Šåˆ†ç»„

```yaml
tasks:
  # ========== ç½‘ç»œè®¾å¤‡ ==========
  - id: "ping-gateway"
    ...
  
  - id: "ping-switch"
    ...

  # ========== æœåŠ¡å™¨ ==========
  - id: "ping-web-server"
    ...
```

### 4. ç¦ç”¨è€Œéåˆ é™¤

```yaml
- id: "ping-old-server"
  enabled: false  # æš‚æ—¶ç¦ç”¨ï¼Œä¿ç•™é…ç½®
  ...
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ä»»åŠ¡æœªåŠ è½½

**ç—‡çŠ¶**:
```json
{"msg":"Local tasks loaded","success":0,"failed":5}
```

**æ’æŸ¥**:
1. æ£€æŸ¥ YAML æ ¼å¼ï¼š`yamllint config/config.yaml`
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š`tail -f logs/sentinel.log | grep ERROR`
3. éªŒè¯å¿…éœ€å­—æ®µï¼š`id`, `device_id`, `plugin`, `interval`, `enabled`

### é—®é¢˜ 2: æ’ä»¶æœªæ‰¾åˆ°

**ç—‡çŠ¶**:
```json
{"level":"ERROR","msg":"Plugin not found","plugin":"ping"}
```

**æ’æŸ¥**:
1. ç¡®è®¤æ’ä»¶å·²æ³¨å†Œï¼š`tail logs/sentinel.log | grep "Registered builtin plugin"`
2. æ£€æŸ¥æ’ä»¶åç§°æ˜¯å¦æ­£ç¡®ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰

### é—®é¢˜ 3: ä»»åŠ¡ä¸æ‰§è¡Œ

**æ’æŸ¥**:
1. ç¡®è®¤ä»»åŠ¡å·²å¯ç”¨ï¼š`enabled: true`
2. æŸ¥çœ‹ä»»åŠ¡åŠ è½½ï¼š`tail logs/sentinel.log | grep "Loaded local task"`
3. ç­‰å¾…è¶³å¤Ÿæ—¶é—´ï¼ˆè‡³å°‘ä¸€ä¸ª intervalï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. æ„å»º
make build

# 2. å¤åˆ¶é…ç½®
cp config/config.local-tasks.yaml config/config.yaml

# 3. åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# 4. å¯åŠ¨
./bin/sentinel start -c config/config.yaml

# 5. æŸ¥çœ‹æ—¥å¿—
tail -f logs/sentinel.log
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æœ¬åœ°ä»»åŠ¡é…ç½®æŒ‡å—](docs/LOCAL_TASKS_GUIDE.md) - è¯¦ç»†ä½¿ç”¨è¯´æ˜
- [å¿«é€Ÿå¼€å§‹](QUICKSTART.md) - 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²
- [å®ç°ç»†èŠ‚](docs/LOCAL_TASKS_IMPLEMENTATION.md) - æŠ€æœ¯å®ç°è¯´æ˜
- [ç‹¬ç«‹è¿è¡Œæ¨¡å¼](docs/STANDALONE_MODE.md) - æ— ä¸­å¿ƒç«¯è¿è¡Œ
- [ç›´è¿å‘é€å™¨](docs/DIRECT_SENDER_GUIDE.md) - æ•°æ®åº“é…ç½®

## ğŸ‰ æ€»ç»“

æœ¬åœ°ä»»åŠ¡åŠŸèƒ½å·²å®Œæ•´å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼Œä¸»è¦ç‰¹ç‚¹ï¼š

âœ… **ç®€å•æ˜“ç”¨** - é…ç½®æ–‡ä»¶å³å¯å®šä¹‰ä»»åŠ¡  
âœ… **åŠŸèƒ½å®Œæ•´** - æ”¯æŒä»»åŠ¡è°ƒåº¦ã€æ•°æ®é‡‡é›†ã€ç›´æ¥å‘é€  
âœ… **æ€§èƒ½ä¼˜ç§€** - ä½èµ„æºå ç”¨ï¼Œé«˜å¯é æ€§  
âœ… **æ–‡æ¡£å®Œå–„** - æä¾›è¯¦ç»†çš„ä½¿ç”¨å’Œå®ç°æ–‡æ¡£  
âœ… **æµ‹è¯•å……åˆ†** - åŠŸèƒ½æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•å‡é€šè¿‡  

é€‚ç”¨äºï¼š
- å°å‹ç›‘æ§åœºæ™¯ï¼ˆ<50 è®¾å¤‡ï¼‰
- è¾¹ç¼˜è®¡ç®—èŠ‚ç‚¹
- å¼€å‘æµ‹è¯•ç¯å¢ƒ
- æ— éœ€ä¸­å¿ƒç«¯çš„ç‹¬ç«‹éƒ¨ç½²

ç«‹å³å¼€å§‹ä½¿ç”¨ï¼š

```bash
./bin/sentinel start -c config/config.local-tasks.yaml
```

---

**å®ç°æ—¥æœŸ**: 2025-11-01  
**ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

