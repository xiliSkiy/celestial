# é‡‡é›†ç«¯ä»»åŠ¡è·å–ä¸æ•°æ®é‡‡é›†æµç¨‹

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Orbital Sentinels é‡‡é›†ç«¯å¦‚ä½•è·å–ä»»åŠ¡å¹¶æ‰§è¡Œæ•°æ®é‡‡é›†ã€‚

## ğŸ“‹ ç›®å½•

- [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
- [ä»»åŠ¡è·å–æ–¹å¼](#ä»»åŠ¡è·å–æ–¹å¼)
- [æ•°æ®é‡‡é›†æµç¨‹](#æ•°æ®é‡‡é›†æµç¨‹)
- [é…ç½®æ–¹å¼](#é…ç½®æ–¹å¼)
- [å®é™…ç¤ºä¾‹](#å®é™…ç¤ºä¾‹)

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Orbital Sentinel (é‡‡é›†ç«¯)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  å¿ƒè·³ç®¡ç†å™¨   â”‚      â”‚  ä»»åŠ¡è°ƒåº¦å™¨   â”‚                     â”‚
â”‚  â”‚ (Heartbeat)  â”‚      â”‚ (Scheduler)  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚         â”‚                     â”‚                              â”‚
â”‚         â”‚ 1. å®šæœŸå¿ƒè·³          â”‚ 2. æ‰§è¡Œä»»åŠ¡                   â”‚
â”‚         â”‚                     â”‚                              â”‚
â”‚         â–¼                     â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚         æ’ä»¶ç®¡ç†å™¨ (Plugin Manager)   â”‚                    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚                    â”‚
â”‚  â”‚  â”‚ Ping â”‚  â”‚ SNMP â”‚  â”‚ HTTP â”‚ ...  â”‚                    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                    â”‚ 3. é‡‡é›†æ•°æ®                             â”‚
â”‚                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚         æ•°æ®ç¼“å†²åŒº (Buffer)          â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                    â”‚ 4. æ‰¹é‡å‘é€                             â”‚
â”‚                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚         æ•°æ®å‘é€å™¨ (Sender)          â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                    â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Prometheus / VictoriaMetrics  â”‚
        â”‚      / ClickHouse / Core       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ä»»åŠ¡è·å–æ–¹å¼

ç›®å‰ Orbital Sentinels æ”¯æŒä¸‰ç§ä»»åŠ¡è·å–æ–¹å¼ï¼š

### æ–¹å¼ 1: ä»ä¸­å¿ƒç«¯æ‹‰å–ï¼ˆCore æ¨¡å¼ï¼‰â­

**é€‚ç”¨åœºæ™¯**: æœ‰ä¸­å¿ƒç«¯çš„ç”Ÿäº§ç¯å¢ƒ

```yaml
# config.yaml
sender:
  mode: "core"  # æˆ– "hybrid"

core:
  url: "https://gravital-core.example.com"
  api_token: "your-token"

collector:
  task_fetch_interval: 60s  # æ¯ 60 ç§’æ‹‰å–ä¸€æ¬¡ä»»åŠ¡
```

**å·¥ä½œæµç¨‹**:

```
1. Sentinel å¯åŠ¨
   â†“
2. å®šæœŸå‘ä¸­å¿ƒç«¯å‘é€å¿ƒè·³ (æ¯ 30s)
   â†“
3. å®šæœŸä»ä¸­å¿ƒç«¯æ‹‰å–ä»»åŠ¡åˆ—è¡¨ (æ¯ 60s)
   â†“
4. ä¸­å¿ƒç«¯è¿”å›ä»»åŠ¡é…ç½®
   {
     "tasks": [
       {
         "task_id": "ping-router-1",
         "device_id": "192.168.1.1",
         "plugin_name": "ping",
         "device_config": {
           "host": "192.168.1.1",
           "count": 4
         },
         "interval": "60s"
       }
     ]
   }
   â†“
5. Scheduler æ›´æ–°ä»»åŠ¡åˆ—è¡¨
   â†“
6. æŒ‰ç…§ interval å®šæ—¶æ‰§è¡Œä»»åŠ¡
   â†“
7. é‡‡é›†æ•°æ® â†’ ç¼“å†² â†’ å‘é€
```

**ä¼˜ç‚¹**:
- âœ… é›†ä¸­ç®¡ç†ï¼Œç»Ÿä¸€é…ç½®
- âœ… åŠ¨æ€æ›´æ–°ä»»åŠ¡ï¼Œæ— éœ€é‡å¯
- âœ… æ”¯æŒå¤§è§„æ¨¡éƒ¨ç½²

**ç¼ºç‚¹**:
- âŒ ä¾èµ–ä¸­å¿ƒç«¯
- âŒ éœ€è¦ç½‘ç»œè¿æ¥

### æ–¹å¼ 2: æœ¬åœ°é…ç½®æ–‡ä»¶ï¼ˆDirect æ¨¡å¼ï¼‰â­â­

**é€‚ç”¨åœºæ™¯**: æ— ä¸­å¿ƒç«¯çš„ç‹¬ç«‹éƒ¨ç½²ï¼Œè¾¹ç¼˜è®¡ç®—

**å½“å‰çŠ¶æ€**: ğŸš§ **éœ€è¦æ‰‹åŠ¨æ·»åŠ ä»»åŠ¡ä»£ç **

ç”±äºç›®å‰é…ç½®æ–‡ä»¶ä¸æ”¯æŒç›´æ¥å®šä¹‰ä»»åŠ¡ï¼Œéœ€è¦åœ¨ä»£ç ä¸­æ‰‹åŠ¨æ·»åŠ ã€‚è®©æˆ‘åˆ›å»ºä¸€ä¸ªç¤ºä¾‹ï¼š

```go
// åœ¨ agent.go çš„ Start() æ–¹æ³•ä¸­æ·»åŠ 
func (a *Agent) Start() error {
    // ... ç°æœ‰åˆå§‹åŒ–ä»£ç  ...
    
    // æ‰‹åŠ¨æ·»åŠ é‡‡é›†ä»»åŠ¡ï¼ˆDirect æ¨¡å¼ä¸‹ï¼‰
    if a.config.Sender.Mode == "direct" {
        a.addLocalTasks()
    }
    
    // ... å…¶ä»–ä»£ç  ...
}

func (a *Agent) addLocalTasks() {
    // æ·»åŠ  Ping ä»»åŠ¡
    task1 := &plugin.CollectionTask{
        TaskID:     "local-ping-gateway",
        DeviceID:   "192.168.1.1",
        PluginName: "ping",
        DeviceConfig: map[string]interface{}{
            "host":     "192.168.1.1",
            "count":    4,
            "interval": "1s",
            "timeout":  "5s",
        },
        Timeout: 10 * time.Second,
    }
    a.scheduler.AddTask(task1, 60*time.Second) // æ¯ 60 ç§’æ‰§è¡Œä¸€æ¬¡
    
    // æ·»åŠ æ›´å¤šä»»åŠ¡...
}
```

**æœªæ¥è®¡åˆ’**: æ”¯æŒé…ç½®æ–‡ä»¶å®šä¹‰ä»»åŠ¡

```yaml
# è®¡åˆ’æ”¯æŒçš„é…ç½®æ ¼å¼
tasks:
  - id: "ping-gateway"
    device_id: "192.168.1.1"
    plugin: "ping"
    interval: 60s
    config:
      host: "192.168.1.1"
      count: 4
      timeout: 5s
      
  - id: "ping-dns"
    device_id: "8.8.8.8"
    plugin: "ping"
    interval: 300s
    config:
      host: "8.8.8.8"
      count: 10
```

### æ–¹å¼ 3: æ‰‹åŠ¨è§¦å‘ï¼ˆTrigger æ¨¡å¼ï¼‰â­â­â­

**é€‚ç”¨åœºæ™¯**: æµ‹è¯•ã€è°ƒè¯•ã€æ‰‹åŠ¨å·¡æ£€

```bash
# ç«‹å³æ‰§è¡Œä¸€æ¬¡é‡‡é›†
./bin/sentinel trigger ping 8.8.8.8 -n 4
```

**ç‰¹ç‚¹**:
- âœ… æ— éœ€é…ç½®
- âœ… ç«‹å³æ‰§è¡Œ
- âœ… é€‚åˆæµ‹è¯•
- âŒ ä¸æŒä¹…åŒ–
- âŒ ä¸è‡ªåŠ¨é‡å¤

## ğŸ”§ æ•°æ®é‡‡é›†æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä»»åŠ¡è°ƒåº¦                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Scheduler æ£€æŸ¥ä»»åŠ¡åˆ—è¡¨                                        â”‚
â”‚       â†“                                                       â”‚
â”‚  å‘ç°éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ (NextRun <= Now)                           â”‚
â”‚       â†“                                                       â”‚
â”‚  æäº¤åˆ° WorkerPool                                            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä»»åŠ¡æ‰§è¡Œ                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Worker ä»é˜Ÿåˆ—è·å–ä»»åŠ¡                                         â”‚
â”‚       â†“                                                       â”‚
â”‚  æ ¹æ® PluginName è·å–æ’ä»¶å®ä¾‹                                  â”‚
â”‚       â†“                                                       â”‚
â”‚  è°ƒç”¨ Plugin.Collect(ctx, task)                              â”‚
â”‚       â†“                                                       â”‚
â”‚  æ’ä»¶æ‰§è¡Œå…·ä½“çš„é‡‡é›†é€»è¾‘                                         â”‚
â”‚   - Ping: æ‰§è¡Œ ICMP Echo                                     â”‚
â”‚   - SNMP: æŸ¥è¯¢ OID                                           â”‚
â”‚   - HTTP: å‘é€ HTTP è¯·æ±‚                                     â”‚
â”‚       â†“                                                       â”‚
â”‚  è¿”å› Metrics æ•°ç»„                                            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ•°æ®å¤„ç†                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Metrics æ·»åŠ æ ‡ç­¾                                             â”‚
â”‚   - device_id                                                â”‚
â”‚   - sentinel_id                                              â”‚
â”‚   - region                                                   â”‚
â”‚       â†“                                                       â”‚
â”‚  æ¨é€åˆ° Buffer                                                â”‚
â”‚       â†“                                                       â”‚
â”‚  Buffer ç´¯ç§¯åˆ°ä¸€å®šæ•°é‡æˆ–æ—¶é—´                                   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ•°æ®å‘é€                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Sender ä» Buffer æ‰¹é‡è¯»å–                                    â”‚
â”‚       â†“                                                       â”‚
â”‚  æ ¹æ® Mode é€‰æ‹©å‘é€ç›®æ ‡:                                       â”‚
â”‚   - Core: å‘é€åˆ°ä¸­å¿ƒç«¯                                        â”‚
â”‚   - Direct: å‘é€åˆ°æ—¶åºæ•°æ®åº“                                  â”‚
â”‚   - Hybrid: åŒæ—¶å‘é€åˆ°ä¸¤è€…                                    â”‚
â”‚       â†“                                                       â”‚
â”‚  æ•°æ®å‹ç¼© (Snappy/Gzip)                                       â”‚
â”‚       â†“                                                       â”‚
â”‚  HTTP/TCP å‘é€                                               â”‚
â”‚       â†“                                                       â”‚
â”‚  å¤±è´¥é‡è¯• (æœ€å¤š 3 æ¬¡)                                         â”‚
â”‚       â†“                                                       â”‚
â”‚  ç†”æ–­ä¿æŠ¤ (è¿ç»­å¤±è´¥è§¦å‘)                                       â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†æ­¥éª¤è¯´æ˜

#### æ­¥éª¤ 1: ä»»åŠ¡è°ƒåº¦

```go
// internal/scheduler/scheduler.go

// æ¯ç§’æ£€æŸ¥ä¸€æ¬¡ä»»åŠ¡
func (s *Scheduler) scheduleLoop() {
    ticker := time.NewTicker(1 * time.Second)
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:
            s.checkAndExecuteTasks()  // æ£€æŸ¥å¹¶æ‰§è¡Œåˆ°æœŸä»»åŠ¡
        case <-s.ctx.Done():
            return
        }
    }
}

// æ£€æŸ¥å“ªäº›ä»»åŠ¡éœ€è¦æ‰§è¡Œ
func (s *Scheduler) checkAndExecuteTasks() {
    now := time.Now()
    
    for _, task := range s.tasks {
        // å¦‚æœä»»åŠ¡åˆ°æœŸä¸”ä¸åœ¨è¿è¡Œä¸­
        if task.NextRun.Before(now) && task.LastStatus != TaskStatusRunning {
            s.executeTask(task)  // æäº¤åˆ°å·¥ä½œæ± 
        }
    }
}
```

#### æ­¥éª¤ 2: æ’ä»¶æ‰§è¡Œé‡‡é›†

```go
// è·å–æ’ä»¶
plugin := pluginManager.GetPlugin("ping")

// åˆ›å»ºä»»åŠ¡
task := &CollectionTask{
    TaskID:     "ping-1",
    DeviceID:   "8.8.8.8",
    PluginName: "ping",
    DeviceConfig: map[string]interface{}{
        "host":  "8.8.8.8",
        "count": 4,
    },
}

// æ‰§è¡Œé‡‡é›†
metrics, err := plugin.Collect(ctx, task)

// è¿”å›çš„ metrics:
// [
//   {Name: "ping_rtt_ms", Value: 10.5, Labels: {...}},
//   {Name: "ping_packet_loss", Value: 0.0, Labels: {...}},
//   {Name: "ping_reachable", Value: 1.0, Labels: {...}}
// ]
```

#### æ­¥éª¤ 3: æ•°æ®ç¼“å†²

```go
// æ¨é€åˆ°ç¼“å†²åŒº
buffer.Push(metrics)

// ç¼“å†²åŒºé…ç½®
buffer:
  type: "memory"
  size: 10000        # æœ€å¤šç¼“å­˜ 10000 ä¸ªæŒ‡æ ‡
  flush_interval: 10s  # æ¯ 10 ç§’åˆ·æ–°ä¸€æ¬¡
```

#### æ­¥éª¤ 4: æ‰¹é‡å‘é€

```go
// å®šæœŸä»ç¼“å†²åŒºè¯»å–
metrics := buffer.Pop(1000)  // æ‰¹é‡è¯»å– 1000 ä¸ª

// å‘é€åˆ°ç›®æ ‡
sender.Send(ctx, metrics)

// å‘é€é…ç½®
sender:
  batch_size: 1000      # æ¯æ‰¹ 1000 ä¸ª
  flush_interval: 10s   # æ¯ 10 ç§’å‘é€ä¸€æ¬¡
  retry_times: 3        # å¤±è´¥é‡è¯• 3 æ¬¡
```

## âš™ï¸ é…ç½®æ–¹å¼

### å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# config.yaml

sentinel:
  id: ""  # è‡ªåŠ¨ç”Ÿæˆ
  name: "sentinel-office-1"
  region: "office-beijing"

# ä¸­å¿ƒç«¯é…ç½®ï¼ˆCore/Hybrid æ¨¡å¼éœ€è¦ï¼‰
core:
  url: "https://gravital-core.example.com"
  api_token: "your-token"

# å¿ƒè·³é…ç½®
heartbeat:
  interval: 30s    # æ¯ 30 ç§’å‘é€å¿ƒè·³
  timeout: 10s
  retry_times: 3

# é‡‡é›†å™¨é…ç½®
collector:
  worker_pool_size: 10          # å¹¶å‘æ‰§è¡Œ 10 ä¸ªä»»åŠ¡
  task_fetch_interval: 60s      # æ¯ 60 ç§’ä»ä¸­å¿ƒç«¯æ‹‰å–ä»»åŠ¡
  max_execution_time: 300s      # å•ä¸ªä»»åŠ¡æœ€é•¿æ‰§è¡Œ 5 åˆ†é’Ÿ

# ç¼“å†²é…ç½®
buffer:
  type: "memory"
  size: 10000
  flush_interval: 10s

# å‘é€å™¨é…ç½®
sender:
  mode: "direct"  # core / direct / hybrid
  batch_size: 1000
  flush_interval: 10s
  timeout: 30s
  retry_times: 3
  retry_interval: 5s
  
  # Direct æ¨¡å¼é…ç½®
  direct:
    prometheus:
      enabled: true
      url: "http://localhost:9090/api/v1/write"

# æ’ä»¶é…ç½®
plugins:
  directory: "./plugins"
  auto_reload: false

# æ—¥å¿—é…ç½®
logging:
  level: info
  format: json
  output: both
  file_path: "./logs/sentinel.log"
```

## ğŸ“ å®é™…ç¤ºä¾‹

### ç¤ºä¾‹ 1: Core æ¨¡å¼ï¼ˆä»ä¸­å¿ƒç«¯è·å–ä»»åŠ¡ï¼‰

```bash
# 1. é…ç½®
cat > config.yaml <<EOF
sentinel:
  name: "sentinel-1"
  
core:
  url: "http://gravital-core:8080"
  api_token: "abc123"
  
collector:
  task_fetch_interval: 60s
  
sender:
  mode: "core"
EOF

# 2. å¯åŠ¨
./bin/sentinel start -c config.yaml

# 3. æ—¥å¿—è¾“å‡º
# {"msg":"Fetching tasks from core"}
# {"msg":"Received 5 tasks from core"}
# {"msg":"Updated tasks","count":5}
# {"msg":"Task succeeded","task_id":"ping-router-1","metrics":3}
# {"msg":"Sent to core","metrics":150}
```

### ç¤ºä¾‹ 2: Direct æ¨¡å¼ï¼ˆæœ¬åœ°ä»»åŠ¡ + ç›´è¿æ•°æ®åº“ï¼‰

**å½“å‰æ–¹å¼**ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰:

```go
// åœ¨ internal/agent/agent.go ä¸­æ·»åŠ 

func (a *Agent) Start() error {
    // ... åˆå§‹åŒ–ä»£ç  ...
    
    // Direct æ¨¡å¼ä¸‹æ·»åŠ æœ¬åœ°ä»»åŠ¡
    if a.config.Sender.Mode == "direct" {
        logger.Info("Adding local tasks for direct mode")
        a.addLocalTasks()
    }
    
    // ... å…¶ä»–ä»£ç  ...
}

func (a *Agent) addLocalTasks() {
    // ä»»åŠ¡ 1: Ping ç½‘å…³
    task1 := &plugin.CollectionTask{
        TaskID:     "ping-gateway",
        DeviceID:   "192.168.1.1",
        PluginName: "ping",
        DeviceConfig: map[string]interface{}{
            "host":     "192.168.1.1",
            "count":    4,
            "interval": "1s",
            "timeout":  "5s",
        },
        Timeout: 10 * time.Second,
    }
    a.scheduler.AddTask(task1, 60*time.Second)
    logger.Info("Added task", zap.String("task_id", "ping-gateway"))
    
    // ä»»åŠ¡ 2: Ping DNS
    task2 := &plugin.CollectionTask{
        TaskID:     "ping-dns",
        DeviceID:   "8.8.8.8",
        PluginName: "ping",
        DeviceConfig: map[string]interface{}{
            "host":     "8.8.8.8",
            "count":    4,
            "interval": "1s",
            "timeout":  "5s",
        },
        Timeout: 10 * time.Second,
    }
    a.scheduler.AddTask(task2, 300*time.Second)
    logger.Info("Added task", zap.String("task_id", "ping-dns"))
}
```

ç„¶åé…ç½®ï¼š

```yaml
sender:
  mode: "direct"
  direct:
    prometheus:
      enabled: true
      url: "http://localhost:9090/api/v1/write"
```

### ç¤ºä¾‹ 3: Trigger æ¨¡å¼ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰

```bash
# å•æ¬¡æ‰§è¡Œ
./bin/sentinel trigger ping 192.168.1.1

# æ‰¹é‡æ‰§è¡Œ
for ip in 192.168.1.{1..10}; do
  ./bin/sentinel trigger ping $ip -n 1
done

# å®šæ—¶æ‰§è¡Œï¼ˆä½¿ç”¨ cronï¼‰
*/5 * * * * /path/to/sentinel trigger ping 192.168.1.1 >> /var/log/ping.log
```

## ğŸ”® æœªæ¥æ”¹è¿›

### è®¡åˆ’æ”¯æŒçš„åŠŸèƒ½

1. **é…ç½®æ–‡ä»¶å®šä¹‰ä»»åŠ¡** (v1.2.0)
```yaml
tasks:
  - id: "ping-gateway"
    plugin: "ping"
    device_id: "192.168.1.1"
    interval: 60s
    config:
      host: "192.168.1.1"
      count: 4
```

2. **HTTP API æ·»åŠ ä»»åŠ¡** (v1.3.0)
```bash
curl -X POST http://localhost:8080/api/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "ping-1",
    "plugin": "ping",
    "device_id": "192.168.1.1",
    "config": {"host": "192.168.1.1"}
  }'
```

3. **ä»»åŠ¡æ¨¡æ¿** (v1.3.0)
```yaml
task_templates:
  - name: "ping-template"
    plugin: "ping"
    interval: 60s
    config:
      count: 4
      timeout: 5s

tasks:
  - template: "ping-template"
    device_id: "192.168.1.1"
    config:
      host: "192.168.1.1"
```

4. **åŠ¨æ€å‘ç°** (v2.0.0)
- è‡ªåŠ¨å‘ç°ç½‘ç»œè®¾å¤‡
- æ ¹æ®æ ‡ç­¾è‡ªåŠ¨åˆ›å»ºä»»åŠ¡
- æ”¯æŒ Kubernetes Service Discovery

## ğŸ“š æ€»ç»“

### å½“å‰æ”¯æŒçš„ä»»åŠ¡è·å–æ–¹å¼

| æ–¹å¼ | çŠ¶æ€ | é€‚ç”¨åœºæ™¯ | é…ç½®éš¾åº¦ |
|------|------|---------|---------|
| ä¸­å¿ƒç«¯æ‹‰å– | âœ… å®Œæ•´æ”¯æŒ | ç”Ÿäº§ç¯å¢ƒï¼Œé›†ä¸­ç®¡ç† | ç®€å• |
| æœ¬åœ°é…ç½® | ğŸš§ éœ€è¦ä»£ç  | è¾¹ç¼˜è®¡ç®—ï¼Œç‹¬ç«‹éƒ¨ç½² | ä¸­ç­‰ |
| æ‰‹åŠ¨è§¦å‘ | âœ… å®Œæ•´æ”¯æŒ | æµ‹è¯•ï¼Œè°ƒè¯•ï¼Œæ‰‹åŠ¨å·¡æ£€ | éå¸¸ç®€å• |

### æ¨èæ–¹æ¡ˆ

1. **æœ‰ä¸­å¿ƒç«¯**: ä½¿ç”¨ Core æ¨¡å¼ï¼Œä»ä¸­å¿ƒç«¯æ‹‰å–ä»»åŠ¡
2. **æ— ä¸­å¿ƒç«¯**: 
   - çŸ­æœŸï¼šä¿®æ”¹ä»£ç æ·»åŠ æœ¬åœ°ä»»åŠ¡
   - é•¿æœŸï¼šç­‰å¾… v1.2.0 æ”¯æŒé…ç½®æ–‡ä»¶å®šä¹‰ä»»åŠ¡
3. **æµ‹è¯•/è°ƒè¯•**: ä½¿ç”¨ Trigger å‘½ä»¤æ‰‹åŠ¨è§¦å‘

### å¿«é€Ÿå¼€å§‹

```bash
# 1. æµ‹è¯•æ’ä»¶
./bin/sentinel trigger ping 8.8.8.8

# 2. å¯åŠ¨æœåŠ¡ï¼ˆéœ€è¦ä¸­å¿ƒç«¯ï¼‰
./bin/sentinel start -c config.yaml

# 3. æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
tail -f logs/sentinel.log | grep "Task succeeded"
```

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒå…¶ä»–æ–‡æ¡£æˆ–æäº¤ Issueï¼

