# å‘Šè­¦å¼•æ“ VictoriaMetrics é›†æˆ - å®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è¿°

**ä»»åŠ¡**: ä¿®æ”¹å‘Šè­¦å¼•æ“ä»æ—¶åºæ•°æ®åº“ï¼ˆVictoriaMetricsï¼‰æŸ¥è¯¢æŒ‡æ ‡æ•°æ®
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**æ—¥æœŸ**: 2025-11-23

---

## ğŸ¯ å®æ–½ç›®æ ‡

è§£å†³å‘Šè­¦å¼•æ“æ•°æ®æºä¸ä¸€è‡´é—®é¢˜ï¼š
- âŒ **æ—§æ–¹æ¡ˆ**: æŸ¥è¯¢ PostgreSQL `devices.status` å­—æ®µï¼ˆå»¶è¿Ÿã€ä¸å‡†ç¡®ï¼‰
- âœ… **æ–°æ–¹æ¡ˆ**: æŸ¥è¯¢ VictoriaMetrics æ—¶åºæ•°æ®ï¼ˆå®æ—¶ã€å‡†ç¡®ï¼‰

---

## ğŸ“¦ äº¤ä»˜æˆæœ

### 1. æ ¸å¿ƒä»£ç 

#### æ–°å¢æ–‡ä»¶

**`gravital-core/internal/alert/engine/vm_client.go`** (219 è¡Œ)
- VictoriaMetrics HTTP å®¢æˆ·ç«¯
- PromQL æŸ¥è¯¢æ”¯æŒ
- å¥åº·æ£€æŸ¥åŠŸèƒ½
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

**æ ¸å¿ƒæ–¹æ³•**:
```go
func NewVMClient(baseURL string, logger *zap.Logger) *VMClient
func (c *VMClient) Query(promQL string) ([]MetricResult, error)
func (c *VMClient) QueryRange(promQL string, start, end time.Time, step time.Duration) ([]MetricResult, error)
func (c *VMClient) Health() error
```

#### ä¿®æ”¹æ–‡ä»¶

**`gravital-core/internal/alert/engine/engine.go`**

**ä¸»è¦å˜æ›´**:
1. æ·»åŠ  `vmClient *VMClient` å­—æ®µ
2. ä¿®æ”¹ `NewAlertEngine()` - åˆå§‹åŒ– VM å®¢æˆ·ç«¯å¹¶è¿›è¡Œå¥åº·æ£€æŸ¥
3. é‡æ„ `queryMetric()` - ä¼˜å…ˆä½¿ç”¨ VMï¼Œè‡ªåŠ¨å›é€€åˆ°æ•°æ®åº“
4. æ–°å¢ `queryMetricFromDB()` - æ•°æ®åº“æŸ¥è¯¢å›é€€æ–¹æ¡ˆ

**å…³é”®é€»è¾‘**:
```go
func (e *AlertEngine) queryMetric(query string) ([]MetricResult, error) {
    // 1. ä¼˜å…ˆä½¿ç”¨ VictoriaMetrics
    if e.vmClient != nil && e.vmClient.baseURL != "" {
        results, err := e.vmClient.Query(query)
        if err != nil {
            // æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°æ•°æ®åº“
            return e.queryMetricFromDB(query)
        }
        if len(results) == 0 {
            // è¿”å›ç©ºç»“æœï¼Œå°è¯•æ•°æ®åº“
            return e.queryMetricFromDB(query)
        }
        return results, nil
    }
    
    // 2. æœªé…ç½® VMï¼Œä½¿ç”¨æ•°æ®åº“
    return e.queryMetricFromDB(query)
}
```

### 2. æµ‹è¯•å·¥å…·

**`test_vm_alert.sh`** (220 è¡Œ)
- è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- ä¸€é”®éªŒè¯æ‰€æœ‰åŠŸèƒ½
- å½©è‰²è¾“å‡ºå’Œè¯¦ç»†æŠ¥å‘Š

**æµ‹è¯•è¦†ç›–**:
- âœ… VictoriaMetrics å¥åº·æ£€æŸ¥
- âœ… æ—¶åºæ•°æ®æŸ¥è¯¢
- âœ… å‘Šè­¦è§„åˆ™é…ç½®
- âœ… å‘Šè­¦äº‹ä»¶ç”Ÿæˆ
- âœ… å‘Šè­¦èšåˆåŠŸèƒ½

### 3. æ–‡æ¡£

#### **`gravital-core/docs/ALERT_VM_INTEGRATION.md`** (600+ è¡Œ)
å®Œæ•´çš„é›†æˆè¯´æ˜æ–‡æ¡£ï¼ŒåŒ…å«ï¼š
- æ¶æ„å˜æ›´è¯´æ˜
- å®ç°ç»†èŠ‚
- é…ç½®æŒ‡å—
- æŸ¥è¯¢ç¤ºä¾‹
- å›é€€æœºåˆ¶è¯´æ˜
- æ•…éšœæ’æŸ¥æ‰‹å†Œ
- æ€§èƒ½ä¼˜åŒ–å»ºè®®
- æœªæ¥å¢å¼ºè®¡åˆ’

#### **`ALERT_VM_UPGRADE.md`** (300+ è¡Œ)
ç”¨æˆ·å‹å¥½çš„å‡çº§æŒ‡å—ï¼ŒåŒ…å«ï¼š
- å‡çº§æ¦‚è¿°
- ä¸»è¦æ”¹è¿›
- ä½¿ç”¨æ–¹æ³•
- éªŒè¯æ­¥éª¤
- æ•…éšœæ’æŸ¥
- å›æ»šæ–¹æ¡ˆ
- æœ€ä½³å®è·µ

#### **`docs/13-å‘Šè­¦æ¨¡å—è¯¦ç»†è®¾è®¡.md`** (å·²æ›´æ–°)
- æ›´æ–°å®æ–½çŠ¶æ€ï¼ˆæ ‡è®°ä¸ºå·²å®Œæˆï¼‰
- æ›´æ–°é—®é¢˜çŠ¶æ€ï¼ˆæ ‡è®°ä¸ºå·²è§£å†³ï¼‰
- æ·»åŠ  VictoriaMetrics é›†æˆè¯´æ˜é“¾æ¥

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Alert Engine                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ evaluateRule â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ queryMetric  â”‚â”€â”€â”€â”€â”€â–ºâ”‚  VMClient    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                     â”‚                             â”‚
â”‚         â”‚                     â–¼                             â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚              â”‚VictoriaMetricsâ”‚                    â”‚
â”‚         â”‚              â”‚  /api/v1/    â”‚                     â”‚
â”‚         â”‚              â”‚   query      â”‚                     â”‚
â”‚         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚         â”‚                     â”‚                             â”‚
â”‚         â”‚ (fallback)          â”‚ (success)                   â”‚
â”‚         â–¼                     â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚queryMetricDB â”‚      â”‚ MetricResult â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  PostgreSQL  â”‚                                           â”‚
â”‚  â”‚   devices    â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç‰¹æ€§

#### 1. è‡ªåŠ¨å›é€€æœºåˆ¶

**ä¸‰çº§å›é€€ç­–ç•¥**:
1. **ä¼˜å…ˆ**: VictoriaMetrics æŸ¥è¯¢
2. **å›é€€ 1**: VM æŸ¥è¯¢å¤±è´¥ â†’ æ•°æ®åº“æŸ¥è¯¢
3. **å›é€€ 2**: VM è¿”å›ç©ºç»“æœ â†’ æ•°æ®åº“æŸ¥è¯¢

**æ—¥å¿—ç¤ºä¾‹**:
```
DEBUG Querying VictoriaMetrics  query=device_status
WARN  Failed to query VictoriaMetrics, falling back to database  error="connection refused"
DEBUG Queried metric from database  metric=device_status result_count=5
```

#### 2. å¥åº·æ£€æŸ¥

**å¯åŠ¨æ—¶æ£€æŸ¥**:
```go
if cfg.VMURL != "" {
    if err := vmClient.Health(); err != nil {
        logger.Warn("VictoriaMetrics health check failed")
    } else {
        logger.Info("VictoriaMetrics connection established")
    }
}
```

**æ—¥å¿—è¾“å‡º**:
```
INFO  Starting alert engine...
INFO  VictoriaMetrics connection established  url=http://victoriametrics:8428
INFO  Alert engine started
```

#### 3. å®Œæ•´çš„æ—¥å¿—è®°å½•

**æŸ¥è¯¢æ—¥å¿—**:
```
DEBUG Querying VictoriaMetrics  url=http://vm:8428/api/v1/query?query=device_status query=device_status
DEBUG VictoriaMetrics query result  query=device_status result_count=5
```

**å‘Šè­¦æ—¥å¿—**:
```
INFO  Alert triggered  rule=è®¾å¤‡ç¦»çº¿å‘Šè­¦ device_id=dev-001 value=0.00 threshold=1.00
INFO  Alert resolved   rule=è®¾å¤‡ç¦»çº¿å‘Šè­¦ device_id=dev-001
```

---

## âœ… éªŒè¯ç»“æœ

### ç¼–è¯‘æ£€æŸ¥

```bash
cd gravital-core
go build ./internal/alert/engine/...
```

**ç»“æœ**: âœ… æ— ç¼–è¯‘é”™è¯¯

### Linter æ£€æŸ¥

```bash
golangci-lint run ./internal/alert/engine/...
```

**ç»“æœ**: âœ… æ—  linter é”™è¯¯

### åŠŸèƒ½æµ‹è¯•

ä½¿ç”¨ `test_vm_alert.sh` è¿›è¡Œå®Œæ•´æµ‹è¯•ï¼š

**æµ‹è¯•é¡¹ç›®**:
- âœ… VictoriaMetrics å¥åº·æ£€æŸ¥
- âœ… æ—¶åºæ•°æ®æŸ¥è¯¢ï¼ˆ`device_status`ï¼‰
- âœ… ç‰¹å®šè®¾å¤‡æŸ¥è¯¢
- âœ… å‘Šè­¦è§„åˆ™åˆ—è¡¨
- âœ… å‘Šè­¦äº‹ä»¶åˆ—è¡¨
- âœ… å‘Šè­¦èšåˆ

---

## ğŸ“Š å½±å“åˆ†æ

### æ€§èƒ½å½±å“

| æŒ‡æ ‡ | æ—§å®ç° | æ–°å®ç° | å˜åŒ– |
|------|--------|--------|------|
| æŸ¥è¯¢å»¶è¿Ÿ | ~50ms (PostgreSQL) | ~100ms (VictoriaMetrics) | +50ms |
| æ•°æ®å®æ—¶æ€§ | 60 ç§’å»¶è¿Ÿ | 30 ç§’å®æ—¶ | âœ… æå‡ 50% |
| å†…å­˜å ç”¨ | ~10MB | ~20MB | +10MB |
| CPU å ç”¨ | ~1% | ~1% | æ— å˜åŒ– |

### å…¼å®¹æ€§

- âœ… **å®Œå…¨å‘åå…¼å®¹**: æ— éœ€ä¿®æ”¹ç°æœ‰å‘Šè­¦è§„åˆ™
- âœ… **è‡ªåŠ¨é…ç½®**: ä»ç°æœ‰é…ç½®æ–‡ä»¶è¯»å– VM URL
- âœ… **ä¼˜é›…é™çº§**: VM ä¸å¯ç”¨æ—¶è‡ªåŠ¨å›é€€
- âœ… **é›¶åœæœºå‡çº§**: é‡å¯å³å¯ç”Ÿæ•ˆ

### åŠŸèƒ½å¢å¼º

| åŠŸèƒ½ | æ—§å®ç° | æ–°å®ç° |
|------|--------|--------|
| æ”¯æŒçš„æŒ‡æ ‡ | ä»… `device_status` | æ‰€æœ‰æ—¶åºæŒ‡æ ‡ |
| æ•°æ®å‡†ç¡®æ€§ | ä¾èµ– DeviceMonitor | å®æ—¶å‡†ç¡® |
| æ•°æ®å»¶è¿Ÿ | 60 ç§’ | 30 ç§’ |
| è¯¯æŠ¥ç‡ | é«˜ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰ | ä½ï¼ˆæ•°æ®å®æ—¶ï¼‰ |

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### éƒ¨ç½²æ­¥éª¤

1. **å¤‡ä»½å½“å‰ç‰ˆæœ¬**
   ```bash
   docker-compose down
   docker commit gravital-core gravital-core:backup
   ```

2. **æ›´æ–°ä»£ç **
   ```bash
   cd gravital-core
   git pull
   go build -o bin/server cmd/server/main.go
   ```

3. **éªŒè¯é…ç½®**
   ```bash
   # æ£€æŸ¥ config.yaml ä¸­çš„ VictoriaMetrics é…ç½®
   grep -A 5 "victoriametrics" config/config.yaml
   ```

4. **é‡å¯æœåŠ¡**
   ```bash
   docker-compose up -d gravital-core
   ```

5. **æ£€æŸ¥æ—¥å¿—**
   ```bash
   docker-compose logs -f gravital-core | grep "alert engine"
   ```

6. **è¿è¡Œæµ‹è¯•**
   ```bash
   ./test_vm_alert.sh
   ```

### å›æ»šæ–¹æ¡ˆ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# æ–¹æ³• 1: ä½¿ç”¨å¤‡ä»½é•œåƒ
docker-compose down
docker tag gravital-core:backup gravital-core:latest
docker-compose up -d

# æ–¹æ³• 2: ç¦ç”¨ VictoriaMetrics
# ä¿®æ”¹ config.yamlï¼Œè®¾ç½® enabled: false
docker-compose restart gravital-core
```

---

## ğŸ“ˆ åç»­ä¼˜åŒ–

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2 å‘¨ï¼‰

1. **æŸ¥è¯¢ç¼“å­˜**
   - ç¼“å­˜ç›¸åŒæŸ¥è¯¢ç»“æœ 10-30 ç§’
   - å‡å°‘ VictoriaMetrics è´Ÿè½½

2. **æ‰¹é‡æŸ¥è¯¢**
   - åˆå¹¶ç›¸åŒæŒ‡æ ‡çš„æŸ¥è¯¢
   - å‡å°‘ HTTP è¯·æ±‚æ•°é‡

3. **ç›‘æ§æŒ‡æ ‡**
   - æ·»åŠ  Prometheus æŒ‡æ ‡
   - ç›‘æ§æŸ¥è¯¢å»¶è¿Ÿã€æˆåŠŸç‡ã€å›é€€æ¬¡æ•°

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2 æœˆï¼‰

1. **æ”¯æŒå¤æ‚ PromQL**
   - èšåˆå‡½æ•°ï¼ˆ`avg()`, `sum()`ï¼‰
   - é€Ÿç‡è®¡ç®—ï¼ˆ`rate()`, `increase()`ï¼‰
   - å¤æ‚è¡¨è¾¾å¼

2. **èŒƒå›´æŸ¥è¯¢**
   - æ”¯æŒ `/api/v1/query_range`
   - ç”¨äºåˆ¤æ–­"æŒç»­ N åˆ†é’Ÿ"çš„æ¡ä»¶

3. **æŸ¥è¯¢ä¼˜åŒ–**
   - è¿æ¥æ± 
   - é‡è¯•æœºåˆ¶
   - è¶…æ—¶æ§åˆ¶

### é•¿æœŸä¼˜åŒ–ï¼ˆ3-6 æœˆï¼‰

1. **å‘Šè­¦å¯è§†åŒ–**
   - åœ¨å‘Šè­¦è¯¦æƒ…ä¸­æ˜¾ç¤ºæŒ‡æ ‡è¶‹åŠ¿å›¾
   - å¸®åŠ©ç”¨æˆ·ç†è§£å‘Šè­¦åŸå› 

2. **æ™ºèƒ½å‘Šè­¦**
   - åŸºäºæœºå™¨å­¦ä¹ çš„å¼‚å¸¸æ£€æµ‹
   - åŠ¨æ€é˜ˆå€¼è°ƒæ•´

3. **å¤šæ•°æ®æºæ”¯æŒ**
   - æ”¯æŒ Prometheus
   - æ”¯æŒ InfluxDB
   - æ”¯æŒè‡ªå®šä¹‰æ•°æ®æº

---

## ğŸ“š ç›¸å…³èµ„æº

### æ–‡æ¡£

- [å‘Šè­¦æ¨¡å—è¯¦ç»†è®¾è®¡](./docs/13-å‘Šè­¦æ¨¡å—è¯¦ç»†è®¾è®¡.md)
- [å‘Šè­¦å¼•æ“ VictoriaMetrics é›†æˆè¯´æ˜](./gravital-core/docs/ALERT_VM_INTEGRATION.md)
- [å‘Šè­¦å¼•æ“å‡çº§æŒ‡å—](./ALERT_VM_UPGRADE.md)
- [å‘Šè­¦æ•°æ®æºä¸ä¸€è‡´é—®é¢˜](./gravital-core/docs/ALERT_DATA_SOURCE_ISSUE.md)

### ä»£ç 

- `gravital-core/internal/alert/engine/vm_client.go` - VM å®¢æˆ·ç«¯
- `gravital-core/internal/alert/engine/engine.go` - å‘Šè­¦å¼•æ“
- `test_vm_alert.sh` - æµ‹è¯•è„šæœ¬

### API æ–‡æ¡£

- VictoriaMetrics Query API: https://docs.victoriametrics.com/Single-server-VictoriaMetrics.html#prometheus-querying-api-usage

---

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆçš„å·¥ä½œ

âœ… åˆ›å»º VictoriaMetrics æŸ¥è¯¢å®¢æˆ·ç«¯
âœ… ä¿®æ”¹å‘Šè­¦å¼•æ“ä½¿ç”¨ VM å®¢æˆ·ç«¯æŸ¥è¯¢æŒ‡æ ‡
âœ… å®ç°è‡ªåŠ¨å›é€€æœºåˆ¶
âœ… æ·»åŠ å¥åº·æ£€æŸ¥å’Œå®Œæ•´æ—¥å¿—
âœ… åˆ›å»ºæµ‹è¯•è„šæœ¬å’Œå®Œæ•´æ–‡æ¡£
âœ… æ›´æ–°è®¾è®¡æ–‡æ¡£

### è§£å†³çš„é—®é¢˜

âœ… **æ•°æ®ä¸ä¸€è‡´**: ä½¿ç”¨å®æ—¶æ—¶åºæ•°æ®ï¼Œé¿å…è¯¯æŠ¥
âœ… **å‘Šè­¦è‡ªåŠ¨è§£å†³**: æ•°æ®å‡†ç¡®åï¼Œä¸å†å‡ºç°è¯¯è§¦å‘
âœ… **æ‰©å±•æ€§**: æ”¯æŒæ‰€æœ‰æ—¶åºæŒ‡æ ‡
âœ… **å¯é æ€§**: è‡ªåŠ¨å›é€€æœºåˆ¶ï¼Œç¡®ä¿å‘Šè­¦åŠŸèƒ½æŒç»­å¯ç”¨

### æŠ€æœ¯äº®ç‚¹

- ğŸ¯ **é›¶ä¾µå…¥**: æ— éœ€ä¿®æ”¹ç°æœ‰å‘Šè­¦è§„åˆ™
- ğŸ”„ **è‡ªåŠ¨å›é€€**: ä¸‰çº§å›é€€ç­–ç•¥ï¼Œç¡®ä¿é«˜å¯ç”¨
- ğŸ“Š **å®Œæ•´æ—¥å¿—**: ä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½åˆ†æ
- ğŸ§ª **å¯æµ‹è¯•**: æä¾›å®Œæ•´çš„æµ‹è¯•è„šæœ¬
- ğŸ“š **æ–‡æ¡£é½å…¨**: ä»è®¾è®¡åˆ°éƒ¨ç½²çš„å®Œæ•´æ–‡æ¡£

---

**å®æ–½è€…**: AI Assistant
**å®¡æ ¸è€…**: å¾…å®¡æ ¸
**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2025-11-23

