# 拓扑功能实现说明

## 概述

本文档说明了设备网络拓扑功能的实现细节，包括后端服务、前端组件和使用方法。

## 已实现功能

### 后端功能

#### 1. 数据模型

创建了以下数据表：
- `topologies`: 拓扑图表
- `topology_nodes`: 拓扑节点表
- `topology_links`: 拓扑链路表
- `topology_groups`: 拓扑分组表
- `topology_versions`: 拓扑版本历史表
- `lldp_neighbors`: LLDP 邻居表

#### 2. API 接口

实现了完整的 RESTful API：

**拓扑管理**:
- `GET /api/v1/topologies` - 获取拓扑列表
- `POST /api/v1/topologies` - 创建拓扑
- `GET /api/v1/topologies/:id` - 获取拓扑详情
- `PUT /api/v1/topologies/:id` - 更新拓扑
- `DELETE /api/v1/topologies/:id` - 删除拓扑

**节点管理**:
- `POST /api/v1/topologies/:id/nodes` - 添加节点
- `PATCH /api/v1/topologies/:id/nodes/:node_id/position` - 更新节点位置
- `PATCH /api/v1/topologies/:id/nodes/batch` - 批量更新节点
- `DELETE /api/v1/topologies/:id/nodes/:node_id` - 删除节点

**链路管理**:
- `POST /api/v1/topologies/:id/links` - 添加链路
- `PATCH /api/v1/topologies/:id/links/:link_id/status` - 更新链路状态
- `DELETE /api/v1/topologies/:id/links/:link_id` - 删除链路

**布局和分析**:
- `POST /api/v1/topologies/:id/layout` - 应用布局
- `POST /api/v1/topologies/:id/analyze/path` - 路径分析
- `POST /api/v1/topologies/:id/analyze/impact` - 影响分析

**版本管理**:
- `GET /api/v1/topologies/:id/versions` - 获取版本列表
- `POST /api/v1/topologies/:id/versions` - 创建快照
- `POST /api/v1/topologies/:id/versions/:version/restore` - 恢复版本

#### 3. 自动发现服务

实现了基于 LLDP 的自动拓扑发现：
- 从 `lldp_neighbors` 表读取邻居信息
- 自动匹配设备（Chassis ID、IP、名称）
- 自动创建节点和链路
- 支持增量发现

### 前端功能

#### 1. 拓扑列表页面

路径: `/topology`

功能：
- 拓扑列表展示
- 搜索和过滤（类型、范围、关键词）
- 创建、编辑、删除拓扑
- 分页

#### 2. 拓扑详情页面

路径: `/topology/:id`

功能：
- 拓扑可视化（基于 G6）
- 节点和链路交互
- 添加节点和链路
- 拖拽移动节点
- 缩放、平移、适应画布
- 多种布局算法（力导向、层次、环形、网格）
- 迷你地图
- 节点/链路详情面板
- 版本管理（快照、恢复）

#### 3. 拓扑画布组件

组件: `TopologyCanvas.vue`

特性：
- 基于 AntV G6 图形库
- 支持拖拽、缩放、平移
- 节点和链路状态可视化
- 工具栏（缩放、布局切换）
- 迷你地图
- 详情面板

## 使用方法

### 1. 安装依赖

前端需要安装 G6 图形库：

```bash
cd gravital-core/web
npm install @antv/g6
```

### 2. 运行数据库迁移

```bash
cd gravital-core
make migrate-up
```

这将创建拓扑相关的数据表。

### 3. 配置权限

在用户权限配置中添加拓扑相关权限：
- `topology.read`: 查看拓扑
- `topology.write`: 创建和编辑拓扑
- `topology.delete`: 删除拓扑
- `topology.discover`: 触发自动发现

### 4. 创建拓扑

1. 访问 `/topology` 页面
2. 点击"创建拓扑"按钮
3. 填写拓扑信息：
   - 名称
   - 描述
   - 类型（物理/逻辑/自定义）
   - 范围（全局/数据中心/区域）
   - 布局类型
   - 是否启用自动发现
4. 点击"确定"创建

### 5. 添加节点

在拓扑详情页面：
1. 点击"添加节点"按钮
2. 填写节点信息：
   - 设备 ID
   - 标签
   - 节点类型
   - 层级
3. 点击"确定"添加

### 6. 添加链路

在拓扑详情页面：
1. 点击"添加链路"按钮
2. 选择源节点和目标节点
3. 填写链路信息：
   - 链路类型
   - 接口信息
   - 带宽
4. 点击"确定"添加

### 7. 自动发现

如果启用了自动发现：
1. 确保设备上报了 LLDP 邻居信息
2. 系统会定期（根据配置的间隔）自动发现拓扑
3. 新发现的节点和链路会自动添加到拓扑中

### 8. 版本管理

创建快照：
1. 点击"创建快照"按钮
2. 输入快照描述
3. 点击"确定"

恢复版本：
1. 点击"版本历史"按钮
2. 在版本列表中选择要恢复的版本
3. 点击"恢复"按钮
4. 确认恢复操作

## 路由配置

在前端路由配置中添加拓扑路由：

```typescript
{
  path: '/topology',
  name: 'Topology',
  component: () => import('@/views/Topology/Index.vue'),
  meta: { title: '网络拓扑', requiresAuth: true }
},
{
  path: '/topology/:id',
  name: 'TopologyDetail',
  component: () => import('@/views/Topology/Detail.vue'),
  meta: { title: '拓扑详情', requiresAuth: true }
}
```

## 菜单配置

在侧边栏菜单中添加拓扑入口：

```typescript
{
  name: '网络拓扑',
  icon: 'Network',
  path: '/topology',
  permission: 'topology.read'
}
```

## 数据流

### 拓扑创建流程

```
用户输入 → 前端表单验证 → API 请求 → 后端验证 → 创建数据库记录 → 返回结果 → 前端更新
```

### 自动发现流程

```
定时任务触发 → 读取 LLDP 邻居 → 匹配设备 → 创建节点 → 创建链路 → 更新拓扑 → 推送更新
```

### 节点拖拽流程

```
用户拖拽节点 → G6 触发事件 → 前端更新坐标 → API 请求 → 后端更新数据库 → 返回结果
```

## 性能优化

### 前端优化

1. **虚拟化渲染**: 大规模拓扑（1000+ 节点）使用 G6 的虚拟化功能
2. **延迟加载**: 按需加载节点详情
3. **防抖**: 节点拖拽时使用防抖减少 API 调用
4. **缓存**: 使用 Pinia 缓存拓扑数据

### 后端优化

1. **索引**: 在关键字段上添加数据库索引
2. **预加载**: 使用 GORM 的 Preload 避免 N+1 查询
3. **批量操作**: 支持批量更新节点位置
4. **缓存**: 可以使用 Redis 缓存拓扑数据

## 扩展功能

### 待实现功能

1. **告警集成**: 在拓扑图上显示告警设备
2. **流量可视化**: 显示链路流量动画
3. **路径追踪**: 完善路径分析功能
4. **影响分析**: 完善影响分析功能
5. **导出功能**: 导出为图片、PDF、JSON
6. **分组功能**: 支持设备分组和折叠
7. **实时更新**: 使用 WebSocket 推送拓扑变更

### 扩展建议

1. **多租户支持**: 添加租户隔离
2. **权限细化**: 细化节点和链路的操作权限
3. **审计日志**: 记录拓扑变更历史
4. **模板功能**: 支持拓扑模板
5. **批量导入**: 支持从文件导入拓扑

## 故障排查

### 常见问题

1. **G6 加载失败**
   - 确认已安装 `@antv/g6` 依赖
   - 检查网络连接
   - 查看浏览器控制台错误

2. **拓扑无法显示**
   - 检查 API 是否返回数据
   - 检查节点和链路数据格式
   - 查看浏览器控制台错误

3. **自动发现不工作**
   - 检查拓扑是否启用自动发现
   - 检查 LLDP 邻居数据是否存在
   - 检查设备匹配规则

4. **节点拖拽不生效**
   - 检查拓扑是否设置为可编辑
   - 检查节点是否锁定
   - 检查 API 权限

## 总结

拓扑功能已完成基础实现，包括：
- ✅ 完整的后端 API
- ✅ 数据模型和数据库表
- ✅ 前端可视化组件
- ✅ 拓扑列表和详情页面
- ✅ 自动发现服务
- ✅ 版本管理

后续可以根据实际需求继续完善和扩展功能。

