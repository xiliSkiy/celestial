# 网络拓扑逻辑流程梳理

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│  采集端 (Orbital Sentinel)                                      │
│                                                                 │
│  ┌──────────────┐         ┌──────────────┐                    │
│  │ LLDP 插件    │         │ 其他采集插件 │                    │
│  │ (采集邻居)   │         │ (采集指标)   │                    │
│  └──────┬───────┘         └──────┬───────┘                    │
│         │                        │                             │
│         └──────────┬─────────────┘                             │
│                    │                                            │
│              ┌─────▼─────┐                                      │
│              │ Scheduler │                                      │
│              └─────┬─────┘                                      │
│                   │                                            │
│              ┌─────▼─────┐                                      │
│              │  Sender   │                                      │
│              └─────┬─────┘                                      │
└────────────────────┼──────────────────────────────────────────┘
                     │
                     │ POST /api/v1/data/ingest
                     │ POST /api/v1/topology/lldp
                     │
┌────────────────────▼──────────────────────────────────────────┐
│  中心端 (Gravital Core)                                        │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ API 层                                                   │  │
│  │  - ForwarderHandler.IngestMetrics()                    │  │
│  │  - TopologyHandler.IngestLLDP()                        │  │
│  │  - TopologyHandler.DiscoverTopology()                   │  │
│  └──────┬──────────────────────────────┬──────────────────┘  │
│         │                              │                        │
│  ┌──────▼──────────┐         ┌────────▼──────────┐            │
│  │ Service 层      │         │ Service 层        │            │
│  │                 │         │                   │            │
│  │ DeviceService   │         │ TopologyService    │            │
│  │ - 更新设备状态  │         │ - UpsertLLDP()    │            │
│  └─────────────────┘         │ - GetLLDP()       │            │
│                               └────────┬──────────┘            │
│                                        │                       │
│                        ┌───────────────▼───────────────┐      │
│                        │ TopologyDiscoveryService       │      │
│                        │ - DiscoverTopology()          │      │
│                        │ - CleanupStaleNeighbors()     │      │
│                        └───────────────┬───────────────┘      │
│                                        │                       │
│  ┌─────────────────────────────────────▼───────────────────┐  │
│  │ Repository 层                                           │  │
│  │  - TopologyRepository                                   │  │
│  │  - DeviceRepository                                     │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                        │                       │
│  ┌─────────────────────────────────────▼───────────────────┐  │
│  │ 数据库层                                                │  │
│  │  - lldp_neighbors (LLDP 邻居数据)                      │  │
│  │  - topologies (拓扑图)                                  │  │
│  │  - topology_nodes (拓扑节点)                            │  │
│  │  - topology_links (拓扑链路)                            │  │
│  └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 数据流

### 2.1 LLDP 数据采集流程

```
1. 采集端 (Sentinel)
   │
   ├─> LLDP 插件执行采集
   │   └─> 通过 SNMP/SSH 获取设备的 LLDP 邻居表
   │       └─> 解析 LLDP MIB 数据
   │
   ├─> 构造 LLDPNeighbor 数据结构
   │   {
   │     device_id: "dev-001",
   │     local_interface: "GigabitEthernet0/1",
   │     neighbor_chassis_id: "00:11:22:33:44:55",
   │     neighbor_port_id: "GigabitEthernet0/2",
   │     neighbor_system_name: "Switch-02",
   │     neighbor_mgmt_addr: "192.168.1.2",
   │     ...
   │   }
   │
   └─> 上报到中心端
       POST /api/v1/topology/lldp
       {
         "device_id": "dev-001",
         "neighbors": [
           { ... LLDPNeighbor 数据 ... }
         ]
       }

2. 中心端接收
   │
   ├─> TopologyHandler.IngestLLDP()
   │   └─> 验证请求
   │       └─> 调用 TopologyService.UpsertLLDPNeighbor()
   │
   ├─> TopologyService.UpsertLLDPNeighbor()
   │   └─> 调用 TopologyRepository.UpsertLLDPNeighbor()
   │
   └─> 写入数据库
       INSERT INTO lldp_neighbors ... ON CONFLICT UPDATE ...
```

### 2.2 自动拓扑发现流程

```
1. 触发发现（手动或定时）
   │
   ├─> 方式 1: 手动触发
   │   POST /api/v1/topologies/:id/discover
   │   └─> TopologyHandler.DiscoverTopology()
   │
   ├─> 方式 2: 定时任务（可选）
   │   定时检查 is_auto_discovery=true 的拓扑
   │   └─> 根据 discovery_interval 触发
   │
   └─> 方式 3: 设备状态变化触发（可选）
       └─> 设备上线时自动触发发现

2. 执行发现
   │
   ├─> TopologyDiscoveryService.DiscoverTopology()
   │   │
   │   ├─> 1. 获取拓扑配置
   │   │   └─> 检查 is_auto_discovery 标志
   │   │
   │   ├─> 2. 读取 LLDP 邻居数据
   │   │   └─> GetAllLLDPNeighbors()
   │   │       └─> 从 lldp_neighbors 表读取
   │   │
   │   ├─> 3. 获取设备列表
   │   │   └─> DeviceRepository.List()
   │   │       └─> 构建 device_id -> Device 映射
   │   │
   │   ├─> 4. 获取现有节点和链路
   │   │   └─> 构建映射，避免重复创建
   │   │
   │   ├─> 5. 处理每个 LLDP 邻居
   │   │   │
   │   │   ├─> 查找本地设备
   │   │   │   └─> deviceMap[neighbor.DeviceID]
   │   │   │
   │   │   ├─> 查找或创建本地节点
   │   │   │   └─> findOrCreateNode()
   │   │   │       └─> 如果不存在，创建 TopologyNode
   │   │   │
   │   │   ├─> 匹配邻居设备
   │   │   │   └─> matchNeighborDevice()
   │   │   │       ├─> 优先级 1: 通过 Chassis ID 匹配
   │   │   │       ├─> 优先级 2: 通过管理 IP 匹配
   │   │   │       └─> 优先级 3: 通过系统名称匹配
   │   │   │
   │   │   ├─> 查找或创建邻居节点
   │   │   │   └─> findOrCreateNode()
   │   │   │
   │   │   └─> 创建链路（如果不存在）
   │   │       └─> 检查双向链路，避免重复
   │   │           └─> 创建 TopologyLink
   │   │
   │   └─> 6. 更新拓扑
   │       └─> 更新 last_discovery_at 时间戳
   │
   └─> 返回结果
       {
         "discovered_nodes": 5,
         "discovered_links": 8
       }
```

### 2.3 数据清理流程

```
定时任务（可选）
│
└─> TopologyDiscoveryService.CleanupStaleNeighbors()
    │
    └─> 删除 24 小时未更新的 LLDP 邻居
        DELETE FROM lldp_neighbors
        WHERE last_seen < NOW() - INTERVAL '24 hours'
```

## 3. 当前问题分析

### 3.1 问题 1: 自动发现没有驱动入口

**现状**:
- ✅ `TopologyDiscoveryService.DiscoverTopology()` 已实现
- ❌ `TopologyHandler` 中没有 `DiscoverTopology` handler
- ❌ 路由中没有 `/topologies/:id/discover` 端点

**影响**:
- 用户无法手动触发拓扑发现
- 无法通过 API 调用自动发现功能

**解决方案**:
1. 在 `TopologyHandler` 中添加 `DiscoverTopology` 方法
2. 在路由中添加 `POST /topologies/:id/discover` 端点
3. （可选）添加定时任务支持

### 3.2 问题 2: lldp_neighbors 数据没有数据来源

**现状**:
- ✅ `TopologyService.UpsertLLDPNeighbor()` 已实现
- ✅ `TopologyRepository.UpsertLLDPNeighbor()` 已实现
- ❌ 没有 API 端点接收 LLDP 数据
- ❌ 采集端没有上报 LLDP 数据的逻辑

**影响**:
- `lldp_neighbors` 表始终为空
- 自动发现功能无法获取邻居信息
- 拓扑发现无法工作

**解决方案**:
1. 在 `TopologyHandler` 中添加 `IngestLLDP` 方法
2. 在路由中添加 `POST /api/v1/topology/lldp` 端点（Sentinel 认证）
3. 在采集端添加 LLDP 数据上报逻辑（需要 Sentinel 端支持）

## 4. 完整数据流（修复后）

### 4.1 LLDP 数据上报

```
采集端
│
├─> LLDP 插件采集
│   └─> 获取设备 LLDP 邻居表
│
├─> 构造上报数据
│   {
│     "device_id": "dev-001",
│     "neighbors": [
│       {
│         "local_interface": "GigabitEthernet0/1",
│         "neighbor_chassis_id": "00:11:22:33:44:55",
│         "neighbor_port_id": "GigabitEthernet0/2",
│         "neighbor_system_name": "Switch-02",
│         "neighbor_mgmt_addr": "192.168.1.2",
│         "ttl": 120
│       }
│     ]
│   }
│
└─> POST /api/v1/topology/lldp
    Headers:
      X-Sentinel-ID: sentinel-001
      Authorization: Bearer <sentinel_token>
    │
    └─> TopologyHandler.IngestLLDP()
        │
        ├─> 验证 Sentinel 认证
        ├─> 验证请求数据
        │
        └─> 遍历 neighbors
            └─> TopologyService.UpsertLLDPNeighbor()
                └─> 写入 lldp_neighbors 表
```

### 4.2 拓扑自动发现

```
用户操作 / 定时任务
│
└─> POST /api/v1/topologies/:id/discover
    Headers:
      Authorization: Bearer <user_token>
    │
    └─> TopologyHandler.DiscoverTopology()
        │
        ├─> 验证权限 (topology.write)
        ├─> 获取拓扑 ID
        │
        └─> TopologyDiscoveryService.DiscoverTopology()
            │
            ├─> 读取 lldp_neighbors 表
            ├─> 匹配设备
            ├─> 创建节点和链路
            │
            └─> 返回结果
                {
                  "code": 0,
                  "data": {
                    "discovered_nodes": 5,
                    "discovered_links": 8
                  }
                }
```

## 5. 实现计划

### 5.1 阶段 1: 添加 API 端点（立即实现）

1. **添加 LLDP 数据上报端点**
   - [ ] 在 `TopologyHandler` 中添加 `IngestLLDP` 方法
   - [ ] 在路由中添加 `POST /api/v1/topology/lldp`（Sentinel 认证）
   - [ ] 添加请求验证和错误处理

2. **添加自动发现端点**
   - [ ] 在 `TopologyHandler` 中添加 `DiscoverTopology` 方法
   - [ ] 在路由中添加 `POST /topologies/:id/discover`
   - [ ] 添加权限检查

### 5.2 阶段 2: 采集端支持（后续实现）

1. **LLDP 插件开发**
   - [ ] 开发 LLDP 采集插件
   - [ ] 支持 SNMP/SSH 方式获取 LLDP 数据
   - [ ] 解析 LLDP MIB 数据

2. **数据上报**
   - [ ] 在 Sender 中添加 LLDP 数据上报逻辑
   - [ ] 定期上报 LLDP 邻居信息

### 5.3 阶段 3: 定时任务（可选）

1. **定时发现**
   - [ ] 添加定时任务框架
   - [ ] 定时检查并触发自动发现
   - [ ] 支持配置发现间隔

2. **数据清理**
   - [ ] 定时清理过期的 LLDP 邻居数据

## 6. API 设计

### 6.1 LLDP 数据上报 API

**端点**: `POST /api/v1/topology/lldp`

**认证**: Sentinel 认证（`middleware.SentinelAuth()`）

**请求体**:
```json
{
  "device_id": "dev-001",
  "neighbors": [
    {
      "local_interface": "GigabitEthernet0/1",
      "neighbor_chassis_id": "00:11:22:33:44:55",
      "neighbor_port_id": "GigabitEthernet0/2",
      "neighbor_system_name": "Switch-02",
      "neighbor_system_desc": "Cisco IOS Software",
      "neighbor_port_desc": "GigabitEthernet0/2",
      "neighbor_mgmt_addr": "192.168.1.2",
      "ttl": 120
    }
  ]
}
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "processed": 1,
    "created": 1,
    "updated": 0
  }
}
```

### 6.2 拓扑自动发现 API

**端点**: `POST /api/v1/topologies/:id/discover`

**认证**: 用户认证 + `topology.write` 权限

**请求体**: 无（或可选的配置参数）

**响应**:
```json
{
  "code": 0,
  "data": {
    "topology_id": 1,
    "discovered_nodes": 5,
    "discovered_links": 8,
    "duration_ms": 1234
  }
}
```

## 7. 数据库表关系

```
devices (设备表)
  │
  ├─> device_id (主键)
  │
  └─> labels["chassis_id"] (用于匹配)

lldp_neighbors (LLDP 邻居表)
  │
  ├─> device_id (外键 -> devices.device_id)
  ├─> neighbor_chassis_id (用于匹配设备)
  ├─> neighbor_mgmt_addr (用于匹配设备)
  └─> neighbor_system_name (用于匹配设备)

topologies (拓扑表)
  │
  ├─> id (主键)
  ├─> is_auto_discovery (是否自动发现)
  └─> discovery_interval (发现间隔)

topology_nodes (拓扑节点表)
  │
  ├─> topology_id (外键 -> topologies.id)
  └─> device_id (外键 -> devices.device_id)

topology_links (拓扑链路表)
  │
  ├─> topology_id (外键 -> topologies.id)
  ├─> source_node_id (外键 -> topology_nodes.id)
  └─> target_node_id (外键 -> topology_nodes.id)
```

## 8. 总结

### 8.1 当前状态

✅ **已完成**:
- 数据库表结构
- Repository 层实现
- Service 层实现（部分）
- 自动发现算法实现

❌ **缺失**:
- LLDP 数据上报 API
- 自动发现触发 API
- 采集端 LLDP 插件
- 定时任务支持

### 8.2 下一步行动

1. **立即实现**（本次）:
   - 添加 LLDP 数据上报 API
   - 添加自动发现触发 API

2. **后续实现**:
   - 开发 LLDP 采集插件
   - 添加定时任务支持
   - 优化匹配算法

### 8.3 关键点

1. **数据来源**: LLDP 数据必须从采集端上报，无法在中心端主动获取
2. **匹配策略**: 使用多级匹配策略（Chassis ID > IP > 系统名称）
3. **去重机制**: 避免重复创建节点和链路
4. **权限控制**: 自动发现需要 `topology.write` 权限

