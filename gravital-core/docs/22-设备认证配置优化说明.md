# 设备认证配置优化说明

## 概述

优化了设备管理中的认证信息配置，支持不同协议使用不同的认证方式，使认证配置更加灵活和规范，便于后续给其他采集插件使用。

## 问题分析

### 原有问题

1. **认证信息不统一**: 所有协议都使用相同的用户名和密码字段
2. **SNMP 支持不完整**: 
   - SNMP v1/v2c 只需要 community，但使用了用户名密码字段
   - SNMP v3 需要复杂的认证配置（安全级别、认证协议、隐私协议等），但无法配置
3. **SSH 支持不完整**: 只支持密码认证，不支持密钥认证
4. **HTTP/HTTPS 支持不完整**: 无法配置 API Key、Bearer Token 等认证方式
5. **扩展性差**: 新增协议或认证方式需要修改多处代码

## 解决方案

### 1. 定义统一的认证配置类型

**文件**: `web/src/types/auth.ts`

定义了完整的认证配置类型体系：

```typescript
// SNMP v1/v2c 认证
interface SNMPv1v2cAuth {
  community: string
}

// SNMP v3 认证
interface SNMPv3Auth {
  username: string
  security_level: 'noAuthNoPriv' | 'authNoPriv' | 'authPriv'
  auth_protocol?: 'MD5' | 'SHA' | 'SHA224' | 'SHA256' | 'SHA384' | 'SHA512'
  auth_password?: string
  priv_protocol?: 'DES' | 'AES' | 'AES192' | 'AES256'
  priv_password?: string
  context_name?: string
}

// SSH 认证
interface SSHAuth {
  username: string
  password?: string
  private_key?: string
  passphrase?: string
  auth_method?: 'password' | 'key' | 'both'
}

// HTTP/HTTPS 认证
interface HTTPAuth {
  username?: string
  password?: string
  api_key?: string
  api_key_header?: string
  bearer_token?: string
  custom_headers?: Record<string, string>
}

// 通用认证配置
type AuthConfig = 
  | { type: 'snmp_v1' | 'snmp_v2c'; config: SNMPv1v2cAuth }
  | { type: 'snmp_v3'; config: SNMPv3Auth }
  | { type: 'ssh'; config: SSHAuth }
  | { type: 'http' | 'https'; config: HTTPAuth }
  | { type: 'none'; config: Record<string, never> }
```

### 2. 创建认证配置组件

**文件**: `web/src/components/common/AuthConfig.vue`

#### 2.1 功能特性

- **动态显示**: 根据协议和版本动态显示不同的认证字段
- **智能默认值**: 自动设置合理的默认值
- **字段联动**: 根据选择自动显示/隐藏相关字段
- **数据验证**: 集成表单验证规则

#### 2.2 支持的认证方式

**SNMP v1/v2c**:
- Community（必填）

**SNMP v3**:
- 用户名（必填）
- 安全级别（必填）:
  - noAuthNoPriv: 无认证无加密
  - authNoPriv: 认证无加密（需要认证协议和密码）
  - authPriv: 认证加密（需要认证协议、认证密码、隐私协议、隐私密码）
- 认证协议: MD5, SHA, SHA224, SHA256, SHA384, SHA512
- 认证密码
- 隐私协议: DES, AES, AES192, AES256
- 隐私密码
- Context Name（可选）

**SSH**:
- 认证方式:
  - password: 密码认证
  - key: 密钥认证
  - both: 密码或密钥
- 用户名（必填）
- 密码（当使用密码认证时）
- 私钥（当使用密钥认证时）
- 私钥密码（可选）

**HTTP/HTTPS**:
- 认证类型:
  - none: 无认证
  - basic: Basic Auth（用户名/密码）
  - apikey: API Key（API Key + Header 名称）
  - bearer: Bearer Token
  - custom: 自定义 Header（支持多个）

### 3. 更新设备表单

**文件**: `web/src/views/Devices/List.vue`

#### 3.1 主要改动

1. **添加 SNMP 版本选择**: 当协议为 SNMP 时，显示版本选择
2. **集成 AuthConfig 组件**: 替换原有的用户名/密码字段
3. **协议变化处理**: 协议变化时自动重置端口和认证配置
4. **兼容性转换**: 编辑设备时，自动将旧数据格式转换为新格式

#### 3.2 数据格式

**新格式**:
```json
{
  "connection_config": {
    "host": "192.168.1.1",
    "port": 161,
    "protocol": "snmp",
    "snmp_version": "3",
    "auth": {
      "type": "snmp_v3",
      "config": {
        "username": "admin",
        "security_level": "authPriv",
        "auth_protocol": "SHA",
        "auth_password": "authpass123",
        "priv_protocol": "AES",
        "priv_password": "privpass123"
      }
    }
  }
}
```

**旧格式（兼容）**:
```json
{
  "connection_config": {
    "host": "192.168.1.1",
    "port": 161,
    "protocol": "snmp",
    "username": "admin",
    "password": "public"
  }
}
```

## 数据存储

### 数据库结构

设备表的 `connection_config` 字段（JSONB）存储完整的连接和认证配置：

```sql
connection_config JSONB
```

### 存储格式示例

#### SNMP v2c
```json
{
  "host": "192.168.1.1",
  "port": 161,
  "protocol": "snmp",
  "snmp_version": "2c",
  "auth": {
    "type": "snmp_v2c",
    "config": {
      "community": "public"
    }
  }
}
```

#### SNMP v3
```json
{
  "host": "192.168.1.1",
  "port": 161,
  "protocol": "snmp",
  "snmp_version": "3",
  "auth": {
    "type": "snmp_v3",
    "config": {
      "username": "admin",
      "security_level": "authPriv",
      "auth_protocol": "SHA",
      "auth_password": "authpass123",
      "priv_protocol": "AES",
      "priv_password": "privpass123"
    }
  }
}
```

#### SSH
```json
{
  "host": "192.168.1.1",
  "port": 22,
  "protocol": "ssh",
  "auth": {
    "type": "ssh",
    "config": {
      "username": "admin",
      "password": "password123",
      "auth_method": "password"
    }
  }
}
```

#### HTTP API Key
```json
{
  "host": "api.example.com",
  "port": 443,
  "protocol": "https",
  "auth": {
    "type": "https",
    "config": {
      "auth_type": "apikey",
      "api_key": "sk-1234567890",
      "api_key_header": "X-API-Key"
    }
  }
}
```

## 使用示例

### 1. 创建 SNMP v2c 设备

```typescript
const device = {
  name: "交换机-01",
  device_type: "switch",
  connection_config: {
    host: "192.168.1.1",
    port: 161,
    protocol: "snmp",
    snmp_version: "2c",
    auth: {
      type: "snmp_v2c",
      config: {
        community: "public"
      }
    }
  }
}
```

### 2. 创建 SNMP v3 设备

```typescript
const device = {
  name: "路由器-01",
  device_type: "router",
  connection_config: {
    host: "192.168.1.2",
    port: 161,
    protocol: "snmp",
    snmp_version: "3",
    auth: {
      type: "snmp_v3",
      config: {
        username: "admin",
        security_level: "authPriv",
        auth_protocol: "SHA",
        auth_password: "authpass123",
        priv_protocol: "AES",
        priv_password: "privpass123"
      }
    }
  }
}
```

### 3. 创建 SSH 设备（密钥认证）

```typescript
const device = {
  name: "服务器-01",
  device_type: "server",
  connection_config: {
    host: "192.168.1.10",
    port: 22,
    protocol: "ssh",
    auth: {
      type: "ssh",
      config: {
        username: "root",
        private_key: "-----BEGIN RSA PRIVATE KEY-----\n...",
        passphrase: "keypass123",
        auth_method: "key"
      }
    }
  }
}
```

## 插件使用

采集插件可以从 `connection_config` 中获取认证信息：

```go
// 在插件中获取认证配置
func (p *MyPlugin) Collect(ctx context.Context, task *plugin.CollectionTask) ([]*plugin.Metric, error) {
    deviceConfig := task.DeviceConfig
    
    // 获取协议
    protocol := deviceConfig["protocol"].(string)
    
    // 获取认证配置
    authRaw := deviceConfig["auth"]
    if authMap, ok := authRaw.(map[string]interface{}); ok {
        authType := authMap["type"].(string)
        authConfig := authMap["config"].(map[string]interface{})
        
        switch authType {
        case "snmp_v2c":
            community := authConfig["community"].(string)
            // 使用 community 连接 SNMP
            
        case "snmp_v3":
            username := authConfig["username"].(string)
            securityLevel := authConfig["security_level"].(string)
            authProtocol := authConfig["auth_protocol"].(string)
            authPassword := authConfig["auth_password"].(string)
            // 使用 SNMP v3 配置连接
            
        case "ssh":
            username := authConfig["username"].(string)
            authMethod := authConfig["auth_method"].(string)
            if authMethod == "password" || authMethod == "both" {
                password := authConfig["password"].(string)
                // 使用密码认证
            }
            if authMethod == "key" || authMethod == "both" {
                privateKey := authConfig["private_key"].(string)
                passphrase := authConfig["passphrase"].(string)
                // 使用密钥认证
            }
        }
    }
    
    // ...
}
```

## 兼容性处理

### 旧数据兼容

系统会自动将旧格式的数据转换为新格式：

```typescript
function convertLegacyAuth(config: any) {
  if (config.protocol === 'snmp') {
    const version = config.snmp_version || '2c'
    if (version === '3') {
      // 转换 SNMP v3
    } else {
      // 转换 SNMP v1/v2c
      return {
        type: `snmp_${version}`,
        config: {
          community: config.community || config.password || 'public'
        }
      }
    }
  }
  // ... 其他协议
}
```

### 迁移建议

1. **新设备**: 直接使用新格式
2. **旧设备**: 编辑时会自动转换，无需手动迁移
3. **批量迁移**: 可以编写脚本批量更新旧数据

## 扩展性

### 添加新协议

1. 在 `auth.ts` 中定义新的认证类型
2. 在 `AuthConfig.vue` 中添加对应的表单字段
3. 在 `convertLegacyAuth` 中添加兼容性转换

### 添加新认证方式

例如，为 SSH 添加证书认证：

```typescript
interface SSHAuth {
  // ... 现有字段
  certificate?: string  // 新增证书字段
  certificate_key?: string
}
```

## 相关文件

### 新增文件
- `web/src/types/auth.ts` - 认证配置类型定义
- `web/src/components/common/AuthConfig.vue` - 认证配置组件
- `docs/22-设备认证配置优化说明.md` - 本文档

### 修改文件
- `web/src/views/Devices/List.vue` - 设备表单更新

## 测试建议

### 1. 功能测试

- [ ] SNMP v1/v2c 设备创建和编辑
- [ ] SNMP v3 设备创建和编辑（不同安全级别）
- [ ] SSH 设备创建和编辑（密码/密钥/混合）
- [ ] HTTP/HTTPS 设备创建和编辑（不同认证类型）
- [ ] 协议切换时认证配置重置
- [ ] 旧数据格式兼容性

### 2. 数据验证

- [ ] 必填字段验证
- [ ] 字段联动验证
- [ ] 数据格式验证

### 3. 插件集成测试

- [ ] LLDP 插件读取 SNMP 认证配置
- [ ] 其他插件读取对应协议的认证配置

## 总结

✅ **已完成**:
- 统一的认证配置类型体系
- 灵活的认证配置组件
- 完整的协议支持（SNMP v1/v2c/v3, SSH, HTTP/HTTPS）
- 旧数据兼容性处理
- 良好的扩展性

现在设备认证配置已经标准化和规范化，可以方便地被各种采集插件使用！

