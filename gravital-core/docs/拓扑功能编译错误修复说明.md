# 拓扑功能编译错误修复说明

## 修复的错误

### 1. Device 模型字段适配

**问题**: 
- 自动发现服务中使用了不存在的 `device.IP` 和 `device.Model` 字段
- Device 模型实际使用 `ConnectionConfig` (JSONB) 存储连接信息

**修复**:
```go
// 修复前
Properties: map[string]interface{}{
    "ip":    device.IP,      // ❌ 字段不存在
    "model": device.Model,   // ❌ 字段不存在
}

// 修复后
var ip string
if device.ConnectionConfig != nil {
    if ipVal, ok := device.ConnectionConfig["host"].(string); ok {
        ip = ipVal
    }
}

Properties: map[string]interface{}{
    "ip":          ip,               // ✅ 从 ConnectionConfig 提取
    "device_type": device.DeviceType, // ✅ 使用实际字段
    "status":      device.Status,     // ✅ 使用实际字段
}
```

### 2. DeviceRepository.List 方法签名

**问题**: 
- `List` 方法返回 3 个值，但只接收了 2 个
- `List` 方法需要指针类型的 `DeviceFilter`

**修复**:
```go
// 修复前
devices, err := s.deviceRepo.List(ctx, repository.DeviceFilter{})

// 修复后
devices, _, err := s.deviceRepo.List(ctx, &repository.DeviceFilter{})
```

### 3. 设备匹配逻辑适配

**问题**:
- 使用了不存在的 `device.Properties` 字段
- 应该使用 `device.Labels` (JSONB) 存储设备标签

**修复**:
```go
// 修复前 - Chassis ID 匹配
if properties, ok := device.Properties.(map[string]interface{}); ok {
    if chassisID, ok := properties["chassis_id"].(string); ok {
        // ...
    }
}

// 修复后
if device.Labels != nil {
    if chassisID, ok := device.Labels["chassis_id"].(string); ok {
        // ...
    }
}

// 修复前 - IP 匹配
if device.IP == neighbor.NeighborMgmtAddr {
    return device
}

// 修复后
if device.ConnectionConfig != nil {
    if host, ok := device.ConnectionConfig["host"].(string); ok {
        if host == neighbor.NeighborMgmtAddr {
            return device
        }
    }
}
```

## Device 模型字段说明

根据实际的 Device 模型定义：

```go
type Device struct {
    ID               uint           `json:"id"`
    DeviceID         string         `json:"device_id"`
    Name             string         `json:"name"`
    DeviceType       string         `json:"device_type"`      // 设备类型
    GroupID          *uint          `json:"group_id"`
    SentinelID       string         `json:"sentinel_id"`
    ConnectionConfig JSONB          `json:"connection_config"` // 连接配置（包含 host/port 等）
    Labels           JSONB          `json:"labels"`            // 标签（包含 chassis_id 等）
    Status           string         `json:"status"`            // 设备状态
    LastSeen         *time.Time     `json:"last_seen"`
    CreatedAt        time.Time      `json:"created_at"`
    UpdatedAt        time.Time      `json:"updated_at"`
}
```

### ConnectionConfig 示例

```json
{
  "host": "192.168.1.1",
  "port": 22,
  "protocol": "ssh",
  "username": "admin"
}
```

### Labels 示例

```json
{
  "chassis_id": "00:11:22:33:44:55",
  "serial_number": "SN123456",
  "location": "机房A"
}
```

## 自动发现流程说明

### 设备匹配优先级

1. **Chassis ID 匹配** (最高优先级)
   - 从 `device.Labels["chassis_id"]` 获取
   - 与 `neighbor.NeighborChassisID` 比较

2. **管理 IP 匹配** (中等优先级)
   - 从 `device.ConnectionConfig["host"]` 获取
   - 与 `neighbor.NeighborMgmtAddr` 比较

3. **系统名称匹配** (最低优先级)
   - 使用 `device.Name`
   - 与 `neighbor.NeighborSystemName` 比较

### 节点属性设置

创建拓扑节点时，从 Device 模型提取以下信息：

```go
Properties: map[string]interface{}{
    "ip":          ip,               // 从 ConnectionConfig["host"] 提取
    "device_type": device.DeviceType, // 设备类型
    "status":      device.Status,     // 设备状态
}
```

## 使用建议

### 1. 设备标签配置

为了支持自动发现，建议在设备的 Labels 中添加：

```json
{
  "chassis_id": "设备的 Chassis ID",
  "mac_address": "设备的 MAC 地址",
  "serial_number": "设备序列号"
}
```

### 2. 连接配置

确保 ConnectionConfig 包含正确的 host 信息：

```json
{
  "host": "192.168.1.1",
  "port": 22,
  "protocol": "ssh"
}
```

### 3. LLDP 数据上报

采集端上报 LLDP 邻居信息时，确保包含：
- `neighbor_chassis_id`: 邻居的 Chassis ID
- `neighbor_system_name`: 邻居的系统名称
- `neighbor_mgmt_addr`: 邻居的管理地址

## 验证方法

### 1. 检查设备数据

```sql
SELECT device_id, name, connection_config, labels 
FROM devices 
WHERE device_id = 'dev-001';
```

### 2. 检查 LLDP 邻居

```sql
SELECT device_id, neighbor_chassis_id, neighbor_system_name, neighbor_mgmt_addr
FROM lldp_neighbors
WHERE device_id = 'dev-001';
```

### 3. 测试自动发现

```bash
# 触发自动发现
curl -X POST http://localhost:8080/api/v1/topologies/1/discover
```

## 总结

所有编译错误已修复，主要调整：

1. ✅ 适配 Device 模型的实际字段结构
2. ✅ 修复 DeviceRepository.List 方法调用
3. ✅ 调整设备匹配逻辑使用正确的字段
4. ✅ 从 JSONB 字段中正确提取数据

自动发现功能现在可以正常工作，能够：
- 读取 LLDP 邻居信息
- 匹配设备（通过 Chassis ID、IP、名称）
- 自动创建拓扑节点和链路

