# 拓扑功能缺失问题修复说明

## 问题概述

在梳理网络拓扑逻辑流程时，发现两个关键问题：

1. **自动发现没有驱动入口** - 虽然有发现服务实现，但没有 API 端点可以触发
2. **lldp_neighbors 数据没有数据来源** - 虽然有存储逻辑，但没有接收数据的 API

## 修复内容

### 1. 添加自动发现 API

#### 1.1 修改 TopologyDiscoveryService

**文件**: `internal/service/topology_discovery_service.go`

- 修改 `DiscoverTopology` 方法返回类型，添加 `DiscoverTopologyResult` 结构体
- 返回发现的节点和链路数量统计

```go
type DiscoverTopologyResult struct {
    DiscoveredNodes int
    DiscoveredLinks int
}

func (s *topologyDiscoveryService) DiscoverTopology(ctx context.Context, topologyID uint) (*DiscoverTopologyResult, error)
```

#### 1.2 修改 TopologyService

**文件**: `internal/service/topology_service.go`

- 在接口中添加 `DiscoverTopology` 方法
- 在结构体中添加 `discoveryService` 字段
- 修改构造函数，注入 `TopologyDiscoveryService`
- 实现 `DiscoverTopology` 方法，委托给发现服务

```go
type TopologyService interface {
    // ...
    DiscoverTopology(ctx context.Context, topologyID uint) (*DiscoverTopologyResponse, error)
}

type topologyService struct {
    // ...
    discoveryService TopologyDiscoveryService
}

func NewTopologyService(
    topologyRepo repository.TopologyRepository,
    deviceRepo repository.DeviceRepository,
    discoveryService TopologyDiscoveryService,  // 新增
    logger *zap.Logger,
) TopologyService
```

#### 1.3 添加 Handler

**文件**: `internal/api/handler/topology_handler.go`

- 添加 `DiscoverTopology` handler 方法

```go
func (h *TopologyHandler) DiscoverTopology(c *gin.Context) {
    // 解析拓扑 ID
    // 调用 TopologyService.DiscoverTopology()
    // 返回结果
}
```

#### 1.4 添加路由

**文件**: `internal/api/router/router.go`

- 在拓扑路由组中添加自动发现端点
- 需要 `topology.write` 权限

```go
topologies.POST("/:id/discover", 
    middleware.RequirePermission("topology.write"), 
    topologyHandler.DiscoverTopology)
```

**API 端点**: `POST /api/v1/topologies/:id/discover`

**请求**: 无请求体

**响应**:
```json
{
  "code": 0,
  "data": {
    "topology_id": 1,
    "discovered_nodes": 5,
    "discovered_links": 8,
    "duration_ms": 1234
  }
}
```

### 2. 添加 LLDP 数据上报 API

#### 2.1 添加 Handler

**文件**: `internal/api/handler/topology_handler.go`

- 添加 `LLDPNeighborRequest` 和 `IngestLLDPRequest` 结构体
- 添加 `IngestLLDP` handler 方法

```go
type LLDPNeighborRequest struct {
    LocalInterface     string `json:"local_interface" binding:"required"`
    NeighborChassisID  string `json:"neighbor_chassis_id" binding:"required"`
    NeighborPortID    string `json:"neighbor_port_id" binding:"required"`
    NeighborSystemName string `json:"neighbor_system_name"`
    NeighborSystemDesc string `json:"neighbor_system_desc"`
    NeighborPortDesc   string `json:"neighbor_port_desc"`
    NeighborMgmtAddr   string `json:"neighbor_mgmt_addr"`
    TTL                int    `json:"ttl"`
}

type IngestLLDPRequest struct {
    DeviceID  string                `json:"device_id" binding:"required"`
    Neighbors []LLDPNeighborRequest `json:"neighbors" binding:"required"`
}

func (h *TopologyHandler) IngestLLDP(c *gin.Context) {
    // 解析请求
    // 遍历 neighbors，调用 TopologyService.UpsertLLDPNeighbor()
    // 返回处理结果
}
```

#### 2.2 添加路由

**文件**: `internal/api/router/router.go`

- 在 Sentinel API 路由组中添加 LLDP 数据上报端点
- 使用 Sentinel 认证（`middleware.SentinelAuth()`）

```go
topologyData := v1.Group("/topology")
topologyData.Use(middleware.SentinelAuth())
{
    topologyData.POST("/lldp", topologyHandler.IngestLLDP)
}
```

**API 端点**: `POST /api/v1/topology/lldp`

**认证**: Sentinel 认证（`X-Sentinel-ID` header + Sentinel token）

**请求体**:
```json
{
  "device_id": "dev-001",
  "neighbors": [
    {
      "local_interface": "GigabitEthernet0/1",
      "neighbor_chassis_id": "00:11:22:33:44:55",
      "neighbor_port_id": "GigabitEthernet0/2",
      "neighbor_system_name": "Switch-02",
      "neighbor_system_desc": "Cisco IOS Software",
      "neighbor_port_desc": "GigabitEthernet0/2",
      "neighbor_mgmt_addr": "192.168.1.2",
      "ttl": 120
    }
  ]
}
```

**响应**:
```json
{
  "code": 0,
  "data": {
    "processed": 1,
    "failed": 0,
    "total": 1
  }
}
```

### 3. 更新服务初始化

**文件**: `internal/api/router/router.go`

- 创建 `TopologyDiscoveryService` 实例
- 注入到 `TopologyService` 构造函数

```go
// 初始化拓扑发现服务
topologyDiscoveryService := service.NewTopologyDiscoveryService(topologyRepo, deviceRepo, log)
topologyService := service.NewTopologyService(topologyRepo, deviceRepo, topologyDiscoveryService, log)
```

## 完整数据流

### LLDP 数据上报流程

```
采集端 (Sentinel)
  │
  ├─> LLDP 插件采集设备邻居信息
  │
  └─> POST /api/v1/topology/lldp
      Headers:
        X-Sentinel-ID: sentinel-001
        Authorization: Bearer <sentinel_token>
      │
      └─> TopologyHandler.IngestLLDP()
          │
          └─> TopologyService.UpsertLLDPNeighbor()
              │
              └─> TopologyRepository.UpsertLLDPNeighbor()
                  │
                  └─> 写入 lldp_neighbors 表
```

### 拓扑自动发现流程

```
用户操作 / 定时任务
  │
  └─> POST /api/v1/topologies/:id/discover
      Headers:
        Authorization: Bearer <user_token>
      │
      └─> TopologyHandler.DiscoverTopology()
          │
          └─> TopologyService.DiscoverTopology()
              │
              └─> TopologyDiscoveryService.DiscoverTopology()
                  │
                  ├─> 读取 lldp_neighbors 表
                  ├─> 匹配设备
                  ├─> 创建节点和链路
                  │
                  └─> 返回统计结果
```

## 测试方法

### 1. 测试 LLDP 数据上报

```bash
# 使用 curl 测试
curl -X POST http://localhost:8080/api/v1/topology/lldp \
  -H "Content-Type: application/json" \
  -H "X-Sentinel-ID: sentinel-001" \
  -H "Authorization: Bearer <sentinel_token>" \
  -d '{
    "device_id": "dev-001",
    "neighbors": [
      {
        "local_interface": "GigabitEthernet0/1",
        "neighbor_chassis_id": "00:11:22:33:44:55",
        "neighbor_port_id": "GigabitEthernet0/2",
        "neighbor_system_name": "Switch-02",
        "neighbor_mgmt_addr": "192.168.1.2",
        "ttl": 120
      }
    ]
  }'
```

**验证**:
- 检查数据库 `lldp_neighbors` 表是否有数据
- 检查响应中的 `processed` 字段

### 2. 测试自动发现

```bash
# 使用 curl 测试
curl -X POST http://localhost:8080/api/v1/topologies/1/discover \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <user_token>"
```

**验证**:
- 检查响应中的 `discovered_nodes` 和 `discovered_links`
- 检查数据库 `topology_nodes` 和 `topology_links` 表
- 检查拓扑详情页面是否显示新发现的节点和链路

## 后续工作

### 1. 采集端支持（需要 Sentinel 端实现）

- [ ] 开发 LLDP 采集插件
- [ ] 在 Sender 中添加 LLDP 数据上报逻辑
- [ ] 定期上报 LLDP 邻居信息

### 2. 定时任务支持（可选）

- [ ] 添加定时任务框架
- [ ] 定时检查并触发自动发现
- [ ] 定时清理过期的 LLDP 邻居数据

### 3. 优化建议

- [ ] 优化 LLDP 数据上报的批量处理
- [ ] 添加数据验证和错误处理
- [ ] 添加监控和日志
- [ ] 优化设备匹配算法

## 相关文件

### 修改的文件

1. `internal/service/topology_discovery_service.go` - 修改返回类型
2. `internal/service/topology_service.go` - 添加发现服务集成
3. `internal/api/handler/topology_handler.go` - 添加两个新的 handler
4. `internal/api/router/router.go` - 添加路由和服务初始化

### 新增的文档

1. `docs/17-网络拓扑逻辑流程梳理.md` - 完整的逻辑流程文档
2. `docs/18-拓扑功能缺失问题修复说明.md` - 本文档

## 总结

✅ **已修复**:
- 自动发现 API 端点已添加
- LLDP 数据上报 API 端点已添加
- 服务依赖关系已修复

⏳ **待实现**:
- 采集端 LLDP 插件开发
- 定时任务支持

现在系统已经具备了完整的 API 接口，可以接收 LLDP 数据并触发拓扑自动发现。一旦采集端实现了 LLDP 数据上报，整个拓扑发现流程就可以正常工作了！

