# 拓扑自动发现定时任务实现说明

## 概述

实现了拓扑自动发现的定时任务调度器，可以定期检查并触发启用自动发现的拓扑进行自动发现，同时定期清理过期的 LLDP 邻居数据。

## 实现内容

### 1. 创建 TopologyDiscoveryScheduler

**文件**: `internal/service/topology_discovery_scheduler.go`

#### 1.1 结构体定义

```go
type TopologyDiscoveryScheduler struct {
    topologyRepo        repository.TopologyRepository
    discoveryService    TopologyDiscoveryService
    db                  *gorm.DB
    logger              *zap.Logger
    checkInterval       time.Duration // 检查间隔
    cleanupInterval     time.Duration // 清理间隔
    ticker              *time.Ticker
    cleanupTicker       *time.Ticker
    done                chan struct{}
    ctx                 context.Context
    cancel              context.CancelFunc
}
```

#### 1.2 核心功能

1. **定时检查自动发现**
   - 每 5 分钟检查一次（可配置）
   - 查找所有 `is_auto_discovery=true` 的拓扑
   - 根据 `discovery_interval` 和 `last_discovery_at` 判断是否需要触发
   - 异步执行发现任务，避免阻塞

2. **定时清理过期数据**
   - 每小时清理一次（可配置）
   - 删除 24 小时未更新的 LLDP 邻居数据

### 2. 触发逻辑

#### 2.1 判断是否需要发现

```go
func (s *TopologyDiscoveryScheduler) shouldDiscover(topology model.Topology, now time.Time) bool {
    // 如果没有设置发现间隔，默认不触发
    if topology.DiscoveryInterval <= 0 {
        return false
    }

    // 如果从未发现过，立即触发
    if topology.LastDiscoveryAt == nil {
        return true
    }

    // 计算下次发现时间
    nextDiscoveryTime := topology.LastDiscoveryAt.Add(
        time.Duration(topology.DiscoveryInterval) * time.Second
    )

    // 如果已经超过发现间隔，触发发现
    return now.After(nextDiscoveryTime)
}
```

#### 2.2 发现流程

1. 获取所有启用自动发现的拓扑
2. 遍历每个拓扑，判断是否需要触发
3. 如果需要，异步调用 `TopologyDiscoveryService.DiscoverTopology()`
4. 记录发现结果（节点数、链路数）

### 3. 集成到主程序

**文件**: `cmd/server/main.go`

#### 3.1 启动调度器

```go
// 启动拓扑自动发现调度器
logger.Info("Starting topology discovery scheduler...")
topologyRepo := repository.NewTopologyRepository(db)
deviceRepo := repository.NewDeviceRepository(db)
topologyDiscoveryService := service.NewTopologyDiscoveryService(
    topologyRepo, 
    deviceRepo, 
    logger.Get()
)
topologyDiscoveryScheduler := service.NewTopologyDiscoveryScheduler(
    topologyRepo,
    topologyDiscoveryService,
    db,
    logger.Get(),
    &service.TopologyDiscoverySchedulerConfig{
        CheckInterval:   5 * time.Minute,  // 每 5 分钟检查一次
        CleanupInterval: 1 * time.Hour,    // 每小时清理一次过期数据
    },
)
topologyDiscoveryScheduler.Start()
logger.Info("Topology discovery scheduler started")
```

#### 3.2 优雅关闭

```go
// 停止拓扑自动发现调度器
logger.Info("Stopping topology discovery scheduler...")
topologyDiscoveryScheduler.Stop()
```

## 工作流程

### 定时发现流程

```
启动调度器
  │
  ├─> 立即执行一次检查
  │
  └─> 每 5 分钟执行一次
      │
      ├─> 查询 is_auto_discovery=true 的拓扑
      │
      ├─> 遍历每个拓扑
      │   │
      │   ├─> 检查 discovery_interval
      │   ├─> 检查 last_discovery_at
      │   └─> 判断是否需要触发
      │
      └─> 如果需要，异步触发发现
          │
          └─> TopologyDiscoveryService.DiscoverTopology()
              │
              ├─> 读取 LLDP 邻居数据
              ├─> 匹配设备
              ├─> 创建节点和链路
              └─> 更新 last_discovery_at
```

### 定时清理流程

```
启动清理任务
  │
  ├─> 立即执行一次清理
  │
  └─> 每小时执行一次
      │
      └─> TopologyDiscoveryService.CleanupStaleNeighbors()
          │
          └─> 删除 24 小时未更新的 LLDP 邻居
```

## 配置说明

### 调度器配置

```go
type TopologyDiscoverySchedulerConfig struct {
    CheckInterval   time.Duration // 检查间隔，默认 5 分钟
    CleanupInterval time.Duration // 清理间隔，默认 1 小时
}
```

### 拓扑配置

拓扑表中的相关字段：

- `is_auto_discovery`: 是否启用自动发现（boolean）
- `discovery_interval`: 发现间隔（秒）
- `last_discovery_at`: 最后发现时间（timestamp）

## 使用示例

### 1. 启用拓扑自动发现

```sql
UPDATE topologies 
SET 
    is_auto_discovery = true,
    discovery_interval = 3600  -- 1 小时
WHERE id = 1;
```

### 2. 手动触发发现（不依赖定时任务）

```bash
curl -X POST http://localhost:8080/api/v1/topologies/1/discover \
  -H "Authorization: Bearer <token>"
```

### 3. 查看发现结果

```sql
SELECT 
    id,
    name,
    is_auto_discovery,
    discovery_interval,
    last_discovery_at
FROM topologies
WHERE is_auto_discovery = true;
```

## 日志说明

### 启动日志

```
INFO    Starting topology discovery scheduler...
INFO    Topology discovery scheduler started    {"check_interval": "5m0s", "cleanup_interval": "1h0m0s"}
```

### 检查日志

```
DEBUG   Checking topologies for auto-discovery  {"count": 2}
INFO    Triggering auto-discovery for topology   {"topology_id": 1, "name": "数据中心拓扑"}
INFO    Triggered auto-discovery                 {"count": 1}
```

### 发现结果日志

```
INFO    Auto-discovery completed                 {
    "topology_id": 1,
    "discovered_nodes": 5,
    "discovered_links": 8
}
```

### 清理日志

```
DEBUG   Starting cleanup of stale LLDP neighbors
DEBUG   Completed cleanup of stale LLDP neighbors
```

## 性能考虑

### 1. 异步执行

- 发现任务异步执行，不会阻塞调度器
- 每个发现任务有 5 分钟超时限制

### 2. 批量处理

- 一次检查所有拓扑，避免频繁查询数据库
- 使用 goroutine 并发执行多个发现任务

### 3. 资源控制

- 使用 context 控制超时
- 优雅关闭时等待任务完成

## 故障处理

### 1. 发现失败

- 记录错误日志，不影响其他拓扑
- 下次检查时会重试

### 2. 数据库连接失败

- 记录错误日志
- 等待下次检查周期

### 3. 服务关闭

- 优雅关闭，等待正在执行的任务完成
- 停止所有定时器

## 测试建议

### 1. 单元测试

- 测试 `shouldDiscover` 逻辑
- 测试配置加载
- 测试启动和停止

### 2. 集成测试

- 创建测试拓扑，启用自动发现
- 插入 LLDP 邻居数据
- 等待定时任务触发
- 验证节点和链路是否创建

### 3. 性能测试

- 测试大量拓扑的检查性能
- 测试并发发现的性能
- 测试清理操作的性能

## 后续优化

### 1. 配置化

- 将检查间隔和清理间隔移到配置文件
- 支持动态调整

### 2. 监控指标

- 添加发现次数统计
- 添加发现耗时统计
- 添加失败率统计

### 3. 告警

- 发现失败时发送告警
- 长时间未发现时发送告警

## 相关文件

- `internal/service/topology_discovery_scheduler.go` - 调度器实现
- `internal/service/topology_discovery_service.go` - 发现服务
- `cmd/server/main.go` - 主程序集成
- `docs/17-网络拓扑逻辑流程梳理.md` - 逻辑流程文档

## 总结

✅ **已实现**:
- 定时检查自动发现拓扑
- 根据配置自动触发发现
- 定时清理过期 LLDP 数据
- 优雅启动和关闭

⏳ **待优化**:
- 配置化检查间隔
- 添加监控指标
- 添加告警机制

现在系统已经具备了完整的自动发现功能，包括手动触发和定时自动触发两种方式！

