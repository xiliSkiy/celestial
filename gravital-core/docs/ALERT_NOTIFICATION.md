# å‘Šè­¦é€šçŸ¥åŠŸèƒ½å®ç°æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å‘Šè­¦é€šçŸ¥åŠŸèƒ½çš„å®ç°ï¼ŒåŒ…æ‹¬å¤šç§é€šçŸ¥æ¸ é“ã€é€šçŸ¥å»é‡ã€é€šçŸ¥å‡çº§ç­‰åŠŸèƒ½ã€‚

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### å·²å®ç°åŠŸèƒ½

âœ… **å¤šç§é€šçŸ¥æ¸ é“**
- é‚®ä»¶é€šçŸ¥ï¼ˆEmailï¼‰
- Webhook é€šçŸ¥
- é’‰é’‰é€šçŸ¥ï¼ˆDingTalkï¼‰
- ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆWeChat Workï¼‰

âœ… **æ™ºèƒ½å»é‡æœºåˆ¶**
- ç›¸åŒå‘Šè­¦åœ¨æŒ‡å®šæ—¶é—´å†…åªé€šçŸ¥ä¸€æ¬¡
- å¯é…ç½®å»é‡é—´éš”ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰

âœ… **é€šçŸ¥å‡çº§æœºåˆ¶**
- å‘Šè­¦æŒç»­ä¸€å®šæ—¶é—´åå‡çº§é€šçŸ¥
- å¯é…ç½®å‡çº§æ—¶é—´å’Œå‡çº§æ¸ é“

âœ… **å¼‚æ­¥å‘é€**
- é€šçŸ¥å¼‚æ­¥å‘é€ï¼Œä¸é˜»å¡å‘Šè­¦è¯„ä¼°
- æ”¯æŒæ‰¹é‡å‘é€

âœ… **é€šçŸ¥è®°å½•**
- è®°å½•æ‰€æœ‰é€šçŸ¥å‘é€å†å²
- æ”¯æŒæŸ¥è¯¢é€šçŸ¥çŠ¶æ€

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Alert Engine                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ evaluateRule â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ triggerAlert â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Notification Service                       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  1. å»é‡æ£€æŸ¥ (ShouldNotify)                          â”‚  â”‚
â”‚  â”‚  2. å‡çº§æ£€æŸ¥ (shouldEscalate)                        â”‚  â”‚
â”‚  â”‚  3. æ ¼å¼åŒ–å†…å®¹ (formatAlertContent)                  â”‚  â”‚
â”‚  â”‚  4. æ‰¹é‡å‘é€ (SendBatch)                             â”‚  â”‚
â”‚  â”‚  5. è®°å½•ç»“æœ (RecordNotification)                    â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                   â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â–¼          â–¼          â–¼          â–¼             â–¼   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Email   â”‚ â”‚Webhook â”‚ â”‚DingTalkâ”‚ â”‚ WeChat â”‚ â”‚  SMS   â”‚ â”‚
â”‚  â”‚  Sender  â”‚ â”‚ Sender â”‚ â”‚ Sender â”‚ â”‚ Sender â”‚ â”‚ Sender â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
1. å‘Šè­¦è§¦å‘
   â”œâ”€> Alert Engine åˆ›å»º AlertEvent
   â””â”€> è°ƒç”¨ NotificationService.SendAlert()

2. å»é‡æ£€æŸ¥
   â”œâ”€> æŸ¥è¯¢ç¼“å­˜ï¼šæ˜¯å¦åœ¨å»é‡é—´éš”å†…
   â”œâ”€> æ˜¯ â”€â”€> è·³è¿‡é€šçŸ¥
   â””â”€> å¦ â”€â”€> ç»§ç»­

3. å‡çº§æ£€æŸ¥
   â”œâ”€> æŸ¥è¯¢ç¼“å­˜ï¼šé¦–æ¬¡é€šçŸ¥æ—¶é—´
   â”œâ”€> è®¡ç®—æ—¶é—´å·®
   â”œâ”€> è¶…è¿‡å‡çº§æ—¶é—´ â”€â”€> ä½¿ç”¨å‡çº§æ¸ é“
   â””â”€> æœªè¶…è¿‡ â”€â”€> ä½¿ç”¨æ™®é€šæ¸ é“

4. å‡†å¤‡é€šçŸ¥
   â”œâ”€> æ ¼å¼åŒ–ä¸»é¢˜å’Œå†…å®¹
   â”œâ”€> éå†æ‰€æœ‰å¯ç”¨çš„æ¸ é“
   â””â”€> ä¸ºæ¯ä¸ªæ¥æ”¶äººåˆ›å»º Notification

5. æ‰¹é‡å‘é€
   â”œâ”€> å¹¶å‘å‘é€åˆ°æ‰€æœ‰æ¸ é“
   â”œâ”€> æ¯ä¸ªæ¸ é“ç‹¬ç«‹å¤„ç†
   â””â”€> è¿”å›å‘é€ç»“æœ

6. è®°å½•ç»“æœ
   â”œâ”€> ä¿å­˜åˆ° alert_notifications è¡¨
   â”œâ”€> æ›´æ–°å»é‡ç¼“å­˜
   â””â”€> æ›´æ–°å‡çº§ç¼“å­˜
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. é€šçŸ¥æœåŠ¡ (NotificationService)

**æ–‡ä»¶**: `internal/notification/service.go`

**æ ¸å¿ƒæ–¹æ³•**:

```go
type Service interface {
    // å‘é€å•ä¸ªé€šçŸ¥
    Send(ctx context.Context, notification *Notification) (*NotificationResult, error)
    
    // æ‰¹é‡å‘é€é€šçŸ¥
    SendBatch(ctx context.Context, notifications []*Notification) ([]*NotificationResult, error)
    
    // å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆå¸¦å»é‡å’Œå‡çº§ï¼‰
    SendAlert(ctx context.Context, event *model.AlertEvent, config *NotificationConfig) error
    
    // æ³¨å†Œé€šçŸ¥æ¸ é“
    RegisterChannel(channel Channel, sender Sender) error
    
    // å»é‡æ£€æŸ¥
    ShouldNotify(ctx context.Context, alertID string, ruleID uint) (bool, error)
}
```

### 2. é€šçŸ¥æ¸ é“ (Sender)

**æ¥å£å®šä¹‰**:

```go
type Sender interface {
    // å‘é€é€šçŸ¥
    Send(ctx context.Context, notification *Notification) error
    
    // è·å–å‘é€å™¨åç§°
    Name() string
    
    // éªŒè¯é…ç½®
    Validate() error
}
```

**å·²å®ç°çš„æ¸ é“**:

1. **EmailSender** - é‚®ä»¶é€šçŸ¥
   - æ–‡ä»¶: `internal/notification/email.go`
   - æ”¯æŒ SMTP/TLS
   - HTML æ ¼å¼é‚®ä»¶
   - ä¼˜å…ˆçº§é¢œè‰²æ ‡è¯†

2. **WebhookSender** - Webhook é€šçŸ¥
   - æ–‡ä»¶: `internal/notification/webhook.go`
   - æ”¯æŒ GET/POST/PUT
   - è‡ªå®šä¹‰è¯·æ±‚å¤´
   - è¶…æ—¶æ§åˆ¶

3. **DingTalkSender** - é’‰é’‰é€šçŸ¥
   - æ–‡ä»¶: `internal/notification/dingtalk.go`
   - Markdown æ ¼å¼
   - ç­¾åéªŒè¯
   - @ åŠŸèƒ½

4. **WeChatSender** - ä¼ä¸šå¾®ä¿¡é€šçŸ¥
   - æ–‡ä»¶: `internal/notification/wechat.go`
   - Markdown æ ¼å¼
   - @ åŠŸèƒ½

### 3. é€šçŸ¥é…ç½® (NotificationConfig)

```go
type NotificationConfig struct {
    Enabled           bool             // æ˜¯å¦å¯ç”¨é€šçŸ¥
    Channels          []ChannelConfig  // é€šçŸ¥æ¸ é“é…ç½®
    DedupeInterval    int              // å»é‡é—´éš”ï¼ˆç§’ï¼‰
    EscalationEnabled bool             // æ˜¯å¦å¯ç”¨å‡çº§
    EscalationAfter   int              // å‡çº§æ—¶é—´ï¼ˆç§’ï¼‰
    EscalationChannels []Channel       // å‡çº§é€šçŸ¥æ¸ é“
}

type ChannelConfig struct {
    Channel    Channel  // æ¸ é“ç±»å‹
    Enabled    bool     // æ˜¯å¦å¯ç”¨
    Recipients []string // æ¥æ”¶äººåˆ—è¡¨
    Template   string   // æ¶ˆæ¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰
    Config     map[string]interface{} // æ¸ é“ç‰¹å®šé…ç½®
}
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### 1. å‘Šè­¦è§„åˆ™é€šçŸ¥é…ç½®

åœ¨åˆ›å»ºå‘Šè­¦è§„åˆ™æ—¶ï¼Œå¯ä»¥é…ç½®é€šçŸ¥é€‰é¡¹ï¼š

```json
{
  "rule_name": "è®¾å¤‡ç¦»çº¿å‘Šè­¦",
  "severity": "critical",
  "condition": "device_status != 1",
  "notification_config": {
    "enabled": true,
    "dedupe_interval": 300,
    "escalation_enabled": true,
    "escalation_after": 1800,
    "channels": [
      {
        "channel": "email",
        "enabled": true,
        "recipients": ["admin@example.com", "ops@example.com"]
      },
      {
        "channel": "dingtalk",
        "enabled": true,
        "recipients": ["webhook_url_1"]
      }
    ],
    "escalation_channels": ["email", "dingtalk", "wechat"]
  }
}
```

### 2. é‚®ä»¶é…ç½®

**é…ç½®æ–‡ä»¶**: `config/config.yaml`

```yaml
notification:
  email:
    smtp_host: smtp.example.com
    smtp_port: 587
    smtp_user: noreply@example.com
    smtp_password: your_password
    from: Celestial Alert <noreply@example.com>
    use_tls: true
```

### 3. é’‰é’‰é…ç½®

```yaml
notification:
  dingtalk:
    webhook_url: https://oapi.dingtalk.com/robot/send?access_token=xxx
    secret: SEC_xxx  # å¯é€‰ï¼Œç”¨äºç­¾åéªŒè¯
    at_mobiles: []   # @ çš„æ‰‹æœºå·åˆ—è¡¨
    at_all: false    # æ˜¯å¦ @ æ‰€æœ‰äºº
```

### 4. ä¼ä¸šå¾®ä¿¡é…ç½®

```yaml
notification:
  wechat:
    webhook_url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx
    mentioned_list: []        # @ çš„ç”¨æˆ· ID åˆ—è¡¨
    mentioned_mobile_list: [] # @ çš„æ‰‹æœºå·åˆ—è¡¨
```

### 5. Webhook é…ç½®

```yaml
notification:
  webhook:
    url: https://your-webhook-endpoint.com/alerts
    method: POST
    headers:
      Authorization: Bearer your_token
      X-Custom-Header: value
    timeout: 30
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆå§‹åŒ–é€šçŸ¥æœåŠ¡

```go
// åˆ›å»ºé€šçŸ¥æœåŠ¡
notificationSvc := notification.NewService(db, logger)

// æ³¨å†Œé‚®ä»¶æ¸ é“
emailConfig := &notification.EmailConfig{
    SMTPHost:     "smtp.example.com",
    SMTPPort:     587,
    SMTPUser:     "noreply@example.com",
    SMTPPassword: "password",
    From:         "Celestial Alert <noreply@example.com>",
    UseTLS:       true,
}
emailSender := notification.NewEmailSender(emailConfig, logger)
notificationSvc.RegisterChannel(notification.ChannelEmail, emailSender)

// æ³¨å†Œé’‰é’‰æ¸ é“
dingtalkConfig := &notification.DingTalkConfig{
    WebhookURL: "https://oapi.dingtalk.com/robot/send?access_token=xxx",
    Secret:     "SEC_xxx",
}
dingtalkSender := notification.NewDingTalkSender(dingtalkConfig, logger)
notificationSvc.RegisterChannel(notification.ChannelDingTalk, dingtalkSender)

// æ³¨å†Œä¼ä¸šå¾®ä¿¡æ¸ é“
wechatConfig := &notification.WeChatConfig{
    WebhookURL: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx",
}
wechatSender := notification.NewWeChatSender(wechatConfig, logger)
notificationSvc.RegisterChannel(notification.ChannelWeChat, wechatSender)

// æ³¨å†Œ Webhook æ¸ é“
webhookConfig := &notification.WebhookConfig{
    URL:    "https://your-webhook-endpoint.com/alerts",
    Method: "POST",
    Headers: map[string]string{
        "Authorization": "Bearer your_token",
    },
    Timeout: 30,
}
webhookSender := notification.NewWebhookSender(webhookConfig, logger)
notificationSvc.RegisterChannel(notification.ChannelWebhook, webhookSender)
```

### 2. åˆ›å»ºå‘Šè­¦å¼•æ“ï¼ˆå¸¦é€šçŸ¥ï¼‰

```go
alertEngine := engine.NewAlertEngine(db, logger, &engine.Config{
    VMURL:           vmURL,
    CheckInterval:   30 * time.Second,
    NotificationSvc: notificationSvc,  // ä¼ å…¥é€šçŸ¥æœåŠ¡
})
alertEngine.Start()
```

### 3. åˆ›å»ºå¸¦é€šçŸ¥é…ç½®çš„å‘Šè­¦è§„åˆ™

```go
rule := &model.AlertRule{
    RuleName:  "è®¾å¤‡ç¦»çº¿å‘Šè­¦",
    Severity:  "critical",
    Condition: "device_status != 1",
    Enabled:   true,
    NotificationConfig: map[string]interface{}{
        "enabled":            true,
        "dedupe_interval":    300,
        "escalation_enabled": true,
        "escalation_after":   1800,
        "channels": []map[string]interface{}{
            {
                "channel":    "email",
                "enabled":    true,
                "recipients": []string{"admin@example.com"},
            },
            {
                "channel":    "dingtalk",
                "enabled":    true,
                "recipients": []string{"webhook_url"},
            },
        },
        "escalation_channels": []string{"email", "dingtalk", "wechat"},
    },
}
```

---

## ğŸ“Š é€šçŸ¥å†…å®¹æ ¼å¼

### é‚®ä»¶é€šçŸ¥

**ä¸»é¢˜**: `[critical] è®¾å¤‡ç¦»çº¿å‘Šè­¦: å½“å‰å€¼ 0.00 != é˜ˆå€¼ 1.00`

**å†…å®¹** (HTML):
```html
<div style="background-color: #d32f2f; color: white; padding: 10px;">
  <h2>[critical] è®¾å¤‡ç¦»çº¿å‘Šè­¦</h2>
</div>

<div style="padding: 20px; background-color: #f5f5f5;">
  <pre>
å‘Šè­¦è¯¦æƒ…ï¼š
- å‘Šè­¦ID: alert-xxx
- è®¾å¤‡ID: dev-001
- æŒ‡æ ‡åç§°: device_status
- ä¸¥é‡çº§åˆ«: critical
- å‘Šè­¦æ¶ˆæ¯: è®¾å¤‡ç¦»çº¿å‘Šè­¦: å½“å‰å€¼ 0.00 != é˜ˆå€¼ 1.00
- è§¦å‘æ—¶é—´: 2025-11-23 10:00:00
- å½“å‰çŠ¶æ€: firing
  </pre>
</div>

<div style="margin-top: 20px;">
  <h4>è¯¦ç»†ä¿¡æ¯ï¼š</h4>
  <ul>
    <li><strong>event_id:</strong> 123</li>
    <li><strong>device_id:</strong> dev-001</li>
    <li><strong>metric_name:</strong> device_status</li>
  </ul>
</div>
```

### é’‰é’‰é€šçŸ¥

**æ ¼å¼**: Markdown

```markdown
### [critical] è®¾å¤‡ç¦»çº¿å‘Šè­¦

**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥

\`\`\`
å‘Šè­¦è¯¦æƒ…ï¼š
- å‘Šè­¦ID: alert-xxx
- è®¾å¤‡ID: dev-001
- æŒ‡æ ‡åç§°: device_status
- ä¸¥é‡çº§åˆ«: critical
- å‘Šè­¦æ¶ˆæ¯: è®¾å¤‡ç¦»çº¿å‘Šè­¦: å½“å‰å€¼ 0.00 != é˜ˆå€¼ 1.00
- è§¦å‘æ—¶é—´: 2025-11-23 10:00:00
- å½“å‰çŠ¶æ€: firing
\`\`\`

**è¯¦ç»†ä¿¡æ¯**:
- event_id: 123
- device_id: dev-001
- metric_name: device_status

> å‘é€æ—¶é—´: 2025-11-23 10:00:00
```

### Webhook é€šçŸ¥

**æ ¼å¼**: JSON

```json
{
  "id": "notif-alert-xxx-email-1732348800",
  "channel": "webhook",
  "recipient": "https://your-endpoint.com/alerts",
  "subject": "[critical] è®¾å¤‡ç¦»çº¿å‘Šè­¦",
  "content": "å‘Šè­¦è¯¦æƒ…ï¼š\n- å‘Šè­¦ID: alert-xxx\n...",
  "priority": "critical",
  "alert_id": "alert-xxx",
  "metadata": {
    "event_id": 123,
    "device_id": "dev-001",
    "metric_name": "device_status",
    "escalated": false
  },
  "created_at": "2025-11-23T10:00:00Z"
}
```

---

## ğŸ” é€šçŸ¥å»é‡æœºåˆ¶

### å·¥ä½œåŸç†

1. **ç¼“å­˜ç»“æ„**:
   ```go
   dedupeCache map[string]time.Time  // alertID -> lastNotifyTime
   ```

2. **å»é‡æ£€æŸ¥**:
   ```go
   func (s *service) ShouldNotify(alertID string, ruleID uint) (bool, error) {
       lastNotifyTime, exists := s.dedupeCache[alertID]
       if !exists {
           return true, nil  // é¦–æ¬¡é€šçŸ¥
       }
       
       elapsed := time.Since(lastNotifyTime).Seconds()
       return elapsed >= float64(dedupeInterval), nil
   }
   ```

3. **æ›´æ–°ç¼“å­˜**:
   ```go
   func (s *service) updateDedupeCache(alertID string) {
       s.dedupeCache[alertID] = time.Now()
   }
   ```

### é…ç½®ç¤ºä¾‹

```json
{
  "notification_config": {
    "dedupe_interval": 300  // 5 åˆ†é’Ÿå†…ç›¸åŒå‘Šè­¦åªé€šçŸ¥ä¸€æ¬¡
  }
}
```

---

## ğŸ“ˆ é€šçŸ¥å‡çº§æœºåˆ¶

### å·¥ä½œåŸç†

1. **ç¼“å­˜ç»“æ„**:
   ```go
   escalationCache map[string]time.Time  // alertID -> firstNotifyTime
   ```

2. **å‡çº§æ£€æŸ¥**:
   ```go
   func (s *service) shouldEscalate(alertID string, config *NotificationConfig) bool {
       if !config.EscalationEnabled {
           return false
       }
       
       firstNotifyTime, exists := s.escalationCache[alertID]
       if !exists {
           return false
       }
       
       elapsed := time.Since(firstNotifyTime).Seconds()
       return elapsed >= float64(config.EscalationAfter)
   }
   ```

3. **å‡çº§æµç¨‹**:
   ```
   å‘Šè­¦è§¦å‘
   â”œâ”€> é¦–æ¬¡é€šçŸ¥ï¼šä½¿ç”¨æ™®é€šæ¸ é“
   â”œâ”€> è®°å½•é¦–æ¬¡é€šçŸ¥æ—¶é—´
   â”œâ”€> 30 åˆ†é’Ÿåï¼ˆå¯é…ç½®ï¼‰
   â”œâ”€> å‘Šè­¦ä»æœªè§£å†³
   â””â”€> å‡çº§é€šçŸ¥ï¼šä½¿ç”¨å‡çº§æ¸ é“ï¼ˆå¦‚ï¼šçŸ­ä¿¡ã€ç”µè¯ï¼‰
   ```

### é…ç½®ç¤ºä¾‹

```json
{
  "notification_config": {
    "escalation_enabled": true,
    "escalation_after": 1800,  // 30 åˆ†é’Ÿåå‡çº§
    "channels": [
      {"channel": "email", "enabled": true, "recipients": ["ops@example.com"]},
      {"channel": "dingtalk", "enabled": true, "recipients": ["webhook_url"]}
    ],
    "escalation_channels": ["email", "dingtalk", "wechat", "sms"]
  }
}
```

---

## ğŸ“ æ•°æ®åº“è®°å½•

### alert_notifications è¡¨

æ‰€æœ‰é€šçŸ¥å‘é€è®°å½•éƒ½ä¼šä¿å­˜åˆ°æ•°æ®åº“ï¼š

```sql
CREATE TABLE alert_notifications (
    id              SERIAL PRIMARY KEY,
    alert_event_id  INTEGER NOT NULL,
    channel         VARCHAR(64),
    recipient       VARCHAR(255),
    status          VARCHAR(32),  -- pending, sending, sent, failed
    sent_at         TIMESTAMP,
    error_message   TEXT,
    created_at      TIMESTAMP DEFAULT NOW(),
    
    FOREIGN KEY (alert_event_id) REFERENCES alert_events(id) ON DELETE CASCADE
);
```

### æŸ¥è¯¢é€šçŸ¥å†å²

```sql
-- æŸ¥è¯¢æŸä¸ªå‘Šè­¦äº‹ä»¶çš„æ‰€æœ‰é€šçŸ¥è®°å½•
SELECT * FROM alert_notifications 
WHERE alert_event_id = 123 
ORDER BY created_at DESC;

-- ç»Ÿè®¡é€šçŸ¥æˆåŠŸç‡
SELECT 
    channel,
    COUNT(*) as total,
    SUM(CASE WHEN status = 'sent' THEN 1 ELSE 0 END) as success,
    ROUND(100.0 * SUM(CASE WHEN status = 'sent' THEN 1 ELSE 0 END) / COUNT(*), 2) as success_rate
FROM alert_notifications
GROUP BY channel;
```

---

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
cd gravital-core
go test ./internal/notification/... -v
```

### é›†æˆæµ‹è¯•

```bash
# æµ‹è¯•é‚®ä»¶é€šçŸ¥
curl -X POST http://localhost:8080/api/v1/notifications/test \
  -H "Content-Type: application/json" \
  -d '{
    "channel": "email",
    "recipient": "test@example.com",
    "subject": "æµ‹è¯•é€šçŸ¥",
    "content": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥"
  }'

# æµ‹è¯•é’‰é’‰é€šçŸ¥
curl -X POST http://localhost:8080/api/v1/notifications/test \
  -H "Content-Type: application/json" \
  -d '{
    "channel": "dingtalk",
    "recipient": "webhook_url",
    "subject": "æµ‹è¯•é€šçŸ¥",
    "content": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥"
  }'
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### 1. é€šçŸ¥æœªå‘é€

**æ£€æŸ¥æ¸…å•**:
- [ ] é€šçŸ¥é…ç½®æ˜¯å¦å¯ç”¨ (`enabled: true`)
- [ ] é€šçŸ¥æ¸ é“æ˜¯å¦æ³¨å†Œ
- [ ] æ¥æ”¶äººåˆ—è¡¨æ˜¯å¦æ­£ç¡®
- [ ] æ˜¯å¦è¢«å»é‡æœºåˆ¶è¿‡æ»¤

**æŸ¥çœ‹æ—¥å¿—**:
```bash
docker-compose logs -f gravital-core | grep -i notification
```

### 2. é‚®ä»¶å‘é€å¤±è´¥

**å¸¸è§é—®é¢˜**:
- SMTP æœåŠ¡å™¨åœ°å€æˆ–ç«¯å£é”™è¯¯
- è®¤è¯ä¿¡æ¯é”™è¯¯
- TLS é…ç½®é”™è¯¯
- é˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æµ‹è¯• SMTP è¿æ¥
telnet smtp.example.com 587

# æ£€æŸ¥é…ç½®
grep -A 10 "email:" config/config.yaml
```

### 3. é’‰é’‰é€šçŸ¥å¤±è´¥

**å¸¸è§é—®é¢˜**:
- Webhook URL é”™è¯¯
- ç­¾åéªŒè¯å¤±è´¥
- IP ç™½åå•é™åˆ¶

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æµ‹è¯• Webhook
curl -X POST "https://oapi.dingtalk.com/robot/send?access_token=xxx" \
  -H "Content-Type: application/json" \
  -d '{"msgtype":"text","text":{"content":"test"}}'
```

---

## ğŸ“š æœ€ä½³å®è·µ

### 1. é€šçŸ¥æ¸ é“é€‰æ‹©

- **critical çº§åˆ«**: é‚®ä»¶ + é’‰é’‰ + çŸ­ä¿¡
- **warning çº§åˆ«**: é‚®ä»¶ + é’‰é’‰
- **info çº§åˆ«**: é’‰é’‰

### 2. å»é‡é—´éš”è®¾ç½®

- **é¢‘ç¹æ³¢åŠ¨çš„æŒ‡æ ‡**: 10-15 åˆ†é’Ÿ
- **ç¨³å®šçš„æŒ‡æ ‡**: 5 åˆ†é’Ÿ
- **å…³é”®å‘Šè­¦**: 1 åˆ†é’Ÿ

### 3. å‡çº§æ—¶é—´è®¾ç½®

- **critical çº§åˆ«**: 15-30 åˆ†é’Ÿ
- **warning çº§åˆ«**: 30-60 åˆ†é’Ÿ
- **info çº§åˆ«**: ä¸å¯ç”¨å‡çº§

### 4. æ¥æ”¶äººé…ç½®

- è®¾ç½®å¤šä¸ªæ¥æ”¶äººï¼Œé¿å…å•ç‚¹æ•…éšœ
- ä½¿ç”¨åˆ†ç»„é‚®ç®±ï¼ˆå¦‚ ops@example.comï¼‰
- å®šæœŸæ›´æ–°æ¥æ”¶äººåˆ—è¡¨

---

## ğŸš€ æœªæ¥å¢å¼º

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

- [ ] çŸ­ä¿¡é€šçŸ¥æ¸ é“
- [ ] Slack é€šçŸ¥æ¸ é“
- [ ] Telegram é€šçŸ¥æ¸ é“
- [ ] é€šçŸ¥æ¨¡æ¿è‡ªå®šä¹‰

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰

- [ ] é€šçŸ¥é™é»˜æ—¶æ®µ
- [ ] é€šçŸ¥ä¼˜å…ˆçº§è·¯ç”±
- [ ] é€šçŸ¥ç»Ÿè®¡æŠ¥è¡¨
- [ ] é€šçŸ¥å¤±è´¥é‡è¯•

### é•¿æœŸï¼ˆ3-6 æœˆï¼‰

- [ ] æ™ºèƒ½é€šçŸ¥ï¼ˆåŸºäº AI çš„é€šçŸ¥ä¼˜åŒ–ï¼‰
- [ ] é€šçŸ¥èšåˆï¼ˆå¤šä¸ªå‘Šè­¦åˆå¹¶ä¸ºä¸€æ¡é€šçŸ¥ï¼‰
- [ ] é€šçŸ¥ç¡®è®¤æœºåˆ¶
- [ ] é€šçŸ¥å®¡è®¡æ—¥å¿—

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-23
**ç»´æŠ¤è€…**: Celestial Team

