# 告警通知功能使用指南

## 📖 快速开始

本指南将帮助您快速上手告警通知功能，让您能够在设备出现问题时及时收到通知。

---

## 🎯 功能概述

告警通知功能允许您在创建告警规则时配置多种通知方式，包括：
- 📧 **邮件通知**：发送到指定邮箱
- 🔗 **Webhook**：调用自定义 API
- 💬 **钉钉机器人**：发送到钉钉群
- 💼 **企业微信**：发送到企业微信群

同时支持：
- ⏱️ **智能去重**：避免短时间内重复通知
- 📈 **通知升级**：重要告警持续时自动升级通知

---

## 📝 使用步骤

### 步骤 1：创建告警规则

1. 登录系统，进入"告警管理"页面
2. 点击"告警规则"标签
3. 点击"创建规则"按钮

### 步骤 2：填写基本信息

```
规则名称：设备离线告警
描述：监控设备在线状态
级别：Warning
指标名称：device_status
条件：!= 1
持续时间：5 分钟
```

### 步骤 3：配置通知

#### 3.1 启用通知

在"通知配置"部分，打开"启用通知"开关。

#### 3.2 设置去重间隔

```
去重间隔：300 秒（5分钟）
```

这意味着相同的告警在 5 分钟内只会通知一次。

#### 3.3 添加通知渠道

**添加邮件通知：**

1. 点击"添加渠道"按钮
2. 选择"邮件"
3. 输入接收人邮箱：
   - `admin@example.com`
   - `ops@example.com`
4. 确保渠道开关为"启用"状态

**添加钉钉通知：**

1. 点击"添加渠道"按钮
2. 选择"钉钉"
3. 输入钉钉机器人 Webhook URL：
   ```
   https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN
   ```

#### 3.4 配置升级策略（可选）

如果希望重要告警持续时自动升级：

1. 打开"启用升级"开关
2. 设置升级时间：`1800` 秒（30分钟）
3. 选择升级渠道：
   - ✅ 邮件
   - ✅ 钉钉
   - ✅ 短信

这意味着如果告警持续 30 分钟未解决，将通过所有选中的渠道再次发送通知。

### 步骤 4：保存规则

点击"确定"按钮保存规则。

---

## 📊 查看通知状态

### 在规则列表中查看

规则列表中会显示每个规则的通知状态：
- 🟢 **已启用**：该规则已配置通知
- ⚪ **未启用**：该规则未配置通知

### 查看通知历史（即将推出）

在告警事件详情中，可以查看该事件的所有通知发送记录：
- 发送渠道
- 接收人
- 发送状态（成功/失败）
- 发送时间
- 错误信息（如果失败）

---

## 💡 使用技巧

### 1. 合理设置去重间隔

- **频繁波动的指标**：设置较长的去重间隔（如 10-30 分钟）
- **关键业务指标**：设置较短的去重间隔（如 5 分钟）

### 2. 多渠道组合

建议为重要告警配置多个通知渠道：

```
普通告警：邮件
重要告警：邮件 + 钉钉
紧急告警：邮件 + 钉钉 + 企业微信 + 启用升级
```

### 3. 使用升级策略

对于可能影响业务的告警，建议启用升级策略：

```
初始通知：邮件（运维团队）
升级通知：邮件 + 钉钉 + 短信（管理层）
```

### 4. 接收人管理

- 为不同级别的告警配置不同的接收人
- 使用邮件列表或群组，方便统一管理

---

## 🔧 配置示例

### 示例 1：简单邮件通知

```yaml
启用通知: 是
去重间隔: 300 秒

通知渠道:
  - 类型: 邮件
    接收人:
      - ops@example.com
```

### 示例 2：多渠道通知

```yaml
启用通知: 是
去重间隔: 300 秒

通知渠道:
  - 类型: 邮件
    接收人:
      - admin@example.com
      - ops@example.com
  
  - 类型: 钉钉
    接收人:
      - https://oapi.dingtalk.com/robot/send?access_token=xxx
```

### 示例 3：带升级的通知

```yaml
启用通知: 是
去重间隔: 300 秒

通知渠道:
  - 类型: 邮件
    接收人:
      - ops@example.com

启用升级: 是
升级时间: 1800 秒
升级渠道:
  - 邮件
  - 钉钉
  - 短信
```

---

## 🎨 界面说明

### 通知配置界面

```
┌─────────────────────────────────────────┐
│ ─────────────── 通知配置 ───────────────│
│                                         │
│ 启用通知: [●] ← 总开关                  │
│                                         │
│ 去重间隔: [300] 秒 ← 防止重复通知       │
│                                         │
│ 通知渠道: [+ 添加渠道] ← 点击添加渠道   │
│                                         │
│ ┌───────────────────────────────┐      │
│ │ [邮件 ▼]  [●]  [删除] ← 渠道控制│      │
│ ├───────────────────────────────┤      │
│ │ 接收人: ← 输入接收人           │      │
│ │ [admin@example.com]            │      │
│ │ [ops@example.com]              │      │
│ └───────────────────────────────┘      │
│                                         │
│ 启用升级: [○] ← 升级开关                │
└─────────────────────────────────────────┘
```

---

## ❓ 常见问题

### Q1: 为什么没有收到通知？

**检查清单：**
1. ✅ 告警规则是否启用？
2. ✅ 通知配置是否启用？
3. ✅ 通知渠道是否启用？
4. ✅ 接收人配置是否正确？
5. ✅ 是否在去重间隔内？
6. ✅ 后端服务是否正常运行？

### Q2: 如何避免通知轰炸？

**建议：**
- 设置合理的去重间隔（建议 5-10 分钟）
- 使用告警聚合功能
- 为不同级别的告警设置不同的通知策略

### Q3: 钉钉/企业微信机器人如何配置？

**钉钉机器人：**
1. 在钉钉群中添加自定义机器人
2. 获取 Webhook URL
3. 复制 URL 到接收人字段

**企业微信机器人：**
1. 在企业微信群中添加机器人
2. 获取 Webhook URL
3. 复制 URL 到接收人字段

### Q4: 升级通知何时触发？

升级通知在以下情况触发：
- 告警持续时间超过设置的"升级时间"
- 告警状态仍为"告警中"（未确认或解决）
- 升级渠道已配置

### Q5: 可以修改已有规则的通知配置吗？

可以！在规则列表中点击"编辑"，即可修改通知配置。

---

## 📞 获取帮助

如果您在使用过程中遇到问题：

1. 查看 [完整技术文档](./gravital-core/docs/ALERT_NOTIFICATION.md)
2. 查看 [实施总结](./FRONTEND_NOTIFICATION_IMPLEMENTATION.md)
3. 联系系统管理员

---

## 🎉 最佳实践

### 1. 分级通知策略

```
Info 级别：
  - 仅邮件通知
  - 去重间隔：30 分钟
  - 不启用升级

Warning 级别：
  - 邮件 + 钉钉
  - 去重间隔：10 分钟
  - 启用升级（30 分钟）

Critical 级别：
  - 邮件 + 钉钉 + 企业微信
  - 去重间隔：5 分钟
  - 启用升级（15 分钟）+ 短信
```

### 2. 值班轮换

为不同时间段配置不同的接收人：
- 工作日：运维团队邮箱
- 周末/节假日：值班人员手机

### 3. 通知内容优化

确保通知包含关键信息：
- 告警级别
- 设备信息
- 当前值 vs 阈值
- 触发时间
- 处理建议

---

**版本**: v1.0  
**最后更新**: 2025-11-23  
**适用范围**: Celestial 监控系统

